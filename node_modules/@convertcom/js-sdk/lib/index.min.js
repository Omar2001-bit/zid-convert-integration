/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";function e(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{l(r.next(e))}catch(e){a(e)}}function s(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}l((r=r.apply(e,t||[])).next())}))}var t;Object.defineProperty(exports,"__esModule",{value:!0}),"function"==typeof SuppressedError&&SuppressedError,exports.BucketingError=void 0,(exports.BucketingError||(exports.BucketingError={})).VARIAION_NOT_DECIDED="convert.com_variation_not_decided",function(e){e.FORCE_MULTIPLE_TRANSACTIONS="forceMultipleTransactions"}(t||(t={}));const i=["events","goals","audiences","locations","segments","experiences","archived_experiences","experiences.variations","features","features.variables"],r={goal:"goals",audience:"audiences",location:"locations",segment:"segments",experience:"experiences",variation:"experiences.variations",feature:"features"},n={SDK_KEY_MISSING:"SDK key is missing",DATA_OBJECT_MISSING:"Data object is missing",CONFIG_DATA_NOT_VALID:"Config Data is not valid",SDK_OR_DATA_OBJECT_REQUIRED:"SDK key or Data object should be provided",RULE_NOT_VALID:"Provided rule is not valid",RULE_DATA_NOT_VALID:"Provided rule data is not valid",RULE_MATCH_TYPE_NOT_SUPPORTED:'Provided rule matching type "#" is not supported',RULE_ERROR:"Rule error",DATA_STORE_NOT_VALID:"DataStore object is not valid. It should contain get and set methods",VISITOR_ID_REQUIRED:"Visitor string string is not present",GOAL_DATA_NOT_VALID:"GoalData object is not valid",UNABLE_TO_SELECT_BUCKET_FOR_VISITOR:"Unable to bucket visitor",UNABLE_TO_PERFORM_NETWORK_REQUEST:"Unable to perform network request",UNSUPPORTED_RESPONSE_TYPE:"Unsupported response type"},a={CONFIG_DATA_UPDATED:"Config Data updated",CORE_CONSTRUCTOR:"Core Manager constructor has been called",CORE_INITIALIZED:"Core Manager has been initialized",EXPERIENCE_CONSTRUCTOR:"Experience Manager constructor has been called",EXPERIENCE_NOT_FOUND:"Experience not found",EXPERIENCE_ARCHIVED:"Experience archived",EXPERIENCE_ENVIRONMENT_NOT_MATCH:"Experience environment does not match",EXPERIENCE_RULES_MATCHED:"Experience rules matched",VARIATIONS_NOT_FOUND:"Variations not found",VARIATION_CHANGE_NOT_SUPPORTED:"Variation change not supported",FEATURE_CONSTRUCTOR:"Feature Manager constructor has been called",FEATURE_NOT_FOUND:"Fullstack Feature not found",FEATURE_VARIABLES_NOT_FOUND:"Fullstack Feature Variables not found",FEATURE_VARIABLES_TYPE_NOT_FOUND:"Fullstack Feature Variables Type not found",BUCKETING_CONSTRUCTOR:"Bucketing Manager constructor has been called",DATA_CONSTRUCTOR:"Data Manager constructor has been called",RULE_CONSTRUCTOR:"Rule Manager constructor has been called",PROCESSING_ENTITY:"Processing #",LOCATION_MATCH:"Location # rule matched",LOCATION_NOT_MATCH:"Location does not match",LOCATION_NOT_RESTRICTED:"Location not restricted",AUDIENCE_MATCH:"Audience # rule matched",AUDIENCE_NOT_MATCH:"Audience does not match",NON_PERMANENT_AUDIENCE_NOT_RESTRICTED:"Non-Permanent Audience not restricted",AUDIENCE_NOT_RESTRICTED:"Audience not restricted",SEGMENTATION_MATCH:"Segmentation # rule matched",SEGMENTATION_NOT_RESTRICTED:"Segmentation not restricted",RULE_NOT_MATCH:"Rule does not match",RULE_MATCH:"Found matched rule at OR block #",RULE_MATCH_AND:"AND block rule macthed",RULE_MATCH_START:"About to evaluate rule #",LOCATION_ACTIVATED:"Location # activated",LOCATION_DEACTIVATED:"Location # deactivated",BUCKETED_VISITOR_FOUND:"Visitor is already bucketed for variation #",BUCKETED_VISITOR_FORCED:"Forcing variation #",BUCKETED_VISITOR:"Visitor is bucketed for variation #",GOAL_NOT_FOUND:"Goal not found",GOAL_RULE_NOT_MATCH:"Goal rule do not match",GOAL_FOUND:"Goal # already triggered",SEGMENTS_NOT_FOUND:"Segments not found",SEGMENTS_RULE_NOT_MATCH:"Segments rule do not match",CUSTOM_SEGMENTS_KEY_FOUND:"Custom segments key already set",SEND_BEACON_SUCCESS:"The user agent successfully queued the data for transfer",RELEASING_QUEUE:"Releasing event queue..."};var o,s,l,u,d,c,g,v,h,_,p,E,f,M,y;function O(e){return Array.isArray(e)&&e.length>0}function m(e,t,i,r=!1){try{if("object"==typeof e){const i=t.split(".").reduce(((e,t)=>e[t]),e);if(i||r&&(!1===i||0===i))return i}}catch(e){}return null}function R(...e){const t=e=>e&&"object"==typeof e;return e.reduce(((e,i)=>(Object.keys(i).forEach((r=>{const n=e[r],a=i[r];Array.isArray(n)&&Array.isArray(a)?e[r]=[...new Set([...a,...n])]:t(n)&&t(a)?e[r]=R(n,a):e[r]=a})),e)),{})}function T(e){return"object"==typeof e&&null!==e&&Object.keys(e).length>0}!function(e){e.OFF="OFF",e.EU_ONLY="EU ONLY",e.EEA_ONLY="EEA ONLY",e.WORLDWIDE="Worldwide"}(o||(o={})),exports.EntityType=void 0,(s=exports.EntityType||(exports.EntityType={})).AUDIENCE="audience",s.LOCATION="location",s.SEGMENT="segment",s.FEATURE="feature",s.GOAL="goal",s.EXPERIENCE="experience",s.VARIATION="variation",function(e){e.ENABLED="enabled",e.DISABLED="disabled"}(l||(l={})),exports.GoalDataKey=void 0,(u=exports.GoalDataKey||(exports.GoalDataKey={})).AMOUNT="amount",u.PRODUCTS_COUNT="productsCount",u.TRANSACTION_ID="transactionId",exports.LogLevel=void 0,(d=exports.LogLevel||(exports.LogLevel={}))[d.TRACE=0]="TRACE",d[d.DEBUG=1]="DEBUG",d[d.INFO=2]="INFO",d[d.WARN=3]="WARN",d[d.ERROR=4]="ERROR",d[d.SILENT=5]="SILENT",function(e){e.LOG="log",e.TRACE="trace",e.DEBUG="debug",e.INFO="info",e.WARN="warn",e.ERROR="error"}(c||(c={})),function(e){e.WEB="web",e.FULLSTACK="fullstack"}(g||(g={})),exports.RuleError=void 0,(v=exports.RuleError||(exports.RuleError={})).NO_DATA_FOUND="convert.com_no_data_found",v.NEED_MORE_DATA="convert.com_need_more_data",exports.SystemEvents=void 0,(h=exports.SystemEvents||(exports.SystemEvents={})).READY="ready",h.CONFIG_UPDATED="config.updated",h.API_QUEUE_RELEASED="api.queue.released",h.BUCKETING="bucketing",h.CONVERSION="conversion",h.SEGMENTS="segments",h.LOCATION_ACTIVATED="location.activated",h.LOCATION_DEACTIVATED="location.deactivated",h.AUDIENCES="audiences",h.DATA_STORE_QUEUE_RELEASED="datastore.queue.released",exports.VariationChangeType=void 0,(_=exports.VariationChangeType||(exports.VariationChangeType={})).RICH_STRUCTURE="richStructure",_.CUSTOM_CODE="customCode",_.DEFAULT_CODE="defaultCode",_.DEFAULT_CODE_MULTIPAGE="defaultCodeMultipage",_.DEFAULT_REDIRECT="defaultRedirect",_.FULLSTACK_FEATURE="fullStackFeature",function(e){e.IE="IE",e.CH="CH",e.FF="FF",e.OP="OP",e.SF="SF",e.EDG="EDG",e.MO="MO",e.NS="NS",e.OTH="OTH"}(p||(p={})),function(e){e.ALLPH="ALLPH",e.IPH="IPH",e.OTHPH="OTHPH",e.ALLTAB="ALLTAB",e.IPAD="IPAD",e.OTHTAB="OTHTAB",e.DESK="DESK",e.OTHDEV="OTHDEV"}(E||(E={})),function(e){e.COUNTRY="country",e.BROWSER="browser",e.DEVICES="devices",e.SOURCE="source",e.CAMPAIGN="campaign",e.VISITOR_TYPE="visitorType",e.CUSTOM_SEGMENTS="customSegments"}(f||(f={})),function(e){e.CAMPAIGN="campaign",e.SEARCH="search",e.REFERRAL="referral",e.DIRECT="direct"}(M||(M={})),function(e){e.NEW="new",e.RETURNING="returning"}(y||(y={}));const I=(e,t)=>{if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||null==e||null==t)return!1;const i=Object.keys(e),r=Object.keys(t);if(i.length!=r.length)return!1;for(const n of i){if(!r.includes(n))return!1;if("function"==typeof e[n]||"function"==typeof t[n]){if(e[n].toString()!=t[n].toString())return!1}else if(!I(e[n],t[n]))return!1}return!0};function S(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var N,C={exports:{}};N=C,function(){const e=e=>(new TextEncoder).encode(e);function t(t,i){let r,n,a,o,s,l,u,d;for("string"==typeof t&&(t=e(t)),r=3&t.length,n=t.length-r,a=i,s=3432918353,l=461845907,d=0;d<n;)u=255&t[d]|(255&t[++d])<<8|(255&t[++d])<<16|(255&t[++d])<<24,++d,u=(65535&u)*s+(((u>>>16)*s&65535)<<16)&4294967295,u=u<<15|u>>>17,u=(65535&u)*l+(((u>>>16)*l&65535)<<16)&4294967295,a^=u,a=a<<13|a>>>19,o=5*(65535&a)+((5*(a>>>16)&65535)<<16)&4294967295,a=27492+(65535&o)+((58964+(o>>>16)&65535)<<16);switch(u=0,r){case 3:u^=(255&t[d+2])<<16;case 2:u^=(255&t[d+1])<<8;case 1:u^=255&t[d],u=(65535&u)*s+(((u>>>16)*s&65535)<<16)&4294967295,u=u<<15|u>>>17,u=(65535&u)*l+(((u>>>16)*l&65535)<<16)&4294967295,a^=u}return a^=t.length,a^=a>>>16,a=2246822507*(65535&a)+((2246822507*(a>>>16)&65535)<<16)&4294967295,a^=a>>>13,a=3266489909*(65535&a)+((3266489909*(a>>>16)&65535)<<16)&4294967295,a^=a>>>16,a>>>0}const i=t;i.v2=function(t,i){"string"==typeof t&&(t=e(t));let r,n=t.length,a=i^n,o=0;for(;n>=4;)r=255&t[o]|(255&t[++o])<<8|(255&t[++o])<<16|(255&t[++o])<<24,r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16),r^=r>>>24,r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16),a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16)^r,n-=4,++o;switch(n){case 3:a^=(255&t[o+2])<<16;case 2:a^=(255&t[o+1])<<8;case 1:a^=255&t[o],a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16)}return a^=a>>>13,a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),a^=a>>>15,a>>>0},i.v3=t,N.exports=i}();var A,D,L=S(C.exports);function b(e){return e.replace(/(?:^\w|[A-Z]|\b\w)/g,(function(e,t){return 0===t?e.toLowerCase():e.toUpperCase()})).replace(/\s+/g,"")}function k(e){if("number"==typeof e)return!0;const t=parseFloat(String(e));return Number.isFinite(t)&&!isNaN(t)}function U(e){if("number"==typeof e)return e;const t=String(e).split(",");return parseFloat("0"==t[0]?String(e).replace(/,/g,"."):String(e).replace(/,/g,""))}class x{static equals(e,t,i){return Array.isArray(e)?this._returnNegationCheck(-1!==e.indexOf(t),i):T(e)?this._returnNegationCheck(-1!==Object.keys(e).indexOf(String(t)),i):(e=String(e),t=String(t),e=e.valueOf().toLowerCase(),t=t.valueOf().toLowerCase(),this._returnNegationCheck(e===t,i))}static less(e,t,i){return typeof(e=k(e)?U(e):e)==typeof(t=k(t)?U(t):t)&&this._returnNegationCheck(e<t,i)}static lessEqual(e,t,i){return typeof(e=k(e)?U(e):e)==typeof(t=k(t)?U(t):t)&&this._returnNegationCheck(e<=t,i)}static contains(e,t,i){return e=String(e),t=String(t),e=e.valueOf().toLowerCase(),0===(t=t.valueOf().toLowerCase()).replace(/^([\s]*)|([\s]*)$/g,"").length?this._returnNegationCheck(!0,i):this._returnNegationCheck(-1!==e.indexOf(t),i)}static isIn(e,t,i=!1,r="|"){const n=String(e).split(r).map((e=>String(e)));"string"==typeof t&&(t=t.split(r)),Array.isArray(t)||(t=[]),t=t.map((e=>String(e).valueOf().toLowerCase()));for(let e=0;e<n.length;e++)if(-1!==t.indexOf(n[e]))return this._returnNegationCheck(!0,i);return this._returnNegationCheck(!1,i)}static startsWith(e,t,i){return e=String(e).valueOf().toLowerCase(),t=String(t).valueOf().toLowerCase(),this._returnNegationCheck(0===e.indexOf(t),i)}static endsWith(e,t,i){return e=String(e).valueOf().toLowerCase(),t=String(t).valueOf().toLowerCase(),this._returnNegationCheck(-1!==e.indexOf(t,e.length-t.length),i)}static regexMatches(e,t,i){e=String(e).valueOf().toLowerCase(),t=String(t).valueOf();const r=new RegExp(t,"i");return this._returnNegationCheck(r.test(e),i)}static _returnNegationCheck(e,t=!1){return t?!e:e}}A=x,x.equalsNumber=A.equals,x.matches=A.equals;!function(e){e[e.Continue=100]="Continue",e[e.SwitchingProtocols=101]="SwitchingProtocols",e[e.Processing=102]="Processing",e[e.EarlyHints=103]="EarlyHints",e[e.Ok=200]="Ok",e[e.Created=201]="Created",e[e.Accepted=202]="Accepted",e[e.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",e[e.NoContent=204]="NoContent",e[e.ResetContent=205]="ResetContent",e[e.PartialContent=206]="PartialContent",e[e.MultiStatus=207]="MultiStatus",e[e.AlreadyReported=208]="AlreadyReported",e[e.ImUsed=226]="ImUsed",e[e.MultipleChoices=300]="MultipleChoices",e[e.MovedPermanently=301]="MovedPermanently",e[e.Found=302]="Found",e[e.SeeOther=303]="SeeOther",e[e.NotModified=304]="NotModified",e[e.UseProxy=305]="UseProxy",e[e.Unused=306]="Unused",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.PermanentRedirect=308]="PermanentRedirect",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.PaymentRequired=402]="PaymentRequired",e[e.Forbidden=403]="Forbidden",e[e.NotFound=404]="NotFound",e[e.MethodNotAllowed=405]="MethodNotAllowed",e[e.NotAcceptable=406]="NotAcceptable",e[e.ProxyAuthenticationRequired=407]="ProxyAuthenticationRequired",e[e.RequestTimeout=408]="RequestTimeout",e[e.Conflict=409]="Conflict",e[e.Gone=410]="Gone",e[e.LengthRequired=411]="LengthRequired",e[e.PreconditionFailed=412]="PreconditionFailed",e[e.PayloadTooLarge=413]="PayloadTooLarge",e[e.UriTooLong=414]="UriTooLong",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.RangeNotSatisfiable=416]="RangeNotSatisfiable",e[e.ExpectationFailed=417]="ExpectationFailed",e[e.ImATeapot=418]="ImATeapot",e[e.MisdirectedRequest=421]="MisdirectedRequest",e[e.UnprocessableEntity=422]="UnprocessableEntity",e[e.Locked=423]="Locked",e[e.FailedDependency=424]="FailedDependency",e[e.TooEarly=425]="TooEarly",e[e.UpgradeRequired=426]="UpgradeRequired",e[e.PreconditionRequired=428]="PreconditionRequired",e[e.TooManyRequests=429]="TooManyRequests",e[e.RequestHeaderFieldsTooLarge=431]="RequestHeaderFieldsTooLarge",e[e.UnavailableForLegalReasons=451]="UnavailableForLegalReasons",e[e.InternalServerError=500]="InternalServerError",e[e.NotImplemented=501]="NotImplemented",e[e.BadGateway=502]="BadGateway",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.HttpVersionNotSupported=505]="HttpVersionNotSupported",e[e.VariantAlsoNegotiates=506]="VariantAlsoNegotiates",e[e.InsufficientStorage=507]="InsufficientStorage",e[e.LoopDetected=508]="LoopDetected",e[e.NotExtended=510]="NotExtended",e[e.NetworkAuthenticationRequired=511]="NetworkAuthenticationRequired"}(D||(D={}));const P=e=>!["GET","HEAD","DELETE","TRACE","OPTIONS"].includes(e.toUpperCase()),F=(e,t,i)=>{let r="";return T(e)&&!P(t)&&(r="old-nodejs"!==i.runtime?Object.keys(e).map((t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`)).join("&"):i.queryString.stringify(e)),r?`?${r}`:r},B={request(t){var i;const r=(null===(i=null==t?void 0:t.method)||void 0===i?void 0:i.toUpperCase())||"GET",o=(null==t?void 0:t.path)?t.path.startsWith("/")?t.path:`/${t.path}`:"",s=t.baseURL.endsWith("/")?t.baseURL.slice(0,-1):t.baseURL,l=(null==t?void 0:t.responseType)||"json",u=(()=>{if("undefined"!=typeof window)return{runtime:"browser"};if("function"==typeof fetch)return{runtime:"server-with-fetch"};try{const e=require("url"),t=require("http");return{runtime:"old-nodejs",url:e,http:t,https:require("https"),queryString:require("querystring")}}catch(e){}return{runtime:"unknown"}})();return new Promise(((i,d)=>{if("browser"===u.runtime||"server-with-fetch"===u.runtime){const c={method:r,keepalive:!0};(null==t?void 0:t.headers)&&(c.headers=t.headers),(null==t?void 0:t.data)&&P(r)&&(c.body=JSON.stringify(t.data));const g=`${s}${o}${F(null==t?void 0:t.data,r,u)}`;"post"===r.toLowerCase()&&"undefined"!=typeof navigator&&(null===navigator||void 0===navigator?void 0:navigator.sendBeacon)?navigator.sendBeacon(g,c.body)?i({data:!0,status:D.Ok,statusText:a.SEND_BEACON_SUCCESS}):d({message:n.UNSUPPORTED_RESPONSE_TYPE}):fetch(g,c).then((t=>e(this,void 0,void 0,(function*(){if(t.status===D.Ok){const e={status:t.status,statusText:t.statusText,headers:t.headers,data:null};switch(l){case"json":e.data=yield t.json();break;case"arraybuffer":e.data=yield t.arrayBuffer();break;case"text":e.data=t;break;default:return void d({message:n.UNSUPPORTED_RESPONSE_TYPE})}i(e)}else d({message:t.statusText,status:t.status})})))).catch((e=>{d({message:null==e?void 0:e.message,status:null==e?void 0:e.status,statusText:null==e?void 0:e.statusText})}))}else if("old-nodejs"===u.runtime){const e=u.url.parse(s);e.port||(e.port="https:"===e.protocol?"443":"80");const a=e.path.endsWith("/")?e.path.slice(0,-1):e.path,c="https:"===e.protocol?u.https:u.http,g=[],v={hostname:e.hostname,path:`${a}${o}${F(null==t?void 0:t.data,r,u)}`,port:e.port,method:r},h=(null==t?void 0:t.data)&&P(r)?JSON.stringify(t.data):null;(null==t?void 0:t.headers)&&(v.headers=t.headers),h&&(v.headers||(v.headers={}),v.headers["Content-Length"]=Buffer.byteLength(h));const _=c.request(v,(e=>{e.on("data",(e=>g.push(e))),e.on("end",(()=>{if(e.statusCode===D.Ok){const t=Buffer.concat(g),r=t.toString(),a={status:e.statusCode,statusText:e.statusMessage,headers:e.headers,data:null};switch(l){case"json":a.data=r?JSON.parse(r):"";break;case"arraybuffer":a.data=null==t?void 0:t.buffer;break;case"text":a.data=e;break;default:return void d({message:n.UNSUPPORTED_RESPONSE_TYPE})}i(a)}else d({message:e.statusMessage,status:e.statusCode})}))}));_.on("error",(e=>{const t=e;d({message:null==t?void 0:t.message,status:null==t?void 0:t.code,statusText:null==t?void 0:t.statusText})})),h&&_.write(h),_.end()}else d({message:n.UNABLE_TO_PERFORM_NETWORK_REQUEST})}))}};const V={"Content-Type":"application/json"},w="https://cdn-4.convertexperiments.com/api/v1/",j="https://[project_id].metrics.convertexperiments.com/v1/";class G{constructor(e,{eventManager:t,loggerManager:i}={}){var r,n,a,o,s,l,u,d,c,g,v,h;this._configEndpoint=w,this._trackEndpoint=j,this._defaultHeaders=V,this.batchSize=10,this.releaseInterval=1e4,this._loggerManager=i,this._eventManager=t,this._configEndpoint=(null===(n=null===(r=null==e?void 0:e.api)||void 0===r?void 0:r.endpoint)||void 0===n?void 0:n.config)||w,this._trackEndpoint=(null===(o=null===(a=null==e?void 0:e.api)||void 0===a?void 0:a.endpoint)||void 0===o?void 0:o.track)||j,this._data=m(e,"data"),this._enrichData=!m(e,"dataStore"),this._environment=null==e?void 0:e.environment,this._mapper=(null==e?void 0:e.mapper)||(e=>e),this.batchSize=Number(null===(s=null==e?void 0:e.events)||void 0===s?void 0:s.batch_size)||10,this.releaseInterval=Number(null===(l=null==e?void 0:e.events)||void 0===l?void 0:l.release_interval)||1e4,this._accountId=null===(u=this._data)||void 0===u?void 0:u.account_id,this._projectId=null===(c=null===(d=this._data)||void 0===d?void 0:d.project)||void 0===c?void 0:c.id,this._sdkKey=(null==e?void 0:e.sdkKey)||`${this._accountId}/${this._projectId}`,(null==e?void 0:e.sdkKeySecret)&&(this._defaultHeaders.Authorization=`Bearer ${null==e?void 0:e.sdkKeySecret}`),this._trackingEvent={enrichData:this._enrichData,accountId:this._accountId,projectId:this._projectId,visitors:[]},this._trackingEnabled=null===(g=null==e?void 0:e.network)||void 0===g?void 0:g.tracking,this._trackingSource=(null===(v=null==e?void 0:e.network)||void 0===v?void 0:v.source)||"js-sdk",this._cacheLevel=null===(h=null==e?void 0:e.network)||void 0===h?void 0:h.cacheLevel,this._requestsQueue={length:0,items:[],push(e,t,i){const r=this.items.findIndex((t=>t.visitorId===e));if(-1!==r)this.items[r].events.push(t);else{const r={visitorId:e,events:[t]};i&&(r.segments=i),this.items.push(r)}this.length++},reset(){this.items=[],this.length=0}}}request(t,i){return e(this,arguments,void 0,(function*(e,t,i={},r={}){const n=Object.assign(Object.assign({},this._defaultHeaders),r),a={method:e,path:t.route,baseURL:t.base,headers:n,data:i,responseType:"json"};return B.request(a)}))}enqueue(e,t,i){var r,n;null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"ApiManager.enqueue()",this._mapper({eventRequest:t})),this._requestsQueue.push(e,t,i),this._trackingEnabled&&(1===this._requestsQueue.length?this.startQueue():this._requestsQueue.length===this.batchSize&&this.releaseQueue("size").then())}releaseQueue(e){var t,i,r,n;if(!this._requestsQueue.length)return;null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.info)||void 0===i||i.call(t,"ApiManager.releaseQueue()",a.RELEASING_QUEUE),null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"ApiManager.releaseQueue()",{reason:e||""}),this.stopQueue();const o=this._trackingEvent;return o.visitors=this._requestsQueue.items.slice(),o.source=this._trackingSource,this.request("post",{base:this._trackEndpoint.replace("[project_id]",this._projectId.toString()),route:`/track/${this._sdkKey}`},this._mapper(o)).then((t=>{var i,r;this._requestsQueue.reset(),null===(r=null===(i=this._eventManager)||void 0===i?void 0:i.fire)||void 0===r||r.call(i,exports.SystemEvents.API_QUEUE_RELEASED,{reason:e,result:t,visitors:o.visitors})})).catch((t=>{var i,r,n,a;null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"ApiManager.releaseQueue()",{error:t.message}),this.startQueue(),null===(a=null===(n=this._eventManager)||void 0===n?void 0:n.fire)||void 0===a||a.call(n,exports.SystemEvents.API_QUEUE_RELEASED,{reason:e},t)}))}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}enableTracking(){this._trackingEnabled=!0,this.releaseQueue("trackingEnabled")}disableTracking(){this._trackingEnabled=!1}setData(e){var t;this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id,this._trackingEvent.accountId=this._accountId,this._trackingEvent.projectId=this._projectId}getConfig(){var e,t;null===(t=null===(e=this._loggerManager)||void 0===e?void 0:e.trace)||void 0===t||t.call(e,"ApiManager.getConfig()");let i="low"===this._cacheLevel||this._environment?"?":"";return this._environment&&(i+=`environment=${this._environment}`),"low"===this._cacheLevel&&(i+="_conv_low_cache=1"),new Promise(((e,t)=>{this.request("get",{base:this._configEndpoint,route:`/config/${this._sdkKey}${i}`}).then((({data:t})=>e(t))).catch(t)}))}}class K{constructor(e,{loggerManager:t}={}){var i,r,n,o;this._max_traffic=1e4,this._hash_seed=9999,this._loggerManager=t,this._max_traffic=(null===(i=null==e?void 0:e.bucketing)||void 0===i?void 0:i.max_traffic)||1e4,this._hash_seed=(null===(r=null==e?void 0:e.bucketing)||void 0===r?void 0:r.hash_seed)||9999,null===(o=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===o||o.call(n,"BucketingManager()",a.BUCKETING_CONSTRUCTOR,this)}selectBucket(e,t,i=0){var r,n;let a=null,o=0;return Object.keys(e).some((r=>(o+=100*e[r]+i,t<o&&(a=r,!0)))),null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.debug)||void 0===n||n.call(r,"BucketingManager.selectBucket()",{buckets:e,value:t,redistribute:i},{variation:a}),a||null}getValueVisitorBased(e,t){var i,r;const{seed:n=this._hash_seed,experienceId:a=""}=t||{},o=function(e,t=9999){return L.v3(String(e),t)}(a+String(e),n),s=o/4294967296*this._max_traffic,l=parseInt(String(s),10);return null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.debug)||void 0===r||r.call(i,"BucketingManager.getValueVisitorBased()",{visitorId:e,seed:n,experienceId:a,val:s,result:l}),l}getBucketForVisitor(e,t,i){const r=this.getValueVisitorBased(t,i),n=this.selectBucket(e,r,null==i?void 0:i.redistribute);return n?{variationId:n,bucketingAllocation:r}:null}}class q{constructor(e,t,{eventManager:i,experienceManager:r,featureManager:n,segmentsManager:a,dataManager:o,apiManager:s,loggerManager:l},u){if(this._environment=null==e?void 0:e.environment,this._visitorId=t,this._config=e,this._eventManager=i,this._experienceManager=r,this._featureManager=n,this._dataManager=o,this._segmentsManager=a,this._apiManager=s,this._loggerManager=l,T(u)){const{properties:e}=this._dataManager.filterReportSegments(u);e&&(this._visitorProperties=e),a.putSegments(t,u)}}runExperience(e,t){var i,r;if(!this._visitorId)return void(null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"Context.runExperience()",n.VISITOR_ID_REQUIRED));const a=this.getVisitorProperties(null==t?void 0:t.visitorProperties),o=this._experienceManager.selectVariation(this._visitorId,e,{visitorProperties:a,locationProperties:null==t?void 0:t.locationProperties,updateVisitorProperties:null==t?void 0:t.updateVisitorProperties,environment:(null==t?void 0:t.environment)||this._environment});return Object.values(exports.RuleError).includes(o)||Object.values(exports.BucketingError).includes(o)||o&&this._eventManager.fire(exports.SystemEvents.BUCKETING,{visitorId:this._visitorId,experienceKey:e,variationKey:o.key},null,!0),o}runExperiences(e){var t,i;if(!this._visitorId)return void(null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.error)||void 0===i||i.call(t,"Context.runExperiences()",n.VISITOR_ID_REQUIRED));const r=this.getVisitorProperties(null==e?void 0:e.visitorProperties),a=this._experienceManager.selectVariations(this._visitorId,{visitorProperties:r,locationProperties:null==e?void 0:e.locationProperties,updateVisitorProperties:null==e?void 0:e.updateVisitorProperties,environment:(null==e?void 0:e.environment)||this._environment}),o=a.filter((e=>Object.values(exports.RuleError).includes(e)));if(o.length)return o;const s=a.filter((e=>Object.values(exports.BucketingError).includes(e)));return s.length?s:(a.forEach((({experienceKey:e,key:t})=>{this._eventManager.fire(exports.SystemEvents.BUCKETING,{visitorId:this._visitorId,experienceKey:e,variationKey:t},null,!0)})),a)}runFeature(e,t){var i,r;if(!this._visitorId)return void(null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"Context.runFeature()",n.VISITOR_ID_REQUIRED));const a=this.getVisitorProperties(null==t?void 0:t.visitorProperties),o=this._featureManager.runFeature(this._visitorId,e,{visitorProperties:a,locationProperties:null==t?void 0:t.locationProperties,updateVisitorProperties:null==t?void 0:t.updateVisitorProperties,typeCasting:!Object.prototype.hasOwnProperty.call(t||{},"typeCasting")||t.typeCasting,environment:(null==t?void 0:t.environment)||this._environment},null==t?void 0:t.experienceKeys);if(Array.isArray(o)){const t=o.filter((e=>Object.values(exports.RuleError).includes(e)));if(t.length)return t;o.forEach((({experienceKey:t,status:i})=>{this._eventManager.fire(exports.SystemEvents.BUCKETING,{visitorId:this._visitorId,experienceKey:t,featureKey:e,status:i},null,!0)}))}else{if(Object.values(exports.RuleError).includes(o))return o;o&&this._eventManager.fire(exports.SystemEvents.BUCKETING,{visitorId:this._visitorId,experienceKey:o.experienceKey,featureKey:e,status:o.status},null,!0)}return o}runFeatures(e){var t,i;if(!this._visitorId)return void(null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.error)||void 0===i||i.call(t,"Context.runFeatures()",n.VISITOR_ID_REQUIRED));const r=this.getVisitorProperties(null==e?void 0:e.visitorProperties),a=this._featureManager.runFeatures(this._visitorId,{visitorProperties:r,locationProperties:null==e?void 0:e.locationProperties,updateVisitorProperties:null==e?void 0:e.updateVisitorProperties,typeCasting:!Object.prototype.hasOwnProperty.call(e||{},"typeCasting")||e.typeCasting,environment:(null==e?void 0:e.environment)||this._environment}),o=a.filter((e=>Object.values(exports.RuleError).includes(e)));return o.length?o:(a.forEach((({experienceKey:e,key:t,status:i})=>{this._eventManager.fire(exports.SystemEvents.BUCKETING,{visitorId:this._visitorId,experienceKey:e,featureKey:t,status:i},null,!0)})),a)}trackConversion(e,t){var i,r,a,o;if(!this._visitorId)return void(null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"Context.trackConversion()",n.VISITOR_ID_REQUIRED));const s=null==t?void 0:t.ruleData,l=null==t?void 0:t.conversionData;if(l&&!Array.isArray(l))return void(null===(o=null===(a=this._loggerManager)||void 0===a?void 0:a.error)||void 0===o||o.call(a,"Context.trackConversion()",n.GOAL_DATA_NOT_VALID));const u=this._segmentsManager.getSegments(this._visitorId),d=this._dataManager.convert(this._visitorId,e,s,l,u,null==t?void 0:t.conversionSetting);if(Object.values(exports.RuleError).includes(d))return d;d&&this._eventManager.fire(exports.SystemEvents.CONVERSION,{visitorId:this._visitorId,goalKey:e},null,!0)}setDefaultSegments(e){this._segmentsManager.putSegments(this._visitorId,e)}setCustomSegments(e,t){return this.runCustomSegments(e,t)}runCustomSegments(e,t){var i,r;if(!this._visitorId)return void(null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"Context.runCustomSegments()",n.VISITOR_ID_REQUIRED));const a=this.getVisitorProperties(null==t?void 0:t.ruleData),o=this._segmentsManager.selectCustomSegments(this._visitorId,e,a);return o||void 0}updateVisitorProperties(e,t){this._dataManager.putData(e,{segments:t})}getConfigEntity(e,t){if(t===exports.EntityType.VARIATION){const t=this._dataManager.getEntitiesList(exports.EntityType.EXPERIENCE);for(const{key:i}of t){const t=this._dataManager.getSubItem("experiences",i,"variations",e,"key","key");if(t)return t}}return this._dataManager.getEntity(e,t)}getConfigEntityById(e,t){if(t===exports.EntityType.VARIATION){const t=this._dataManager.getEntitiesList(exports.EntityType.EXPERIENCE);for(const{id:i}of t){const t=this._dataManager.getSubItem("experiences",i,"variations",e,"id","id");if(t)return t}}return this._dataManager.getEntityById(e,t)}getVisitorData(){return this._dataManager.getData(this._visitorId)||{}}releaseQueues(e){return this._dataManager.dataStoreManager&&this._dataManager.dataStoreManager.releaseQueue(e),this._apiManager.releaseQueue(e)}getVisitorProperties(e){const{segments:t}=this._dataManager.getData(this._visitorId)||{},i=e?R(this._visitorProperties||{},e):this._visitorProperties;return R(t||{},i||{})}}class H{constructor(e,{dataManager:t,eventManager:i,experienceManager:r,featureManager:n,segmentsManager:o,apiManager:s,loggerManager:l}){var u,d;this._initialized=!1,this._environment=null==e?void 0:e.environment,this._dataManager=t,this._eventManager=i,this._experienceManager=r,this._featureManager=n,this._loggerManager=l,this._segmentsManager=o,this._dataManager=t,this._eventManager=i,this._apiManager=s,this._loggerManager=l,null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.trace)||void 0===d||d.call(u,"Core()",a.CORE_CONSTRUCTOR,this),this.initialize(e)}initialize(e){var t,i,r,o,s,l,u;e&&(this._config=e,Object.prototype.hasOwnProperty.call(e,"sdkKey")&&(null===(t=e.sdkKey)||void 0===t?void 0:t.length)?this.fetchConfig():Object.prototype.hasOwnProperty.call(e,"data")?(this.data=e.data,this._dataManager.data=e.data,e.data.error?null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"Core.initialize()",{error:e.data.error}):(this._eventManager.fire(exports.SystemEvents.READY,null,null,!0),null===(s=null===(o=this._loggerManager)||void 0===o?void 0:o.trace)||void 0===s||s.call(o,"Core.initialize()",a.CORE_INITIALIZED),this._initialized=!0)):(null===(u=null===(l=this._loggerManager)||void 0===l?void 0:l.error)||void 0===u||u.call(l,"Core.initialize()",n.SDK_OR_DATA_OBJECT_REQUIRED),this._eventManager.fire(exports.SystemEvents.READY,{},new Error(n.SDK_OR_DATA_OBJECT_REQUIRED),!0)))}createContext(e,t){return this._initialized?new q(this._config,e,{eventManager:this._eventManager,experienceManager:this._experienceManager,featureManager:this._featureManager,segmentsManager:this._segmentsManager,apiManager:this._apiManager,dataManager:this._dataManager,loggerManager:this._loggerManager},t):null}on(e,t){this._eventManager.on(e,t)}onReady(){return e(this,void 0,void 0,(function*(){return yield this._promise,new Promise(((e,t)=>{T(this._dataManager.data)?e():t(new Error(n.DATA_OBJECT_MISSING))}))}))}fetchConfig(){return e(this,void 0,void 0,(function*(){var e,t,i,r,n,o,s,l,u,d,c;this._promise=this._apiManager.getConfig();try{const d=yield this._promise;d.error?(this._dataManager.data=d,null===(t=null===(e=this._loggerManager)||void 0===e?void 0:e.error)||void 0===t||t.call(e,"Core.fetchConfig()",{error:d.error})):(null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"Core.fetchConfig()",{data:d}),this._eventManager.fire(T(this._dataManager.data)?exports.SystemEvents.CONFIG_UPDATED:exports.SystemEvents.READY,null,null,!0),T(this._dataManager.data)?null===(o=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===o||o.call(n,"Core.fetchConfig()",a.CONFIG_DATA_UPDATED):(null===(l=null===(s=this._loggerManager)||void 0===s?void 0:s.trace)||void 0===l||l.call(s,"Core.fetchConfig()",a.CORE_INITIALIZED),this._initialized=!0),this.data=d,this._dataManager.data=d,this._apiManager.setData(d)),this._fetchConfigTimerID&&clearTimeout(this._fetchConfigTimerID),this._fetchConfigTimerID=setTimeout((()=>this.fetchConfig()),(null===(u=this._config)||void 0===u?void 0:u.dataRefreshInterval)||3e5)}catch(e){null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.error)||void 0===c||c.call(d,"Core.fetchConfig()",{error:e.message})}}))}}const Q="permanent",$="all",W="running",z="bucketing",Y="conversion";class J{constructor(e,{dataStore:t,eventManager:i,loggerManager:r}={}){var n,a;this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=r,this._eventManager=i,this.batchSize=Number(null===(n=null==e?void 0:e.events)||void 0===n?void 0:n.batch_size)||1,this.releaseInterval=Number(null===(a=null==e?void 0:e.events)||void 0===a?void 0:a.release_interval)||5e3,this.dataStore=t,this._mapper=(null==e?void 0:e.mapper)||(e=>e),this._requestsQueue={}}set(e,t){var i,r,n,a;try{null===(r=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===r||r.call(i,e,t)}catch(e){null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===a||a.call(n,"DataStoreManager.set()",{error:e.message})}}get(e){var t,i,r,n;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,"DataStoreManager.get()",{error:e.message})}return null}enqueue(e,t){var i,r;null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"DataStoreManager.enqueue()",this._mapper({key:e,data:t}));const n={};n[e]=t,this._requestsQueue=R(this._requestsQueue,n),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()}releaseQueue(e){var t,i,r,n;null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.info)||void 0===i||i.call(t,"DataStoreManager.releaseQueue()",{reason:e||""}),this.stopQueue();for(const e in this._requestsQueue)this.set(e,this._requestsQueue[e]);null===(n=null===(r=this._eventManager)||void 0===r?void 0:r.fire)||void 0===n||n.call(r,exports.SystemEvents.DATA_STORE_QUEUE_RELEASED,{reason:e||""})}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}set dataStore(e){var t,i;e&&(this.isValidDataStore(e)?this._dataStore=e:null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.error)||void 0===i||i.call(t,"DataStoreManager.dataStore.set()",n.DATA_STORE_NOT_VALID))}get dataStore(){return this._dataStore}isValidDataStore(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set}}class X{constructor(e,{bucketingManager:t,ruleManager:r,eventManager:n,apiManager:o,loggerManager:s},{asyncStorage:l=!0}={}){var u,d,c,g,v;this._dataEntities=i,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==e?void 0:e.environment,this._apiManager=o,this._bucketingManager=t,this._ruleManager=r,this._loggerManager=s,this._eventManager=n,this._config=e,this._mapper=(null==e?void 0:e.mapper)||(e=>e),this._asyncStorage=l,this._data=m(e,"data"),this._accountId=null===(u=this._data)||void 0===u?void 0:u.account_id,this._projectId=null===(c=null===(d=this._data)||void 0===d?void 0:d.project)||void 0===c?void 0:c.id,this.dataStoreManager=null==e?void 0:e.dataStore,null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.trace)||void 0===v||v.call(g,"DataManager()",a.DATA_CONSTRUCTOR,this)}set data(e){var t,i,r;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id):null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"DataManager.data.set()",n.CONFIG_DATA_NOT_VALID)}get data(){return this._data}set dataStoreManager(e){this._dataStoreManager=null,e&&(this._dataStoreManager=new J(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager}))}get dataStoreManager(){return this._dataStoreManager}setDataStore(e){this._dataStoreManager=null,e&&(this._dataStoreManager=new J(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager}))}matchRulesByField(e,t,i="key",r){var n,o,s,l,u,d,c,g,v,h,_,p,E,f,M,y,O,m,R,T,I,S,N,C,A,D,L,b,k;const{visitorProperties:U,locationProperties:x,ignoreLocationProperties:P,environment:F=this._environment}=r;null===(o=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===o||o.call(n,"DataManager.matchRulesByField()",this._mapper({visitorId:e,identity:t,identityField:i,visitorProperties:U,locationProperties:x,ignoreLocationProperties:P,environment:F}));const B=this._getEntityByField(t,"experiences",i);if(!B)return null===(l=null===(s=this._loggerManager)||void 0===s?void 0:s.debug)||void 0===l||l.call(s,"DataManager.matchRulesByField()",a.EXPERIENCE_NOT_FOUND,this._mapper({identity:t,identityField:i})),null;if(!!this.getEntitiesList("archived_experiences").find((e=>String(null==B?void 0:B.id)===String(e))))return null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.debug)||void 0===d||d.call(u,"DataManager.matchRulesByField()",a.EXPERIENCE_ARCHIVED,this._mapper({identity:t,identityField:i})),null;if(!(!(null==B?void 0:B.environment)||B.environment===F))return null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.debug)||void 0===g||g.call(c,"DataManager.matchRulesByField()",a.EXPERIENCE_ENVIRONMENT_NOT_MATCH,this._mapper({identity:t,identityField:i})),null;let V=[];const{bucketing:w}=this.getData(e)||{},{[B.id.toString()]:j}=w||{};let G=!1;j&&this.retrieveVariation(B.id,String(j))&&(G=!0);let K=!0===P;if(!K&&x)if(Array.isArray(null==B?void 0:B.locations)&&B.locations.length){let t=[];const r=this.getItemsByIds(B.locations,"locations");if(r.length&&(t=this.selectLocations(e,r,{locationProperties:x,identityField:i}),V=t.filter((e=>Object.values(exports.RuleError).includes(e))),V.length))return V[0];K=Boolean(t.length)}else if(null==B?void 0:B.site_area){if(K=this._ruleManager.isRuleMatched(x,B.site_area,"SiteArea"),Object.values(exports.RuleError).includes(K))return K}else K=!0,null===(h=null===(v=this._loggerManager)||void 0===v?void 0:v.info)||void 0===h||h.call(v,"DataManager.matchRulesByField()",a.LOCATION_NOT_RESTRICTED);if(!K)return null===(p=null===(_=this._loggerManager)||void 0===_?void 0:_.debug)||void 0===p||p.call(_,"DataManager.matchRulesByField()",a.LOCATION_NOT_MATCH,this._mapper({locationProperties:x,[(null==B?void 0:B.locations)?"experiences[].variations[].locations":"experiences[].variations[].site_area"]:(null==B?void 0:B.locations)||(null==B?void 0:B.site_area)||""})),null;let q=[],H=[],W=[],z=[],Y=[],J=!1,X=!1;if(U)if(Array.isArray(null==B?void 0:B.audiences)&&B.audiences.length)if(q=this.getItemsByIds(B.audiences,"audiences"),Y=q.filter((e=>!(G&&e.type===Q))),Y.length){if(W=this.filterMatchedRecordsWithRule(Y,U,"audience",i),V=W.filter((e=>Object.values(exports.RuleError).includes(e))),V.length)return V[0];if(W.length)for(const e of W)null===(f=null===(E=this._loggerManager)||void 0===E?void 0:E.info)||void 0===f||f.call(E,"DataManager.matchRulesByField()",a.AUDIENCE_MATCH.replace("#",null==e?void 0:e[i]));J=B.settings.matching_options.audiences===$?Boolean(W.length===Y.length):Boolean(W.length)}else J=!0,null===(y=null===(M=this._loggerManager)||void 0===M?void 0:M.info)||void 0===y||y.call(M,"DataManager.matchRulesByField()",a.NON_PERMANENT_AUDIENCE_NOT_RESTRICTED);else J=!0,null===(m=null===(O=this._loggerManager)||void 0===O?void 0:O.info)||void 0===m||m.call(O,"DataManager.matchRulesByField()",a.AUDIENCE_NOT_RESTRICTED);if(H=this.getItemsByIds(B.audiences,"segments"),H.length){if(z=this.filterMatchedCustomSegments(H,e),z.length)for(const e of z)null===(T=null===(R=this._loggerManager)||void 0===R?void 0:R.info)||void 0===T||T.call(R,"DataManager.matchRulesByField()",a.SEGMENTATION_MATCH.replace("#",null==e?void 0:e[i]));X=Boolean(z.length)}else X=!0,null===(S=null===(I=this._loggerManager)||void 0===I?void 0:I.info)||void 0===S||S.call(I,"DataManager.matchRulesByField()",a.SEGMENTATION_NOT_RESTRICTED);if(J&&X){if((null==B?void 0:B.variations)&&(null===(N=null==B?void 0:B.variations)||void 0===N?void 0:N.length))return null===(A=null===(C=this._loggerManager)||void 0===C?void 0:C.info)||void 0===A||A.call(C,"DataManager.matchRulesByField()",a.EXPERIENCE_RULES_MATCHED),B;null===(L=null===(D=this._loggerManager)||void 0===D?void 0:D.debug)||void 0===L||L.call(D,"DataManager.matchRulesByField()",a.VARIATIONS_NOT_FOUND,this._mapper({visitorProperties:U,audiences:q}))}else null===(k=null===(b=this._loggerManager)||void 0===b?void 0:b.debug)||void 0===k||k.call(b,"DataManager.matchRulesByField()",a.AUDIENCE_NOT_MATCH,this._mapper({visitorProperties:U,audiences:q}));return null}_getBucketingByField(e,t,i="key",r){var n,a;const{visitorProperties:o,locationProperties:s,updateVisitorProperties:l,forceVariationId:u,enableTracking:d=!0,ignoreLocationProperties:c,environment:g=this._environment}=r;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"DataManager._getBucketingByField()",this._mapper({visitorId:e,identity:t,identityField:i,visitorProperties:o,locationProperties:s,forceVariationId:u,enableTracking:d,ignoreLocationProperties:c,environment:g}));const v=this.matchRulesByField(e,t,i,{visitorProperties:o,locationProperties:s,ignoreLocationProperties:c,environment:g});return v?Object.values(exports.RuleError).includes(v)?v:this._retrieveBucketing(e,o,l,v,u,d):null}_retrieveBucketing(e,t,i,r,o,s=!0){var l,u,d,c,g,v,h,_,p,E,f,M,y,O,m,R,T;if(!e||!r)return null;if(!(null==r?void 0:r.id))return null;let I,S,N=null,C=null;const A=this.getStoreKey(e);o&&(N=this.retrieveVariation(r.id,String(o)))&&(I=o,null===(u=null===(l=this._loggerManager)||void 0===l?void 0:l.info)||void 0===u||u.call(l,"DataManager._retrieveBucketing()",a.BUCKETED_VISITOR_FORCED.replace("#",`#${o}`)),null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.debug)||void 0===c||c.call(d,"DataManager._retrieveBucketing()",this._mapper({storeKey:A,visitorId:e,variationId:o})));const{bucketing:D,segments:L}=this.getData(e)||{},{[r.id.toString()]:b}=D||{};if(!b||I&&String(I)!==String(b)||!(N=this.retrieveVariation(r.id,String(b)))){const o=r.variations.filter((e=>!(null==e?void 0:e.status)||e.status===W)).filter((e=>(null==e?void 0:e.traffic_allocation)>0||isNaN(null==e?void 0:e.traffic_allocation))).reduce(((e,t)=>((null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e)),{}),l=this._bucketingManager.getBucketForVisitor(o,e,(null===(E=null===(p=this._config)||void 0===p?void 0:p.bucketing)||void 0===E?void 0:E.excludeExperienceIdHash)?null:{experienceId:r.id.toString()});if(I=I||(null==l?void 0:l.variationId),S=null==l?void 0:l.bucketingAllocation,!I)return null===(M=null===(f=this._loggerManager)||void 0===f?void 0:f.debug)||void 0===M||M.call(f,"DataManager._retrieveBucketing()",n.UNABLE_TO_SELECT_BUCKET_FOR_VISITOR,this._mapper({visitorId:e,experience:r,buckets:o,bucketing:l})),exports.BucketingError.VARIAION_NOT_DECIDED;if(null===(O=null===(y=this._loggerManager)||void 0===y?void 0:y.info)||void 0===O||O.call(y,"DataManager._retrieveBucketing()",a.BUCKETED_VISITOR.replace("#",`#${I}`)),i?this.putData(e,Object.assign({bucketing:{[r.id.toString()]:I}},t?{segments:t}:{})):this.putData(e,{bucketing:{[r.id.toString()]:I}}),s){const i={experienceId:r.id.toString(),variationId:I.toString()},n={eventType:z,data:i},a=this._ruleManager.isUsingCustomInterface(t)?(null===(m=null==t?void 0:t.get)||void 0===m?void 0:m.call(t))||{}:L;this._apiManager.enqueue(e,n,a),null===(T=null===(R=this._loggerManager)||void 0===R?void 0:R.trace)||void 0===T||T.call(R,"DataManager._retrieveBucketing()",this._mapper({visitorEvent:n}))}N=this.retrieveVariation(r.id,String(I))}else I=b,null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.info)||void 0===v||v.call(g,"DataManager._retrieveBucketing()",a.BUCKETED_VISITOR_FOUND.replace("#",`#${I}`)),null===(_=null===(h=this._loggerManager)||void 0===h?void 0:h.debug)||void 0===_||_.call(h,"DataManager._retrieveBucketing()",this._mapper({storeKey:A,visitorId:e,variationId:I}));return N&&(C=Object.assign(Object.assign({experienceId:null==r?void 0:r.id,experienceName:null==r?void 0:r.name,experienceKey:null==r?void 0:r.key},{bucketingAllocation:S}),N)),C}retrieveVariation(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")}reset(){this._bucketedVisitors=new Map}putData(e,t={}){const i=this.getStoreKey(e),r=this.getData(e)||{};if(!I(r,t)){const e=R(r,t);if(this._bucketedVisitors.set(i,e),this._bucketedVisitors.size>this._localStoreLimit)for(const[e]of this._bucketedVisitors){this._bucketedVisitors.delete(e);break}if(this.dataStoreManager){const{segments:n={}}=r,a=function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]])}return i}(r,["segments"]),{segments:o={}}=this.filterReportSegments(n),{segments:s}=this.filterReportSegments((null==t?void 0:t.segments)||{});s?this._asyncStorage?this.dataStoreManager.enqueue(i,R(a,{segments:Object.assign(Object.assign({},o),s)})):this.dataStoreManager.set(i,R(a,{segments:Object.assign(Object.assign({},o),s)})):this._asyncStorage?this.dataStoreManager.enqueue(i,e):this.dataStoreManager.set(i,e)}}}getData(e){const t=this.getStoreKey(e),i=this._bucketedVisitors.get(t)||null;return this.dataStoreManager?R(i||{},this.dataStoreManager.get(t)||{}):i}getStoreKey(e){return`${this._accountId}-${this._projectId}-${e}`}selectLocations(e,t,i){var r,n,o,s,l,u,d,c,g,v,h,_,p,E,f,M,y,m,R,T;const{locationProperties:I,identityField:S="key",forceEvent:N}=i;null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"DataManager.selectLocations()",this._mapper({items:t,locationProperties:I}));const{locations:C=[]}=this.getData(e)||{},A=[];let D;if(O(t))for(let i=0,r=t.length;i<r;i++){if(!(null===(o=null==t?void 0:t[i])||void 0===o?void 0:o.rules))continue;D=this._ruleManager.isRuleMatched(I,t[i].rules,`ConfigLocation #${t[i][S]}`);const r=null===(u=null===(l=null===(s=null==t?void 0:t[i])||void 0===s?void 0:s[S])||void 0===l?void 0:l.toString)||void 0===u?void 0:u.call(l);if(!0===D)null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===c||c.call(d,"DataManager.selectLocations()",a.LOCATION_MATCH.replace("#",`#${r}`)),C.includes(r)&&!N||(this._eventManager.fire(exports.SystemEvents.LOCATION_ACTIVATED,{visitorId:e,location:{id:null===(g=null==t?void 0:t[i])||void 0===g?void 0:g.id,key:null===(v=null==t?void 0:t[i])||void 0===v?void 0:v.key,name:null===(h=null==t?void 0:t[i])||void 0===h?void 0:h.name}},null,!0),null===(p=null===(_=this._loggerManager)||void 0===_?void 0:_.info)||void 0===p||p.call(_,"DataManager.selectLocations()",a.LOCATION_ACTIVATED.replace("#",`#${r}`))),C.includes(r)||C.push(r),A.push(t[i]);else if(!1!==D)A.push(D);else if(!1===D&&C.includes(r)){this._eventManager.fire(exports.SystemEvents.LOCATION_DEACTIVATED,{visitorId:e,location:{id:null===(E=null==t?void 0:t[i])||void 0===E?void 0:E.id,key:null===(f=null==t?void 0:t[i])||void 0===f?void 0:f.key,name:null===(M=null==t?void 0:t[i])||void 0===M?void 0:M.name}},null,!0);const n=C.findIndex((e=>e===r));C.splice(n,1),null===(m=null===(y=this._loggerManager)||void 0===y?void 0:y.info)||void 0===m||m.call(y,"DataManager.selectLocations()",a.LOCATION_DEACTIVATED.replace("#",`#${r}`))}}return this.putData(e,{locations:C}),null===(T=null===(R=this._loggerManager)||void 0===R?void 0:R.debug)||void 0===T||T.call(R,"DataManager.selectLocations()",this._mapper({matchedRecords:A})),A}getBucketing(e,t,i){return this._getBucketingByField(e,t,"key",i)}getBucketingById(e,t,i){return this._getBucketingByField(e,t,"id",i)}convert(e,i,r,n,o,s){var l,u,d,c,g,v;const h="string"==typeof i?this.getEntity(i,"goals"):this.getEntityById(i,"goals");if(!(null==h?void 0:h.id))return void(null===(u=null===(l=this._loggerManager)||void 0===l?void 0:l.error)||void 0===u||u.call(l,"DataManager.convert()",a.GOAL_NOT_FOUND));if(r){if(!(null==h?void 0:h.rules))return;const e=this._ruleManager.isRuleMatched(r,h.rules,`ConfigGoal #${i}`);if(Object.values(exports.RuleError).includes(e))return e;if(!e)return void(null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.error)||void 0===c||c.call(d,"DataManager.convert()",a.GOAL_RULE_NOT_MATCH))}const _=null==s?void 0:s[t.FORCE_MULTIPLE_TRANSACTIONS],{bucketing:p,goals:{[i.toString()]:E}={}}=this.getData(e)||{};if(!E||(null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.debug)||void 0===v||v.call(g,"DataManager.convert()",a.GOAL_FOUND.replace("#",i.toString()),this._mapper({visitorId:e,goalId:i})),_))return this.putData(e,{goals:{[i.toString()]:!0}}),E||function(){var t,i;const r={goalId:h.id};p&&(r.bucketingData=p);const n={eventType:Y,data:r};this._apiManager.enqueue(e,n,o),null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===i||i.call(t,"DataManager.convert()",this._mapper({event:n}))}.call(this),!n||E&&!_||function(){var t,i;const r={goalId:h.id,goalData:n};p&&(r.bucketingData=p);const a={eventType:Y,data:r};this._apiManager.enqueue(e,a,o),null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===i||i.call(t,"DataManager.convert()",this._mapper({event:a}))}.call(this),!0}filterMatchedRecordsWithRule(e,t,i,r="id"){var n,a,o,s,l;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"DataManager.filterMatchedRecordsWithRule()",this._mapper({items:e,visitorProperties:t}));const u=[];let d;if(O(e))for(let n=0,a=e.length;n<a;n++)(null===(o=null==e?void 0:e[n])||void 0===o?void 0:o.rules)&&(d=this._ruleManager.isRuleMatched(t,e[n].rules,`${b(i)} #${e[n][r]}`),!0===d?u.push(e[n]):!1!==d&&u.push(d));return null===(l=null===(s=this._loggerManager)||void 0===s?void 0:s.debug)||void 0===l||l.call(s,"DataManager.filterMatchedRecordsWithRule()",this._mapper({matchedRecords:u})),u}filterMatchedCustomSegments(e,t){var i,r,n,a,o;null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"DataManager.filterMatchedCustomSegments()",this._mapper({items:e,visitorId:t}));const{segments:{[f.CUSTOM_SEGMENTS]:s=[]}={}}=this.getData(t)||{},l=[];if(O(e))for(let t=0,i=e.length;t<i;t++)(null===(n=null==e?void 0:e[t])||void 0===n?void 0:n.id)&&s.includes(e[t].id)&&l.push(e[t]);return null===(o=null===(a=this._loggerManager)||void 0===a?void 0:a.debug)||void 0===o||o.call(a,"DataManager.filterMatchedCustomSegments()",this._mapper({matchedRecords:l})),l}filterReportSegments(e){const t=Object.values(f).map((e=>e)),i={},r={};for(const n in e)t.includes(n)?i[n]=e[n]:r[n]=e[n];return{properties:Object.keys(r).length?r:null,segments:Object.keys(i).length?i:null}}getEntitiesList(e){var t,i;let n=[];const a=r[e]||e;return-1!==this._dataEntities.indexOf(a)&&(n=m(this._data,a)||[]),null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===i||i.call(t,"DataManager.getEntitiesList()",this._mapper({entityType:a,list:n})),n}getEntitiesListObject(e,t="id"){return this.getEntitiesList(e).reduce(((e,i)=>(e[i[t]]=i,e)),{})}_getEntityByField(e,t,i="key"){var n,a,o;const s=r[t]||t;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"DataManager._getEntityByField()",this._mapper({identity:e,entityType:s,identityField:i}));const l=this.getEntitiesList(s);if(O(l))for(let t=0,r=l.length;t<r;t++)if(l[t]&&String(null===(o=l[t])||void 0===o?void 0:o[i])===String(e))return l[t];return null}getEntity(e,t){return this._getEntityByField(e,t,"key")}getEntities(e,t){return this.getItemsByKeys(e,t)}getEntityById(e,t){return this._getEntityByField(e,t,"id")}getEntitiesByIds(e,t){return this.getItemsByIds(e,t)}getItemsByKeys(e,t){var i;const r=this.getEntitiesList(t),n=[];if(O(r))for(let t=0,a=r.length;t<a;t++)-1!==e.indexOf(null===(i=r[t])||void 0===i?void 0:i.key)&&n.push(r[t]);return n}getItemsByIds(e,t){var i,r,n;null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"DataManager.getItemsByIds()",this._mapper({ids:e,path:t}));const a=[];if(O(e)){const i=this.getEntitiesList(t);if(O(i))for(let t=0,r=i.length;t<r;t++)-1!==e.indexOf(null===(n=i[t])||void 0===n?void 0:n.id)&&a.push(i[t])}return a}getSubItem(e,t,i,r,n,a){const o=this._getEntityByField(t,e,n);for(const e of o[i])if(e[a]===r)return e;return null}isValidConfigData(e){var t;return T(e)&&(!!(null==e?void 0:e.account_id)&&!!(null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id)||Boolean(e.error))}}class Z{constructor(e,{loggerManager:t}={}){this._listeners={},this._deferred={},this._loggerManager=t,this._mapper=(null==e?void 0:e.mapper)||(e=>e)}on(e,t){var i,r;(this._listeners[e]=this._listeners[e]||[]).push(t),null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"EventManager.on()",{event:e}),Object.hasOwnProperty.call(this._deferred,e)&&this.fire(e,this._deferred[e].args,this._deferred[e].err)}removeListeners(e){Object.hasOwnProperty.call(this._listeners,e)&&delete this._listeners[e],Object.hasOwnProperty.call(this._deferred,e)&&delete this._deferred[e]}fire(e,t=null,i=null,r=!1){var n,a,o,s;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.debug)||void 0===a||a.call(n,"EventManager.fire()",this._mapper({event:e,args:t,err:i,deferred:r}));for(const r of this._listeners[e]||[])if(Object.hasOwnProperty.call(this._listeners,e)&&"function"==typeof r)try{r.apply(null,[this._mapper(t),i])}catch(e){null===(s=null===(o=this._loggerManager)||void 0===o?void 0:o.error)||void 0===s||s.call(o,"EventManager.fire()",e)}r&&!Object.hasOwnProperty.call(this._deferred,e)&&(this._deferred[e]={args:t,err:i})}}class ee{constructor(e,{dataManager:t,loggerManager:i}){var r,n;this._dataManager=t,this._loggerManager=i,null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"ExperienceManager()",a.EXPERIENCE_CONSTRUCTOR)}getList(){return this._dataManager.getEntitiesList("experiences")}getExperience(e){return this._dataManager.getEntity(e,"experiences")}getExperienceById(e){return this._dataManager.getEntityById(e,"experiences")}getExperiences(e){return this._dataManager.getItemsByKeys(e,"experiences")}selectVariation(e,t,i){return this._dataManager.getBucketing(e,t,i)}selectVariationById(e,t,i){return this._dataManager.getBucketingById(e,t,i)}selectVariations(e,t){return this.getList().map((i=>this.selectVariation(e,null==i?void 0:i.key,t))).filter((e=>e&&!Object.values(exports.RuleError).includes(e)&&!Object.values(exports.BucketingError).includes(e)))}getVariation(e,t){return this._dataManager.getSubItem("experiences",e,"variations",t,"key","key")}getVariationById(e,t){return this._dataManager.getSubItem("experiences",e,"variations",t,"id","id")}}class te{constructor(e,{dataManager:t,loggerManager:i}){var r,n;this._dataManager=t,this._loggerManager=i,null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"FeatureManager()",a.FEATURE_CONSTRUCTOR)}getList(){return this._dataManager.getEntitiesList("features")}getListAsObject(e="id"){return this._dataManager.getEntitiesListObject("features",e)}getFeature(e){return this._dataManager.getEntity(e,"features")}getFeatureById(e){return this._dataManager.getEntityById(e,"features")}getFeatures(e){return this._dataManager.getItemsByKeys(e,"features")}getFeatureVariableType(e,t){const i=this.getFeature(e);if(Object.prototype.hasOwnProperty.call(i,"variables")){const e=i.variables.find((e=>e.key===t));return(null==e?void 0:e.type)||null}return null}getFeatureVariableTypeById(e,t){const i=this.getFeatureById(e);if(Object.prototype.hasOwnProperty.call(i,"variables")){const e=i.variables.find((e=>e.key===t));return(null==e?void 0:e.type)||null}return null}isFeatureDeclared(e){return!!this._dataManager.getEntity(e,"features")}runFeature(e,t,i,r){const n=this._dataManager.getEntity(t,"features");if(n){const a=this.runFeatures(e,i,{features:[t],experiences:r});return O(a)?1===a.length?a[0]:a:{id:n.id,name:n.name,key:t,status:l.DISABLED}}return{key:t,status:l.DISABLED}}isFeatureEnabled(e,t,i,r){if(this._dataManager.getEntity(t,"features")){return O(this.runFeatures(e,i,{features:[t],experiences:r}))}return!1}runFeatureById(e,t,i,r){const n=this._dataManager.getEntityById(t,"features");if(n){const a=this.runFeatures(e,i,{features:[n.key],experiences:this._dataManager.getEntitiesByIds(r,"experiences").map((e=>e.key))});if(O(a)){if(1===a.length)return a[0];{const e=a.filter((e=>Object.values(exports.RuleError).includes(e)));return e.length?e:a}}return{id:t,name:n.name,key:n.key,status:l.DISABLED}}return{id:t,status:l.DISABLED}}runFeatures(e,t,i){var r,n,o,s,u,d,c,g,v,h,_,p,E,f,M,y,m,R;const{typeCasting:I=!0}=t,S=this.getListAsObject("id"),N=[],C=(i&&O(null==i?void 0:i.experiences)?this._dataManager.getEntities(i.experiences,"experiences"):this._dataManager.getEntitiesList("experiences")).map((i=>{const r=this._dataManager.getBucketing(e,null==i?void 0:i.key,t);return Object.values(exports.RuleError).includes(r),r})).filter(Boolean),A=C.filter((e=>Object.values(exports.RuleError).includes(e)));if(A.length)return A;for(const e in C){const t=C[e];for(const e in(null==t?void 0:t.changes)||[]){const C=null===(n=null===(r=null==t?void 0:t.changes)||void 0===r?void 0:r[e])||void 0===n?void 0:n.data;if((null===(s=null===(o=null==t?void 0:t.changes)||void 0===o?void 0:o[e])||void 0===s?void 0:s.type)!==exports.VariationChangeType.FULLSTACK_FEATURE){null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.warn)||void 0===d||d.call(u,"FeatureManager.runFeatures()",a.VARIATION_CHANGE_NOT_SUPPORTED);continue}const A=null==C?void 0:C.feature_id;if(A){if(i&&O(null==i?void 0:i.features)&&-1!==(null===(v=null==i?void 0:i.features)||void 0===v?void 0:v.indexOf(null===(h=S[String(A)])||void 0===h?void 0:h.key))||!(null==i?void 0:i.features)){const e=null==C?void 0:C.variables_data;if(e||null===(p=null===(_=this._loggerManager)||void 0===_?void 0:_.warn)||void 0===p||p.call(_,"FeatureManager.runFeatures()",a.FEATURE_VARIABLES_NOT_FOUND),I&&T(e))for(const t in e){const i=null===(f=null===(E=S[String(A)])||void 0===E?void 0:E.variables)||void 0===f?void 0:f.find((e=>e.key===t));(null==i?void 0:i.type)?e[t]=this.castType(e[t],i.type):null===(y=null===(M=this._loggerManager)||void 0===M?void 0:M.warn)||void 0===y||y.call(M,"FeatureManager.runFeatures()",a.FEATURE_VARIABLES_TYPE_NOT_FOUND)}const i=Object.assign({experienceId:t.experienceId,experienceName:t.experienceName,experienceKey:t.experienceKey},{key:null===(m=S[String(A)])||void 0===m?void 0:m.key,name:null===(R=S[String(A)])||void 0===R?void 0:R.name,id:String(A),status:l.ENABLED,variables:e});N.push(i)}}else null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.warn)||void 0===g||g.call(c,"FeatureManager.runFeatures()",a.FEATURE_NOT_FOUND)}}if(!(null==i?void 0:i.features)){const e=N.map((e=>e.id));for(const t in S)-1===e.indexOf(S[t].id)&&N.push({id:S[t].id,name:S[t].name,key:S[t].key,status:l.DISABLED})}return N}castType(e,t){return function(e,t){switch(t){case"boolean":return"true"===e||"false"!==e&&!!e;case"float":return!0===e?1:!1===e?0:parseFloat(e);case"json":if("object"==typeof e)return e;try{return JSON.parse(e)}catch(t){return String(e)}case"string":return String(e);case"integer":return!0===e?1:!1===e?0:parseInt(e);default:return e}}(e,t)}}const ie=!0;class re{constructor(e,{loggerManager:t}={}){var i,r,n,o,s;this._comparisonProcessor=x,this._negation="!",this._keys_case_sensitive=ie,this._loggerManager=t,this._comparisonProcessor=(null===(i=null==e?void 0:e.rules)||void 0===i?void 0:i.comparisonProcessor)||x,this._negation=String((null===(r=null==e?void 0:e.rules)||void 0===r?void 0:r.negation)||"!"),this._keys_case_sensitive=(null===(n=null==e?void 0:e.rules)||void 0===n?void 0:n.keys_case_sensitive)||ie,this._mapper=(null==e?void 0:e.mapper)||(e=>e),null===(s=null===(o=this._loggerManager)||void 0===o?void 0:o.trace)||void 0===s||s.call(o,"RuleManager()",a.RULE_CONSTRUCTOR,this)}set comparisonProcessor(e){this._comparisonProcessor=e}get comparisonProcessor(){return this._comparisonProcessor}getComparisonProcessorMethods(){return Object.getOwnPropertyNames(this._comparisonProcessor).filter((e=>"function"==typeof this._comparisonProcessor[e]))}isRuleMatched(e,t,i){var r,o,s,l,u,d,c,g,v,h;let _;if(null===(o=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===o||o.call(r,"RuleManager.isRuleMatched()",this._mapper({data:e,ruleSet:t})),i&&(null===(l=null===(s=this._loggerManager)||void 0===s?void 0:s.info)||void 0===l||l.call(s,"RuleManager.isRuleMatched()",a.PROCESSING_ENTITY.replace("#",i))),Object.prototype.hasOwnProperty.call(t,"OR")&&O(null==t?void 0:t.OR)){for(let r=0,o=t.OR.length;r<o;r++){if(_=this._processAND(e,t.OR[r]),!0===_)return _;Object.values(exports.RuleError).includes(_)?null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.info)||void 0===d||d.call(u,"RuleManager.isRuleMatched()",i||"",n.RULE_ERROR):null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.info)||void 0===g||g.call(c,"RuleManager.isRuleMatched()",i||"",!1===_?a.RULE_NOT_MATCH:a.RULE_MATCH.replace("#",String(r)))}if(!1!==_)return _}else null===(h=null===(v=this._loggerManager)||void 0===v?void 0:v.warn)||void 0===h||h.call(v,"RuleManager.isRuleMatched()",i||"",n.RULE_NOT_VALID);return!1}isValidRule(e){var t,i;return null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===i||i.call(t,"RuleManager.isValidRule()",this._mapper({rule:e})),Object.prototype.hasOwnProperty.call(e,"matching")&&"object"==typeof e.matching&&Object.prototype.hasOwnProperty.call(e.matching,"match_type")&&"string"==typeof e.matching.match_type&&Object.prototype.hasOwnProperty.call(e.matching,"negated")&&"boolean"==typeof e.matching.negated&&Object.prototype.hasOwnProperty.call(e,"value")}_processAND(e,t){var i,r,o,s;let l;if(Object.prototype.hasOwnProperty.call(t,"AND")&&O(null==t?void 0:t.AND)){for(let i=0,r=t.AND.length;i<r;i++)if(l=this._processORWHEN(e,t.AND[i]),!1===l)return!1;return!1!==l&&(null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.info)||void 0===r||r.call(i,"RuleManager._processAND()",a.RULE_MATCH_AND)),l}return null===(s=null===(o=this._loggerManager)||void 0===o?void 0:o.warn)||void 0===s||s.call(o,"RuleManager._processAND()",n.RULE_NOT_VALID),!1}_processORWHEN(e,t){var i,r;let a;if(Object.prototype.hasOwnProperty.call(t,"OR_WHEN")&&O(null==t?void 0:t.OR_WHEN)){for(let i=0,r=t.OR_WHEN.length;i<r;i++)if(a=this._processRuleItem(e,t.OR_WHEN[i]),!0===a)return a;if(!1!==a)return a}else null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.warn)||void 0===r||r.call(i,"RuleManager._processORWHEN()",n.RULE_NOT_VALID);return!1}_processRuleItem(e,t){var i,r,o,s,l,u,d,c,g,v,h,_,p;if(this.isValidRule(t))try{const v=t.matching.negated||!1,h=t.matching.match_type;if(-1!==this.getComparisonProcessorMethods().indexOf(h))if(e&&"object"==typeof e)if(this.isUsingCustomInterface(e)){if(null==t?void 0:t.rule_type){null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.info)||void 0===r||r.call(i,"RuleManager._processRuleItem()",a.RULE_MATCH_START.replace("#",t.rule_type));for(const i of Object.getOwnPropertyNames(e.constructor.prototype)){if("constructor"===i)continue;const r=b(`get ${t.rule_type.replace(/_/g," ")}`);if(i===r||(null===(o=null==e?void 0:e.mapper)||void 0===o?void 0:o.call(e,i))===r){const r=e[i](t);return Object.values(exports.RuleError).includes(r)||"js_condition"===t.rule_type?r:this._comparisonProcessor[h](r,t.value,v)}}}}else if(T(e))for(const i of Object.keys(e)){const r=this._keys_case_sensitive?i:i.toLowerCase();if(r===(this._keys_case_sensitive?t.key:String(t.key).toLowerCase()))return this._comparisonProcessor[h](e[i],t.value,v)}else null===(l=null===(s=this._loggerManager)||void 0===s?void 0:s.trace)||void 0===l||l.call(s,"RuleManager._processRuleItem()",{warn:n.RULE_DATA_NOT_VALID,data:e});else null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.trace)||void 0===d||d.call(u,"RuleManager._processRuleItem()",{warn:n.RULE_NOT_VALID,data:e,rule:t});else null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.warn)||void 0===g||g.call(c,"RuleManager._processRuleItem()",n.RULE_MATCH_TYPE_NOT_SUPPORTED.replace("#",h))}catch(e){null===(h=null===(v=this._loggerManager)||void 0===v?void 0:v.error)||void 0===h||h.call(v,"RuleManager._processRuleItem()",{error:e.message})}else null===(p=null===(_=this._loggerManager)||void 0===_?void 0:_.warn)||void 0===p||p.call(_,"RuleManager._processRuleItem()",n.RULE_NOT_VALID);return!1}isUsingCustomInterface(e){return T(e)&&Object.prototype.hasOwnProperty.call(e,"name")&&"RuleData"===e.name}}class ne{constructor(e,{dataManager:t,ruleManager:i,loggerManager:r}){this._dataManager=t,this._ruleManager=i,this._loggerManager=r,this._data=m(e,"data")}getSegments(e){const t=this._dataManager.getData(e)||{},{segments:i}=this._dataManager.filterReportSegments(null==t?void 0:t.segments);return i}putSegments(e,t){const{segments:i}=this._dataManager.filterReportSegments(t);i&&this._dataManager.putData(e,{segments:i})}setCustomSegments(e,t,i){var r,n,o,s,l;const u=this._dataManager.getData(e)||{},{segments:{[f.CUSTOM_SEGMENTS]:d=[]}={}}=u,c=[];let g,v=!1;for(const e of t){if(i&&!v&&(v=this._ruleManager.isRuleMatched(i,null==e?void 0:e.rules,`ConfigSegment #${null==e?void 0:e.id}`),Object.values(exports.RuleError).includes(v)))return v;if(!i||v){const t=null===(r=null==e?void 0:e.id)||void 0===r?void 0:r.toString();d.includes(t)?null===(o=null===(n=this._loggerManager)||void 0===n?void 0:n.warn)||void 0===o||o.call(n,"SegmentsManager.setCustomSegments()",a.CUSTOM_SEGMENTS_KEY_FOUND):c.push(t)}}return c.length?(g=Object.assign(Object.assign({},u.segments||{}),{[f.CUSTOM_SEGMENTS]:[...d,...c]}),this.putSegments(e,g)):null===(l=null===(s=this._loggerManager)||void 0===s?void 0:s.warn)||void 0===l||l.call(s,"SegmentsManager.setCustomSegments()",a.SEGMENTS_NOT_FOUND),g}selectCustomSegments(e,t,i){const r=this._dataManager.getEntities(t,"segments");return this.setCustomSegments(e,r,i)}selectCustomSegmentsByIds(e,t,i){const r=this._dataManager.getEntitiesByIds(t,"segments");return this.setCustomSegments(e,r,i)}}const ae=exports.LogLevel.TRACE;class oe{constructor(e=console,t=ae,i){this._defaultMapper={[c.LOG]:c.LOG,[c.DEBUG]:c.DEBUG,[c.INFO]:c.INFO,[c.WARN]:c.WARN,[c.ERROR]:c.ERROR,[c.TRACE]:c.TRACE},this._clients=[],this.addClient(e,t,i)}_isValidLevel(e){return Object.values(exports.LogLevel).includes(e)}_isValidMethod(e){return Object.values(c).includes(e)}_log(e,t,...i){this._clients.forEach((r=>{var n,a;if(t>=r.level&&exports.LogLevel.SILENT!==t){const t=r.sdk[r.mapper[e]];t?t.call(r.sdk,...i):(console.log(`Info: Unable to find method "${e}()" in client sdk:`,null===(a=null===(n=r.sdk)||void 0===n?void 0:n.constructor)||void 0===a?void 0:a.name),console[e](...i))}}))}log(e,...t){this._isValidLevel(e)?this._log(c.LOG,e,...t):console.error("Invalid Log Level")}trace(...e){this._log(c.TRACE,exports.LogLevel.TRACE,...e)}debug(...e){this._log(c.DEBUG,exports.LogLevel.DEBUG,...e)}info(...e){this._log(c.INFO,exports.LogLevel.INFO,...e)}warn(...e){this._log(c.WARN,exports.LogLevel.WARN,...e)}error(...e){this._log(c.ERROR,exports.LogLevel.ERROR,...e)}addClient(e=console,t=ae,i){if(!e)return void console.error("Invalid Client SDK");if(!this._isValidLevel(t))return void console.error("Invalid Log Level");const r=Object.assign({},this._defaultMapper);i&&Object.keys(i).filter(this._isValidMethod).forEach((e=>{r[e]=i[e]})),this._clients.push({sdk:e,level:t,mapper:r})}setClientLevel(e,t){if(this._isValidLevel(e))if(t){const i=this._clients.findIndex((({sdk:e})=>e===t));if(-1===i)return void console.error("Client SDK not found");this._clients[i].level=e}else for(let t=0,i=this._clients.length;t<i;t++)this._clients[t].level=e;else console.error("Invalid Log Level")}}const se={api:{endpoint:{config:"https://cdn-4.convertexperiments.com/api/v1/",track:"https://[project_id].metrics.convertexperiments.com/v1/"}},environment:"staging",bucketing:{max_traffic:1e4,hash_seed:9999},data:{},dataStore:null,dataRefreshInterval:3e5,events:{batch_size:10,release_interval:1e3},logger:{logLevel:exports.LogLevel.DEBUG,customLoggers:[]},rules:{keys_case_sensitive:!0,comparisonProcessor:null},network:{tracking:!0,cacheLevel:"default"},sdkKey:"",sdkKeySecret:""},le={logger:{logLevel:exports.LogLevel.WARN,customLoggers:[]}},ue={environment:"staging"};exports.DataStore=class{constructor(e,t){var i,r,n,a;this._file=e,this._fs=t;try{(null===(r=null===(i=this._fs)||void 0===i?void 0:i.existsSync)||void 0===r?void 0:r.call(i,this._file))||null===(a=null===(n=this._fs)||void 0===n?void 0:n.writeFileSync)||void 0===a||a.call(n,this._file,"{}")}catch(e){console.error(e)}}get(e){var t,i;try{return JSON.parse(null===(i=null===(t=this._fs)||void 0===t?void 0:t.readFileSync)||void 0===i?void 0:i.call(t,this._file))[e]}catch(e){console.error(e)}}set(e,t){var i,r,n,a;try{const o=JSON.parse(null===(r=null===(i=this._fs)||void 0===i?void 0:i.readFileSync)||void 0===r?void 0:r.call(i,this._file));o[e]=t,null===(a=null===(n=this._fs)||void 0===n?void 0:n.writeFileSync)||void 0===a||a.call(n,this._file,JSON.stringify(o))}catch(e){console.error(e)}}delete(e){var t,i,r,n;try{const a=JSON.parse(null===(i=null===(t=this._fs)||void 0===t?void 0:t.readFileSync)||void 0===i?void 0:i.call(t,this._file));delete a[e],null===(n=null===(r=this._fs)||void 0===r?void 0:r.writeFileSync)||void 0===n||n.call(r,this._file,JSON.stringify(a))}catch(e){console.error(e)}}},exports.FileLogger=class{constructor(e,t,i="appendFileSync"){this._file=e,this._fs=t,this._appendMethod=i}_write(t,...i){return e(this,void 0,void 0,(function*(){var e,r;const n=`${(new Date).toISOString()} [${t.toUpperCase()}]`,a=`${n} ${i.map(JSON.stringify).join(`\n${n} `)}\n`;try{null===(r=null===(e=this._fs)||void 0===e?void 0:e[this._appendMethod])||void 0===r||r.call(e,this._file,a)}catch(e){console.warn(e)}}))}log(...t){return e(this,void 0,void 0,(function*(){yield this._write(c.LOG,...t)}))}info(...t){return e(this,void 0,void 0,(function*(){yield this._write(c.INFO,...t)}))}debug(...t){return e(this,void 0,void 0,(function*(){yield this._write(c.DEBUG,...t)}))}warn(...t){return e(this,void 0,void 0,(function*(){yield this._write(c.WARN,...t)}))}error(...t){return e(this,void 0,void 0,(function*(){yield this._write(c.ERROR,...t)}))}},exports.default=class extends H{constructor(e={}){var t,i,r;const a=Boolean(Object.prototype.hasOwnProperty.call(e,"sdkKey")&&(null===(t=e.sdkKey)||void 0===t?void 0:t.length)),o=Boolean(Object.prototype.hasOwnProperty.call(e,"data"));a||o||console.error(n.SDK_OR_DATA_OBJECT_REQUIRED);const s=((e={})=>R(le,ue,se,e))(e);(null==s?void 0:s.network)||(s.network={}),(null===(i=s.network)||void 0===i?void 0:i.source)||(s.network.source="js4.3.2");const l=new oe(console,s.logger.logLevel);for(const e in s.logger.customLoggers)Object.prototype.hasOwnProperty.call(s.logger.customLoggers[e],"logger")&&Object.prototype.hasOwnProperty.call(s.logger.customLoggers[e],"logLevel")?l.addClient(s.logger.customLoggers[e].logger,s.logger.customLoggers[e].logLevel,null===(r=s.logger.customLoggers[e])||void 0===r?void 0:r.methodsMap):l.addClient(s.logger.customLoggers[e],s.logger.logLevel);const u=new Z(s,{loggerManager:l}),d=new G(s,{eventManager:u,loggerManager:l}),c=new K(s,{loggerManager:l}),g=new re(s,{loggerManager:l}),v=new X(s,{bucketingManager:c,ruleManager:g,eventManager:u,apiManager:d,loggerManager:l});super(s,{dataManager:v,eventManager:u,experienceManager:new ee(s,{dataManager:v}),featureManager:new te(s,{dataManager:v,loggerManager:l}),segmentsManager:new ne(s,{dataManager:v,ruleManager:g,loggerManager:l}),apiManager:d,loggerManager:l})}onReady(){return super.onReady()}};
//# sourceMappingURL=index.min.js.map
