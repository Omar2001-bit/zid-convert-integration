/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).ConvertSDK={})}(this,(function(e){"use strict";function t(e,t,i,r){return new(i||(i=Promise))((function(n,a){function o(e){try{l(r.next(e))}catch(e){a(e)}}function s(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,s)}l((r=r.apply(e,t||[])).next())}))}var i;"function"==typeof SuppressedError&&SuppressedError,e.BucketingError=void 0,(e.BucketingError||(e.BucketingError={})).VARIAION_NOT_DECIDED="convert.com_variation_not_decided",function(e){e.FORCE_MULTIPLE_TRANSACTIONS="forceMultipleTransactions"}(i||(i={}));const r=["events","goals","audiences","locations","segments","experiences","archived_experiences","experiences.variations","features","features.variables"],n={goal:"goals",audience:"audiences",location:"locations",segment:"segments",experience:"experiences",variation:"experiences.variations",feature:"features"},a={SDK_KEY_MISSING:"SDK key is missing",DATA_OBJECT_MISSING:"Data object is missing",CONFIG_DATA_NOT_VALID:"Config Data is not valid",SDK_OR_DATA_OBJECT_REQUIRED:"SDK key or Data object should be provided",RULE_NOT_VALID:"Provided rule is not valid",RULE_DATA_NOT_VALID:"Provided rule data is not valid",RULE_MATCH_TYPE_NOT_SUPPORTED:'Provided rule matching type "#" is not supported',RULE_ERROR:"Rule error",DATA_STORE_NOT_VALID:"DataStore object is not valid. It should contain get and set methods",VISITOR_ID_REQUIRED:"Visitor string string is not present",GOAL_DATA_NOT_VALID:"GoalData object is not valid",UNABLE_TO_SELECT_BUCKET_FOR_VISITOR:"Unable to bucket visitor",UNABLE_TO_PERFORM_NETWORK_REQUEST:"Unable to perform network request",UNSUPPORTED_RESPONSE_TYPE:"Unsupported response type"},o={CONFIG_DATA_UPDATED:"Config Data updated",CORE_CONSTRUCTOR:"Core Manager constructor has been called",CORE_INITIALIZED:"Core Manager has been initialized",EXPERIENCE_CONSTRUCTOR:"Experience Manager constructor has been called",EXPERIENCE_NOT_FOUND:"Experience not found",EXPERIENCE_ARCHIVED:"Experience archived",EXPERIENCE_ENVIRONMENT_NOT_MATCH:"Experience environment does not match",EXPERIENCE_RULES_MATCHED:"Experience rules matched",VARIATIONS_NOT_FOUND:"Variations not found",VARIATION_CHANGE_NOT_SUPPORTED:"Variation change not supported",FEATURE_CONSTRUCTOR:"Feature Manager constructor has been called",FEATURE_NOT_FOUND:"Fullstack Feature not found",FEATURE_VARIABLES_NOT_FOUND:"Fullstack Feature Variables not found",FEATURE_VARIABLES_TYPE_NOT_FOUND:"Fullstack Feature Variables Type not found",BUCKETING_CONSTRUCTOR:"Bucketing Manager constructor has been called",DATA_CONSTRUCTOR:"Data Manager constructor has been called",RULE_CONSTRUCTOR:"Rule Manager constructor has been called",PROCESSING_ENTITY:"Processing #",LOCATION_MATCH:"Location # rule matched",LOCATION_NOT_MATCH:"Location does not match",LOCATION_NOT_RESTRICTED:"Location not restricted",AUDIENCE_MATCH:"Audience # rule matched",AUDIENCE_NOT_MATCH:"Audience does not match",NON_PERMANENT_AUDIENCE_NOT_RESTRICTED:"Non-Permanent Audience not restricted",AUDIENCE_NOT_RESTRICTED:"Audience not restricted",SEGMENTATION_MATCH:"Segmentation # rule matched",SEGMENTATION_NOT_RESTRICTED:"Segmentation not restricted",RULE_NOT_MATCH:"Rule does not match",RULE_MATCH:"Found matched rule at OR block #",RULE_MATCH_AND:"AND block rule macthed",RULE_MATCH_START:"About to evaluate rule #",LOCATION_ACTIVATED:"Location # activated",LOCATION_DEACTIVATED:"Location # deactivated",BUCKETED_VISITOR_FOUND:"Visitor is already bucketed for variation #",BUCKETED_VISITOR_FORCED:"Forcing variation #",BUCKETED_VISITOR:"Visitor is bucketed for variation #",GOAL_NOT_FOUND:"Goal not found",GOAL_RULE_NOT_MATCH:"Goal rule do not match",GOAL_FOUND:"Goal # already triggered",SEGMENTS_NOT_FOUND:"Segments not found",SEGMENTS_RULE_NOT_MATCH:"Segments rule do not match",CUSTOM_SEGMENTS_KEY_FOUND:"Custom segments key already set",SEND_BEACON_SUCCESS:"The user agent successfully queued the data for transfer",RELEASING_QUEUE:"Releasing event queue..."};var s,l,u,d,c,g,v,h,_,p,E,f,M,y,O;function m(e){return Array.isArray(e)&&e.length>0}function T(e,t,i,r=!1){try{if("object"==typeof e){const i=t.split(".").reduce(((e,t)=>e[t]),e);if(i||r&&(!1===i||0===i))return i}}catch(e){}return null}function R(...e){const t=e=>e&&"object"==typeof e;return e.reduce(((e,i)=>(Object.keys(i).forEach((r=>{const n=e[r],a=i[r];Array.isArray(n)&&Array.isArray(a)?e[r]=[...new Set([...a,...n])]:t(n)&&t(a)?e[r]=R(n,a):e[r]=a})),e)),{})}function I(e){return"object"==typeof e&&null!==e&&Object.keys(e).length>0}!function(e){e.OFF="OFF",e.EU_ONLY="EU ONLY",e.EEA_ONLY="EEA ONLY",e.WORLDWIDE="Worldwide"}(s||(s={})),e.EntityType=void 0,(l=e.EntityType||(e.EntityType={})).AUDIENCE="audience",l.LOCATION="location",l.SEGMENT="segment",l.FEATURE="feature",l.GOAL="goal",l.EXPERIENCE="experience",l.VARIATION="variation",function(e){e.ENABLED="enabled",e.DISABLED="disabled"}(u||(u={})),e.GoalDataKey=void 0,(d=e.GoalDataKey||(e.GoalDataKey={})).AMOUNT="amount",d.PRODUCTS_COUNT="productsCount",d.TRANSACTION_ID="transactionId",e.LogLevel=void 0,(c=e.LogLevel||(e.LogLevel={}))[c.TRACE=0]="TRACE",c[c.DEBUG=1]="DEBUG",c[c.INFO=2]="INFO",c[c.WARN=3]="WARN",c[c.ERROR=4]="ERROR",c[c.SILENT=5]="SILENT",function(e){e.LOG="log",e.TRACE="trace",e.DEBUG="debug",e.INFO="info",e.WARN="warn",e.ERROR="error"}(g||(g={})),function(e){e.WEB="web",e.FULLSTACK="fullstack"}(v||(v={})),e.RuleError=void 0,(h=e.RuleError||(e.RuleError={})).NO_DATA_FOUND="convert.com_no_data_found",h.NEED_MORE_DATA="convert.com_need_more_data",e.SystemEvents=void 0,(_=e.SystemEvents||(e.SystemEvents={})).READY="ready",_.CONFIG_UPDATED="config.updated",_.API_QUEUE_RELEASED="api.queue.released",_.BUCKETING="bucketing",_.CONVERSION="conversion",_.SEGMENTS="segments",_.LOCATION_ACTIVATED="location.activated",_.LOCATION_DEACTIVATED="location.deactivated",_.AUDIENCES="audiences",_.DATA_STORE_QUEUE_RELEASED="datastore.queue.released",e.VariationChangeType=void 0,(p=e.VariationChangeType||(e.VariationChangeType={})).RICH_STRUCTURE="richStructure",p.CUSTOM_CODE="customCode",p.DEFAULT_CODE="defaultCode",p.DEFAULT_CODE_MULTIPAGE="defaultCodeMultipage",p.DEFAULT_REDIRECT="defaultRedirect",p.FULLSTACK_FEATURE="fullStackFeature",function(e){e.IE="IE",e.CH="CH",e.FF="FF",e.OP="OP",e.SF="SF",e.EDG="EDG",e.MO="MO",e.NS="NS",e.OTH="OTH"}(E||(E={})),function(e){e.ALLPH="ALLPH",e.IPH="IPH",e.OTHPH="OTHPH",e.ALLTAB="ALLTAB",e.IPAD="IPAD",e.OTHTAB="OTHTAB",e.DESK="DESK",e.OTHDEV="OTHDEV"}(f||(f={})),function(e){e.COUNTRY="country",e.BROWSER="browser",e.DEVICES="devices",e.SOURCE="source",e.CAMPAIGN="campaign",e.VISITOR_TYPE="visitorType",e.CUSTOM_SEGMENTS="customSegments"}(M||(M={})),function(e){e.CAMPAIGN="campaign",e.SEARCH="search",e.REFERRAL="referral",e.DIRECT="direct"}(y||(y={})),function(e){e.NEW="new",e.RETURNING="returning"}(O||(O={}));const S=(e,t)=>{if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||null==e||null==t)return!1;const i=Object.keys(e),r=Object.keys(t);if(i.length!=r.length)return!1;for(const n of i){if(!r.includes(n))return!1;if("function"==typeof e[n]||"function"==typeof t[n]){if(e[n].toString()!=t[n].toString())return!1}else if(!S(e[n],t[n]))return!1}return!0};function N(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var C={exports:{}};!function(e){!function(){const t=e=>(new TextEncoder).encode(e);function i(e,i){let r,n,a,o,s,l,u,d;for("string"==typeof e&&(e=t(e)),r=3&e.length,n=e.length-r,a=i,s=3432918353,l=461845907,d=0;d<n;)u=255&e[d]|(255&e[++d])<<8|(255&e[++d])<<16|(255&e[++d])<<24,++d,u=(65535&u)*s+(((u>>>16)*s&65535)<<16)&4294967295,u=u<<15|u>>>17,u=(65535&u)*l+(((u>>>16)*l&65535)<<16)&4294967295,a^=u,a=a<<13|a>>>19,o=5*(65535&a)+((5*(a>>>16)&65535)<<16)&4294967295,a=27492+(65535&o)+((58964+(o>>>16)&65535)<<16);switch(u=0,r){case 3:u^=(255&e[d+2])<<16;case 2:u^=(255&e[d+1])<<8;case 1:u^=255&e[d],u=(65535&u)*s+(((u>>>16)*s&65535)<<16)&4294967295,u=u<<15|u>>>17,u=(65535&u)*l+(((u>>>16)*l&65535)<<16)&4294967295,a^=u}return a^=e.length,a^=a>>>16,a=2246822507*(65535&a)+((2246822507*(a>>>16)&65535)<<16)&4294967295,a^=a>>>13,a=3266489909*(65535&a)+((3266489909*(a>>>16)&65535)<<16)&4294967295,a^=a>>>16,a>>>0}const r=i;r.v2=function(e,i){"string"==typeof e&&(e=t(e));let r,n=e.length,a=i^n,o=0;for(;n>=4;)r=255&e[o]|(255&e[++o])<<8|(255&e[++o])<<16|(255&e[++o])<<24,r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16),r^=r>>>24,r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16),a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16)^r,n-=4,++o;switch(n){case 3:a^=(255&e[o+2])<<16;case 2:a^=(255&e[o+1])<<8;case 1:a^=255&e[o],a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16)}return a^=a>>>13,a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),a^=a>>>15,a>>>0},r.v3=i,e.exports=r}()}(C);var A,D,L=N(C.exports);function b(e){return e.replace(/(?:^\w|[A-Z]|\b\w)/g,(function(e,t){return 0===t?e.toLowerCase():e.toUpperCase()})).replace(/\s+/g,"")}function k(e){if("number"==typeof e)return!0;const t=parseFloat(String(e));return Number.isFinite(t)&&!isNaN(t)}function U(e){if("number"==typeof e)return e;const t=String(e).split(",");return parseFloat("0"==t[0]?String(e).replace(/,/g,"."):String(e).replace(/,/g,""))}class P{static equals(e,t,i){return Array.isArray(e)?this._returnNegationCheck(-1!==e.indexOf(t),i):I(e)?this._returnNegationCheck(-1!==Object.keys(e).indexOf(String(t)),i):(e=String(e),t=String(t),e=e.valueOf().toLowerCase(),t=t.valueOf().toLowerCase(),this._returnNegationCheck(e===t,i))}static less(e,t,i){return typeof(e=k(e)?U(e):e)==typeof(t=k(t)?U(t):t)&&this._returnNegationCheck(e<t,i)}static lessEqual(e,t,i){return typeof(e=k(e)?U(e):e)==typeof(t=k(t)?U(t):t)&&this._returnNegationCheck(e<=t,i)}static contains(e,t,i){return e=String(e),t=String(t),e=e.valueOf().toLowerCase(),0===(t=t.valueOf().toLowerCase()).replace(/^([\s]*)|([\s]*)$/g,"").length?this._returnNegationCheck(!0,i):this._returnNegationCheck(-1!==e.indexOf(t),i)}static isIn(e,t,i=!1,r="|"){const n=String(e).split(r).map((e=>String(e)));"string"==typeof t&&(t=t.split(r)),Array.isArray(t)||(t=[]),t=t.map((e=>String(e).valueOf().toLowerCase()));for(let e=0;e<n.length;e++)if(-1!==t.indexOf(n[e]))return this._returnNegationCheck(!0,i);return this._returnNegationCheck(!1,i)}static startsWith(e,t,i){return e=String(e).valueOf().toLowerCase(),t=String(t).valueOf().toLowerCase(),this._returnNegationCheck(0===e.indexOf(t),i)}static endsWith(e,t,i){return e=String(e).valueOf().toLowerCase(),t=String(t).valueOf().toLowerCase(),this._returnNegationCheck(-1!==e.indexOf(t,e.length-t.length),i)}static regexMatches(e,t,i){e=String(e).valueOf().toLowerCase(),t=String(t).valueOf();const r=new RegExp(t,"i");return this._returnNegationCheck(r.test(e),i)}static _returnNegationCheck(e,t=!1){return t?!e:e}}A=P,P.equalsNumber=A.equals,P.matches=A.equals;!function(e){e[e.Continue=100]="Continue",e[e.SwitchingProtocols=101]="SwitchingProtocols",e[e.Processing=102]="Processing",e[e.EarlyHints=103]="EarlyHints",e[e.Ok=200]="Ok",e[e.Created=201]="Created",e[e.Accepted=202]="Accepted",e[e.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",e[e.NoContent=204]="NoContent",e[e.ResetContent=205]="ResetContent",e[e.PartialContent=206]="PartialContent",e[e.MultiStatus=207]="MultiStatus",e[e.AlreadyReported=208]="AlreadyReported",e[e.ImUsed=226]="ImUsed",e[e.MultipleChoices=300]="MultipleChoices",e[e.MovedPermanently=301]="MovedPermanently",e[e.Found=302]="Found",e[e.SeeOther=303]="SeeOther",e[e.NotModified=304]="NotModified",e[e.UseProxy=305]="UseProxy",e[e.Unused=306]="Unused",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.PermanentRedirect=308]="PermanentRedirect",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.PaymentRequired=402]="PaymentRequired",e[e.Forbidden=403]="Forbidden",e[e.NotFound=404]="NotFound",e[e.MethodNotAllowed=405]="MethodNotAllowed",e[e.NotAcceptable=406]="NotAcceptable",e[e.ProxyAuthenticationRequired=407]="ProxyAuthenticationRequired",e[e.RequestTimeout=408]="RequestTimeout",e[e.Conflict=409]="Conflict",e[e.Gone=410]="Gone",e[e.LengthRequired=411]="LengthRequired",e[e.PreconditionFailed=412]="PreconditionFailed",e[e.PayloadTooLarge=413]="PayloadTooLarge",e[e.UriTooLong=414]="UriTooLong",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.RangeNotSatisfiable=416]="RangeNotSatisfiable",e[e.ExpectationFailed=417]="ExpectationFailed",e[e.ImATeapot=418]="ImATeapot",e[e.MisdirectedRequest=421]="MisdirectedRequest",e[e.UnprocessableEntity=422]="UnprocessableEntity",e[e.Locked=423]="Locked",e[e.FailedDependency=424]="FailedDependency",e[e.TooEarly=425]="TooEarly",e[e.UpgradeRequired=426]="UpgradeRequired",e[e.PreconditionRequired=428]="PreconditionRequired",e[e.TooManyRequests=429]="TooManyRequests",e[e.RequestHeaderFieldsTooLarge=431]="RequestHeaderFieldsTooLarge",e[e.UnavailableForLegalReasons=451]="UnavailableForLegalReasons",e[e.InternalServerError=500]="InternalServerError",e[e.NotImplemented=501]="NotImplemented",e[e.BadGateway=502]="BadGateway",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.HttpVersionNotSupported=505]="HttpVersionNotSupported",e[e.VariantAlsoNegotiates=506]="VariantAlsoNegotiates",e[e.InsufficientStorage=507]="InsufficientStorage",e[e.LoopDetected=508]="LoopDetected",e[e.NotExtended=510]="NotExtended",e[e.NetworkAuthenticationRequired=511]="NetworkAuthenticationRequired"}(D||(D={}));const F=e=>!["GET","HEAD","DELETE","TRACE","OPTIONS"].includes(e.toUpperCase()),B=(e,t,i)=>{let r="";return I(e)&&!F(t)&&(r="old-nodejs"!==i.runtime?Object.keys(e).map((t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`)).join("&"):i.queryString.stringify(e)),r?`?${r}`:r},x={request(e){var i;const r=(null===(i=null==e?void 0:e.method)||void 0===i?void 0:i.toUpperCase())||"GET",n=(null==e?void 0:e.path)?e.path.startsWith("/")?e.path:`/${e.path}`:"",s=e.baseURL.endsWith("/")?e.baseURL.slice(0,-1):e.baseURL,l=(null==e?void 0:e.responseType)||"json",u=(()=>{if("undefined"!=typeof window)return{runtime:"browser"};if("function"==typeof fetch)return{runtime:"server-with-fetch"};try{const e=require("url"),t=require("http");return{runtime:"old-nodejs",url:e,http:t,https:require("https"),queryString:require("querystring")}}catch(e){}return{runtime:"unknown"}})();return new Promise(((i,d)=>{if("browser"===u.runtime||"server-with-fetch"===u.runtime){const c={method:r,keepalive:!0};(null==e?void 0:e.headers)&&(c.headers=e.headers),(null==e?void 0:e.data)&&F(r)&&(c.body=JSON.stringify(e.data));const g=`${s}${n}${B(null==e?void 0:e.data,r,u)}`;"post"===r.toLowerCase()&&"undefined"!=typeof navigator&&(null===navigator||void 0===navigator?void 0:navigator.sendBeacon)?navigator.sendBeacon(g,c.body)?i({data:!0,status:D.Ok,statusText:o.SEND_BEACON_SUCCESS}):d({message:a.UNSUPPORTED_RESPONSE_TYPE}):fetch(g,c).then((e=>t(this,void 0,void 0,(function*(){if(e.status===D.Ok){const t={status:e.status,statusText:e.statusText,headers:e.headers,data:null};switch(l){case"json":t.data=yield e.json();break;case"arraybuffer":t.data=yield e.arrayBuffer();break;case"text":t.data=e;break;default:return void d({message:a.UNSUPPORTED_RESPONSE_TYPE})}i(t)}else d({message:e.statusText,status:e.status})})))).catch((e=>{d({message:null==e?void 0:e.message,status:null==e?void 0:e.status,statusText:null==e?void 0:e.statusText})}))}else if("old-nodejs"===u.runtime){const t=u.url.parse(s);t.port||(t.port="https:"===t.protocol?"443":"80");const o=t.path.endsWith("/")?t.path.slice(0,-1):t.path,c="https:"===t.protocol?u.https:u.http,g=[],v={hostname:t.hostname,path:`${o}${n}${B(null==e?void 0:e.data,r,u)}`,port:t.port,method:r},h=(null==e?void 0:e.data)&&F(r)?JSON.stringify(e.data):null;(null==e?void 0:e.headers)&&(v.headers=e.headers),h&&(v.headers||(v.headers={}),v.headers["Content-Length"]=Buffer.byteLength(h));const _=c.request(v,(e=>{e.on("data",(e=>g.push(e))),e.on("end",(()=>{if(e.statusCode===D.Ok){const t=Buffer.concat(g),r=t.toString(),n={status:e.statusCode,statusText:e.statusMessage,headers:e.headers,data:null};switch(l){case"json":n.data=r?JSON.parse(r):"";break;case"arraybuffer":n.data=null==t?void 0:t.buffer;break;case"text":n.data=e;break;default:return void d({message:a.UNSUPPORTED_RESPONSE_TYPE})}i(n)}else d({message:e.statusMessage,status:e.statusCode})}))}));_.on("error",(e=>{const t=e;d({message:null==t?void 0:t.message,status:null==t?void 0:t.code,statusText:null==t?void 0:t.statusText})})),h&&_.write(h),_.end()}else d({message:a.UNABLE_TO_PERFORM_NETWORK_REQUEST})}))}};const V={"Content-Type":"application/json"},w="https://cdn-4.convertexperiments.com/api/v1/",j="https://[project_id].metrics.convertexperiments.com/v1/";class G{constructor(e,{eventManager:t,loggerManager:i}={}){var r,n,a,o,s,l,u,d,c,g,v,h;this._configEndpoint=w,this._trackEndpoint=j,this._defaultHeaders=V,this.batchSize=10,this.releaseInterval=1e4,this._loggerManager=i,this._eventManager=t,this._configEndpoint=(null===(n=null===(r=null==e?void 0:e.api)||void 0===r?void 0:r.endpoint)||void 0===n?void 0:n.config)||w,this._trackEndpoint=(null===(o=null===(a=null==e?void 0:e.api)||void 0===a?void 0:a.endpoint)||void 0===o?void 0:o.track)||j,this._data=T(e,"data"),this._enrichData=!T(e,"dataStore"),this._environment=null==e?void 0:e.environment,this._mapper=(null==e?void 0:e.mapper)||(e=>e),this.batchSize=Number(null===(s=null==e?void 0:e.events)||void 0===s?void 0:s.batch_size)||10,this.releaseInterval=Number(null===(l=null==e?void 0:e.events)||void 0===l?void 0:l.release_interval)||1e4,this._accountId=null===(u=this._data)||void 0===u?void 0:u.account_id,this._projectId=null===(c=null===(d=this._data)||void 0===d?void 0:d.project)||void 0===c?void 0:c.id,this._sdkKey=(null==e?void 0:e.sdkKey)||`${this._accountId}/${this._projectId}`,(null==e?void 0:e.sdkKeySecret)&&(this._defaultHeaders.Authorization=`Bearer ${null==e?void 0:e.sdkKeySecret}`),this._trackingEvent={enrichData:this._enrichData,accountId:this._accountId,projectId:this._projectId,visitors:[]},this._trackingEnabled=null===(g=null==e?void 0:e.network)||void 0===g?void 0:g.tracking,this._trackingSource=(null===(v=null==e?void 0:e.network)||void 0===v?void 0:v.source)||"js-sdk",this._cacheLevel=null===(h=null==e?void 0:e.network)||void 0===h?void 0:h.cacheLevel,this._requestsQueue={length:0,items:[],push(e,t,i){const r=this.items.findIndex((t=>t.visitorId===e));if(-1!==r)this.items[r].events.push(t);else{const r={visitorId:e,events:[t]};i&&(r.segments=i),this.items.push(r)}this.length++},reset(){this.items=[],this.length=0}}}request(e,i){return t(this,arguments,void 0,(function*(e,t,i={},r={}){const n=Object.assign(Object.assign({},this._defaultHeaders),r),a={method:e,path:t.route,baseURL:t.base,headers:n,data:i,responseType:"json"};return x.request(a)}))}enqueue(e,t,i){var r,n;null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"ApiManager.enqueue()",this._mapper({eventRequest:t})),this._requestsQueue.push(e,t,i),this._trackingEnabled&&(1===this._requestsQueue.length?this.startQueue():this._requestsQueue.length===this.batchSize&&this.releaseQueue("size").then())}releaseQueue(t){var i,r,n,a;if(!this._requestsQueue.length)return;null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.info)||void 0===r||r.call(i,"ApiManager.releaseQueue()",o.RELEASING_QUEUE),null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"ApiManager.releaseQueue()",{reason:t||""}),this.stopQueue();const s=this._trackingEvent;return s.visitors=this._requestsQueue.items.slice(),s.source=this._trackingSource,this.request("post",{base:this._trackEndpoint.replace("[project_id]",this._projectId.toString()),route:`/track/${this._sdkKey}`},this._mapper(s)).then((i=>{var r,n;this._requestsQueue.reset(),null===(n=null===(r=this._eventManager)||void 0===r?void 0:r.fire)||void 0===n||n.call(r,e.SystemEvents.API_QUEUE_RELEASED,{reason:t,result:i,visitors:s.visitors})})).catch((i=>{var r,n,a,o;null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,"ApiManager.releaseQueue()",{error:i.message}),this.startQueue(),null===(o=null===(a=this._eventManager)||void 0===a?void 0:a.fire)||void 0===o||o.call(a,e.SystemEvents.API_QUEUE_RELEASED,{reason:t},i)}))}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}enableTracking(){this._trackingEnabled=!0,this.releaseQueue("trackingEnabled")}disableTracking(){this._trackingEnabled=!1}setData(e){var t;this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id,this._trackingEvent.accountId=this._accountId,this._trackingEvent.projectId=this._projectId}getConfig(){var e,t;null===(t=null===(e=this._loggerManager)||void 0===e?void 0:e.trace)||void 0===t||t.call(e,"ApiManager.getConfig()");let i="low"===this._cacheLevel||this._environment?"?":"";return this._environment&&(i+=`environment=${this._environment}`),"low"===this._cacheLevel&&(i+="_conv_low_cache=1"),new Promise(((e,t)=>{this.request("get",{base:this._configEndpoint,route:`/config/${this._sdkKey}${i}`}).then((({data:t})=>e(t))).catch(t)}))}}class K{constructor(e,{loggerManager:t}={}){var i,r,n,a;this._max_traffic=1e4,this._hash_seed=9999,this._loggerManager=t,this._max_traffic=(null===(i=null==e?void 0:e.bucketing)||void 0===i?void 0:i.max_traffic)||1e4,this._hash_seed=(null===(r=null==e?void 0:e.bucketing)||void 0===r?void 0:r.hash_seed)||9999,null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"BucketingManager()",o.BUCKETING_CONSTRUCTOR,this)}selectBucket(e,t,i=0){var r,n;let a=null,o=0;return Object.keys(e).some((r=>(o+=100*e[r]+i,t<o&&(a=r,!0)))),null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.debug)||void 0===n||n.call(r,"BucketingManager.selectBucket()",{buckets:e,value:t,redistribute:i},{variation:a}),a||null}getValueVisitorBased(e,t){var i,r;const{seed:n=this._hash_seed,experienceId:a=""}=t||{},o=function(e,t=9999){return L.v3(String(e),t)}(a+String(e),n),s=o/4294967296*this._max_traffic,l=parseInt(String(s),10);return null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.debug)||void 0===r||r.call(i,"BucketingManager.getValueVisitorBased()",{visitorId:e,seed:n,experienceId:a,val:s,result:l}),l}getBucketForVisitor(e,t,i){const r=this.getValueVisitorBased(t,i),n=this.selectBucket(e,r,null==i?void 0:i.redistribute);return n?{variationId:n,bucketingAllocation:r}:null}}class q{constructor(e,t,{eventManager:i,experienceManager:r,featureManager:n,segmentsManager:a,dataManager:o,apiManager:s,loggerManager:l},u){if(this._environment=null==e?void 0:e.environment,this._visitorId=t,this._config=e,this._eventManager=i,this._experienceManager=r,this._featureManager=n,this._dataManager=o,this._segmentsManager=a,this._apiManager=s,this._loggerManager=l,I(u)){const{properties:e}=this._dataManager.filterReportSegments(u);e&&(this._visitorProperties=e),a.putSegments(t,u)}}runExperience(t,i){var r,n;if(!this._visitorId)return void(null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,"Context.runExperience()",a.VISITOR_ID_REQUIRED));const o=this.getVisitorProperties(null==i?void 0:i.visitorProperties),s=this._experienceManager.selectVariation(this._visitorId,t,{visitorProperties:o,locationProperties:null==i?void 0:i.locationProperties,updateVisitorProperties:null==i?void 0:i.updateVisitorProperties,environment:(null==i?void 0:i.environment)||this._environment});return Object.values(e.RuleError).includes(s)||Object.values(e.BucketingError).includes(s)||s&&this._eventManager.fire(e.SystemEvents.BUCKETING,{visitorId:this._visitorId,experienceKey:t,variationKey:s.key},null,!0),s}runExperiences(t){var i,r;if(!this._visitorId)return void(null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"Context.runExperiences()",a.VISITOR_ID_REQUIRED));const n=this.getVisitorProperties(null==t?void 0:t.visitorProperties),o=this._experienceManager.selectVariations(this._visitorId,{visitorProperties:n,locationProperties:null==t?void 0:t.locationProperties,updateVisitorProperties:null==t?void 0:t.updateVisitorProperties,environment:(null==t?void 0:t.environment)||this._environment}),s=o.filter((t=>Object.values(e.RuleError).includes(t)));if(s.length)return s;const l=o.filter((t=>Object.values(e.BucketingError).includes(t)));return l.length?l:(o.forEach((({experienceKey:t,key:i})=>{this._eventManager.fire(e.SystemEvents.BUCKETING,{visitorId:this._visitorId,experienceKey:t,variationKey:i},null,!0)})),o)}runFeature(t,i){var r,n;if(!this._visitorId)return void(null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,"Context.runFeature()",a.VISITOR_ID_REQUIRED));const o=this.getVisitorProperties(null==i?void 0:i.visitorProperties),s=this._featureManager.runFeature(this._visitorId,t,{visitorProperties:o,locationProperties:null==i?void 0:i.locationProperties,updateVisitorProperties:null==i?void 0:i.updateVisitorProperties,typeCasting:!Object.prototype.hasOwnProperty.call(i||{},"typeCasting")||i.typeCasting,environment:(null==i?void 0:i.environment)||this._environment},null==i?void 0:i.experienceKeys);if(Array.isArray(s)){const i=s.filter((t=>Object.values(e.RuleError).includes(t)));if(i.length)return i;s.forEach((({experienceKey:i,status:r})=>{this._eventManager.fire(e.SystemEvents.BUCKETING,{visitorId:this._visitorId,experienceKey:i,featureKey:t,status:r},null,!0)}))}else{if(Object.values(e.RuleError).includes(s))return s;s&&this._eventManager.fire(e.SystemEvents.BUCKETING,{visitorId:this._visitorId,experienceKey:s.experienceKey,featureKey:t,status:s.status},null,!0)}return s}runFeatures(t){var i,r;if(!this._visitorId)return void(null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"Context.runFeatures()",a.VISITOR_ID_REQUIRED));const n=this.getVisitorProperties(null==t?void 0:t.visitorProperties),o=this._featureManager.runFeatures(this._visitorId,{visitorProperties:n,locationProperties:null==t?void 0:t.locationProperties,updateVisitorProperties:null==t?void 0:t.updateVisitorProperties,typeCasting:!Object.prototype.hasOwnProperty.call(t||{},"typeCasting")||t.typeCasting,environment:(null==t?void 0:t.environment)||this._environment}),s=o.filter((t=>Object.values(e.RuleError).includes(t)));return s.length?s:(o.forEach((({experienceKey:t,key:i,status:r})=>{this._eventManager.fire(e.SystemEvents.BUCKETING,{visitorId:this._visitorId,experienceKey:t,featureKey:i,status:r},null,!0)})),o)}trackConversion(t,i){var r,n,o,s;if(!this._visitorId)return void(null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,"Context.trackConversion()",a.VISITOR_ID_REQUIRED));const l=null==i?void 0:i.ruleData,u=null==i?void 0:i.conversionData;if(u&&!Array.isArray(u))return void(null===(s=null===(o=this._loggerManager)||void 0===o?void 0:o.error)||void 0===s||s.call(o,"Context.trackConversion()",a.GOAL_DATA_NOT_VALID));const d=this._segmentsManager.getSegments(this._visitorId),c=this._dataManager.convert(this._visitorId,t,l,u,d,null==i?void 0:i.conversionSetting);if(Object.values(e.RuleError).includes(c))return c;c&&this._eventManager.fire(e.SystemEvents.CONVERSION,{visitorId:this._visitorId,goalKey:t},null,!0)}setDefaultSegments(e){this._segmentsManager.putSegments(this._visitorId,e)}setCustomSegments(e,t){return this.runCustomSegments(e,t)}runCustomSegments(e,t){var i,r;if(!this._visitorId)return void(null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"Context.runCustomSegments()",a.VISITOR_ID_REQUIRED));const n=this.getVisitorProperties(null==t?void 0:t.ruleData),o=this._segmentsManager.selectCustomSegments(this._visitorId,e,n);return o||void 0}updateVisitorProperties(e,t){this._dataManager.putData(e,{segments:t})}getConfigEntity(t,i){if(i===e.EntityType.VARIATION){const i=this._dataManager.getEntitiesList(e.EntityType.EXPERIENCE);for(const{key:e}of i){const i=this._dataManager.getSubItem("experiences",e,"variations",t,"key","key");if(i)return i}}return this._dataManager.getEntity(t,i)}getConfigEntityById(t,i){if(i===e.EntityType.VARIATION){const i=this._dataManager.getEntitiesList(e.EntityType.EXPERIENCE);for(const{id:e}of i){const i=this._dataManager.getSubItem("experiences",e,"variations",t,"id","id");if(i)return i}}return this._dataManager.getEntityById(t,i)}getVisitorData(){return this._dataManager.getData(this._visitorId)||{}}releaseQueues(e){return this._dataManager.dataStoreManager&&this._dataManager.dataStoreManager.releaseQueue(e),this._apiManager.releaseQueue(e)}getVisitorProperties(e){const{segments:t}=this._dataManager.getData(this._visitorId)||{},i=e?R(this._visitorProperties||{},e):this._visitorProperties;return R(t||{},i||{})}}class H{constructor(e,{dataManager:t,eventManager:i,experienceManager:r,featureManager:n,segmentsManager:a,apiManager:s,loggerManager:l}){var u,d;this._initialized=!1,this._environment=null==e?void 0:e.environment,this._dataManager=t,this._eventManager=i,this._experienceManager=r,this._featureManager=n,this._loggerManager=l,this._segmentsManager=a,this._dataManager=t,this._eventManager=i,this._apiManager=s,this._loggerManager=l,null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.trace)||void 0===d||d.call(u,"Core()",o.CORE_CONSTRUCTOR,this),this.initialize(e)}initialize(t){var i,r,n,s,l,u,d;t&&(this._config=t,Object.prototype.hasOwnProperty.call(t,"sdkKey")&&(null===(i=t.sdkKey)||void 0===i?void 0:i.length)?this.fetchConfig():Object.prototype.hasOwnProperty.call(t,"data")?(this.data=t.data,this._dataManager.data=t.data,t.data.error?null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,"Core.initialize()",{error:t.data.error}):(this._eventManager.fire(e.SystemEvents.READY,null,null,!0),null===(l=null===(s=this._loggerManager)||void 0===s?void 0:s.trace)||void 0===l||l.call(s,"Core.initialize()",o.CORE_INITIALIZED),this._initialized=!0)):(null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.error)||void 0===d||d.call(u,"Core.initialize()",a.SDK_OR_DATA_OBJECT_REQUIRED),this._eventManager.fire(e.SystemEvents.READY,{},new Error(a.SDK_OR_DATA_OBJECT_REQUIRED),!0)))}createContext(e,t){return this._initialized?new q(this._config,e,{eventManager:this._eventManager,experienceManager:this._experienceManager,featureManager:this._featureManager,segmentsManager:this._segmentsManager,apiManager:this._apiManager,dataManager:this._dataManager,loggerManager:this._loggerManager},t):null}on(e,t){this._eventManager.on(e,t)}onReady(){return t(this,void 0,void 0,(function*(){return yield this._promise,new Promise(((e,t)=>{I(this._dataManager.data)?e():t(new Error(a.DATA_OBJECT_MISSING))}))}))}fetchConfig(){return t(this,void 0,void 0,(function*(){var t,i,r,n,a,s,l,u,d,c,g;this._promise=this._apiManager.getConfig();try{const c=yield this._promise;c.error?(this._dataManager.data=c,null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.error)||void 0===i||i.call(t,"Core.fetchConfig()",{error:c.error})):(null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"Core.fetchConfig()",{data:c}),this._eventManager.fire(I(this._dataManager.data)?e.SystemEvents.CONFIG_UPDATED:e.SystemEvents.READY,null,null,!0),I(this._dataManager.data)?null===(s=null===(a=this._loggerManager)||void 0===a?void 0:a.trace)||void 0===s||s.call(a,"Core.fetchConfig()",o.CONFIG_DATA_UPDATED):(null===(u=null===(l=this._loggerManager)||void 0===l?void 0:l.trace)||void 0===u||u.call(l,"Core.fetchConfig()",o.CORE_INITIALIZED),this._initialized=!0),this.data=c,this._dataManager.data=c,this._apiManager.setData(c)),this._fetchConfigTimerID&&clearTimeout(this._fetchConfigTimerID),this._fetchConfigTimerID=setTimeout((()=>this.fetchConfig()),(null===(d=this._config)||void 0===d?void 0:d.dataRefreshInterval)||3e5)}catch(e){null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.error)||void 0===g||g.call(c,"Core.fetchConfig()",{error:e.message})}}))}}const Q="permanent",$="all",W="running",z="bucketing",Y="conversion";class J{constructor(e,{dataStore:t,eventManager:i,loggerManager:r}={}){var n,a;this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=r,this._eventManager=i,this.batchSize=Number(null===(n=null==e?void 0:e.events)||void 0===n?void 0:n.batch_size)||1,this.releaseInterval=Number(null===(a=null==e?void 0:e.events)||void 0===a?void 0:a.release_interval)||5e3,this.dataStore=t,this._mapper=(null==e?void 0:e.mapper)||(e=>e),this._requestsQueue={}}set(e,t){var i,r,n,a;try{null===(r=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===r||r.call(i,e,t)}catch(e){null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===a||a.call(n,"DataStoreManager.set()",{error:e.message})}}get(e){var t,i,r,n;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.error)||void 0===n||n.call(r,"DataStoreManager.get()",{error:e.message})}return null}enqueue(e,t){var i,r;null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"DataStoreManager.enqueue()",this._mapper({key:e,data:t}));const n={};n[e]=t,this._requestsQueue=R(this._requestsQueue,n),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()}releaseQueue(t){var i,r,n,a;null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.info)||void 0===r||r.call(i,"DataStoreManager.releaseQueue()",{reason:t||""}),this.stopQueue();for(const e in this._requestsQueue)this.set(e,this._requestsQueue[e]);null===(a=null===(n=this._eventManager)||void 0===n?void 0:n.fire)||void 0===a||a.call(n,e.SystemEvents.DATA_STORE_QUEUE_RELEASED,{reason:t||""})}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}set dataStore(e){var t,i;e&&(this.isValidDataStore(e)?this._dataStore=e:null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.error)||void 0===i||i.call(t,"DataStoreManager.dataStore.set()",a.DATA_STORE_NOT_VALID))}get dataStore(){return this._dataStore}isValidDataStore(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set}}class X{constructor(e,{bucketingManager:t,ruleManager:i,eventManager:n,apiManager:a,loggerManager:s},{asyncStorage:l=!0}={}){var u,d,c,g,v;this._dataEntities=r,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==e?void 0:e.environment,this._apiManager=a,this._bucketingManager=t,this._ruleManager=i,this._loggerManager=s,this._eventManager=n,this._config=e,this._mapper=(null==e?void 0:e.mapper)||(e=>e),this._asyncStorage=l,this._data=T(e,"data"),this._accountId=null===(u=this._data)||void 0===u?void 0:u.account_id,this._projectId=null===(c=null===(d=this._data)||void 0===d?void 0:d.project)||void 0===c?void 0:c.id,this.dataStoreManager=null==e?void 0:e.dataStore,null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.trace)||void 0===v||v.call(g,"DataManager()",o.DATA_CONSTRUCTOR,this)}set data(e){var t,i,r;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id):null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===r||r.call(i,"DataManager.data.set()",a.CONFIG_DATA_NOT_VALID)}get data(){return this._data}set dataStoreManager(e){this._dataStoreManager=null,e&&(this._dataStoreManager=new J(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager}))}get dataStoreManager(){return this._dataStoreManager}setDataStore(e){this._dataStoreManager=null,e&&(this._dataStoreManager=new J(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager}))}matchRulesByField(t,i,r="key",n){var a,s,l,u,d,c,g,v,h,_,p,E,f,M,y,O,m,T,R,I,S,N,C,A,D,L,b,k,U;const{visitorProperties:P,locationProperties:F,ignoreLocationProperties:B,environment:x=this._environment}=n;null===(s=null===(a=this._loggerManager)||void 0===a?void 0:a.trace)||void 0===s||s.call(a,"DataManager.matchRulesByField()",this._mapper({visitorId:t,identity:i,identityField:r,visitorProperties:P,locationProperties:F,ignoreLocationProperties:B,environment:x}));const V=this._getEntityByField(i,"experiences",r);if(!V)return null===(u=null===(l=this._loggerManager)||void 0===l?void 0:l.debug)||void 0===u||u.call(l,"DataManager.matchRulesByField()",o.EXPERIENCE_NOT_FOUND,this._mapper({identity:i,identityField:r})),null;if(!!this.getEntitiesList("archived_experiences").find((e=>String(null==V?void 0:V.id)===String(e))))return null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.debug)||void 0===c||c.call(d,"DataManager.matchRulesByField()",o.EXPERIENCE_ARCHIVED,this._mapper({identity:i,identityField:r})),null;if(!(!(null==V?void 0:V.environment)||V.environment===x))return null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.debug)||void 0===v||v.call(g,"DataManager.matchRulesByField()",o.EXPERIENCE_ENVIRONMENT_NOT_MATCH,this._mapper({identity:i,identityField:r})),null;let w=[];const{bucketing:j}=this.getData(t)||{},{[V.id.toString()]:G}=j||{};let K=!1;G&&this.retrieveVariation(V.id,String(G))&&(K=!0);let q=!0===B;if(!q&&F)if(Array.isArray(null==V?void 0:V.locations)&&V.locations.length){let i=[];const n=this.getItemsByIds(V.locations,"locations");if(n.length&&(i=this.selectLocations(t,n,{locationProperties:F,identityField:r}),w=i.filter((t=>Object.values(e.RuleError).includes(t))),w.length))return w[0];q=Boolean(i.length)}else if(null==V?void 0:V.site_area){if(q=this._ruleManager.isRuleMatched(F,V.site_area,"SiteArea"),Object.values(e.RuleError).includes(q))return q}else q=!0,null===(_=null===(h=this._loggerManager)||void 0===h?void 0:h.info)||void 0===_||_.call(h,"DataManager.matchRulesByField()",o.LOCATION_NOT_RESTRICTED);if(!q)return null===(E=null===(p=this._loggerManager)||void 0===p?void 0:p.debug)||void 0===E||E.call(p,"DataManager.matchRulesByField()",o.LOCATION_NOT_MATCH,this._mapper({locationProperties:F,[(null==V?void 0:V.locations)?"experiences[].variations[].locations":"experiences[].variations[].site_area"]:(null==V?void 0:V.locations)||(null==V?void 0:V.site_area)||""})),null;let H=[],W=[],z=[],Y=[],J=[],X=!1,Z=!1;if(P)if(Array.isArray(null==V?void 0:V.audiences)&&V.audiences.length)if(H=this.getItemsByIds(V.audiences,"audiences"),J=H.filter((e=>!(K&&e.type===Q))),J.length){if(z=this.filterMatchedRecordsWithRule(J,P,"audience",r),w=z.filter((t=>Object.values(e.RuleError).includes(t))),w.length)return w[0];if(z.length)for(const e of z)null===(M=null===(f=this._loggerManager)||void 0===f?void 0:f.info)||void 0===M||M.call(f,"DataManager.matchRulesByField()",o.AUDIENCE_MATCH.replace("#",null==e?void 0:e[r]));X=V.settings.matching_options.audiences===$?Boolean(z.length===J.length):Boolean(z.length)}else X=!0,null===(O=null===(y=this._loggerManager)||void 0===y?void 0:y.info)||void 0===O||O.call(y,"DataManager.matchRulesByField()",o.NON_PERMANENT_AUDIENCE_NOT_RESTRICTED);else X=!0,null===(T=null===(m=this._loggerManager)||void 0===m?void 0:m.info)||void 0===T||T.call(m,"DataManager.matchRulesByField()",o.AUDIENCE_NOT_RESTRICTED);if(W=this.getItemsByIds(V.audiences,"segments"),W.length){if(Y=this.filterMatchedCustomSegments(W,t),Y.length)for(const e of Y)null===(I=null===(R=this._loggerManager)||void 0===R?void 0:R.info)||void 0===I||I.call(R,"DataManager.matchRulesByField()",o.SEGMENTATION_MATCH.replace("#",null==e?void 0:e[r]));Z=Boolean(Y.length)}else Z=!0,null===(N=null===(S=this._loggerManager)||void 0===S?void 0:S.info)||void 0===N||N.call(S,"DataManager.matchRulesByField()",o.SEGMENTATION_NOT_RESTRICTED);if(X&&Z){if((null==V?void 0:V.variations)&&(null===(C=null==V?void 0:V.variations)||void 0===C?void 0:C.length))return null===(D=null===(A=this._loggerManager)||void 0===A?void 0:A.info)||void 0===D||D.call(A,"DataManager.matchRulesByField()",o.EXPERIENCE_RULES_MATCHED),V;null===(b=null===(L=this._loggerManager)||void 0===L?void 0:L.debug)||void 0===b||b.call(L,"DataManager.matchRulesByField()",o.VARIATIONS_NOT_FOUND,this._mapper({visitorProperties:P,audiences:H}))}else null===(U=null===(k=this._loggerManager)||void 0===k?void 0:k.debug)||void 0===U||U.call(k,"DataManager.matchRulesByField()",o.AUDIENCE_NOT_MATCH,this._mapper({visitorProperties:P,audiences:H}));return null}_getBucketingByField(t,i,r="key",n){var a,o;const{visitorProperties:s,locationProperties:l,updateVisitorProperties:u,forceVariationId:d,enableTracking:c=!0,ignoreLocationProperties:g,environment:v=this._environment}=n;null===(o=null===(a=this._loggerManager)||void 0===a?void 0:a.trace)||void 0===o||o.call(a,"DataManager._getBucketingByField()",this._mapper({visitorId:t,identity:i,identityField:r,visitorProperties:s,locationProperties:l,forceVariationId:d,enableTracking:c,ignoreLocationProperties:g,environment:v}));const h=this.matchRulesByField(t,i,r,{visitorProperties:s,locationProperties:l,ignoreLocationProperties:g,environment:v});return h?Object.values(e.RuleError).includes(h)?h:this._retrieveBucketing(t,s,u,h,d,c):null}_retrieveBucketing(t,i,r,n,s,l=!0){var u,d,c,g,v,h,_,p,E,f,M,y,O,m,T,R,I;if(!t||!n)return null;if(!(null==n?void 0:n.id))return null;let S,N,C=null,A=null;const D=this.getStoreKey(t);s&&(C=this.retrieveVariation(n.id,String(s)))&&(S=s,null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.info)||void 0===d||d.call(u,"DataManager._retrieveBucketing()",o.BUCKETED_VISITOR_FORCED.replace("#",`#${s}`)),null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.debug)||void 0===g||g.call(c,"DataManager._retrieveBucketing()",this._mapper({storeKey:D,visitorId:t,variationId:s})));const{bucketing:L,segments:b}=this.getData(t)||{},{[n.id.toString()]:k}=L||{};if(!k||S&&String(S)!==String(k)||!(C=this.retrieveVariation(n.id,String(k)))){const s=n.variations.filter((e=>!(null==e?void 0:e.status)||e.status===W)).filter((e=>(null==e?void 0:e.traffic_allocation)>0||isNaN(null==e?void 0:e.traffic_allocation))).reduce(((e,t)=>((null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e)),{}),u=this._bucketingManager.getBucketForVisitor(s,t,(null===(f=null===(E=this._config)||void 0===E?void 0:E.bucketing)||void 0===f?void 0:f.excludeExperienceIdHash)?null:{experienceId:n.id.toString()});if(S=S||(null==u?void 0:u.variationId),N=null==u?void 0:u.bucketingAllocation,!S)return null===(y=null===(M=this._loggerManager)||void 0===M?void 0:M.debug)||void 0===y||y.call(M,"DataManager._retrieveBucketing()",a.UNABLE_TO_SELECT_BUCKET_FOR_VISITOR,this._mapper({visitorId:t,experience:n,buckets:s,bucketing:u})),e.BucketingError.VARIAION_NOT_DECIDED;if(null===(m=null===(O=this._loggerManager)||void 0===O?void 0:O.info)||void 0===m||m.call(O,"DataManager._retrieveBucketing()",o.BUCKETED_VISITOR.replace("#",`#${S}`)),r?this.putData(t,Object.assign({bucketing:{[n.id.toString()]:S}},i?{segments:i}:{})):this.putData(t,{bucketing:{[n.id.toString()]:S}}),l){const e={experienceId:n.id.toString(),variationId:S.toString()},r={eventType:z,data:e},a=this._ruleManager.isUsingCustomInterface(i)?(null===(T=null==i?void 0:i.get)||void 0===T?void 0:T.call(i))||{}:b;this._apiManager.enqueue(t,r,a),null===(I=null===(R=this._loggerManager)||void 0===R?void 0:R.trace)||void 0===I||I.call(R,"DataManager._retrieveBucketing()",this._mapper({visitorEvent:r}))}C=this.retrieveVariation(n.id,String(S))}else S=k,null===(h=null===(v=this._loggerManager)||void 0===v?void 0:v.info)||void 0===h||h.call(v,"DataManager._retrieveBucketing()",o.BUCKETED_VISITOR_FOUND.replace("#",`#${S}`)),null===(p=null===(_=this._loggerManager)||void 0===_?void 0:_.debug)||void 0===p||p.call(_,"DataManager._retrieveBucketing()",this._mapper({storeKey:D,visitorId:t,variationId:S}));return C&&(A=Object.assign(Object.assign({experienceId:null==n?void 0:n.id,experienceName:null==n?void 0:n.name,experienceKey:null==n?void 0:n.key},{bucketingAllocation:N}),C)),A}retrieveVariation(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")}reset(){this._bucketedVisitors=new Map}putData(e,t={}){const i=this.getStoreKey(e),r=this.getData(e)||{};if(!S(r,t)){const e=R(r,t);if(this._bucketedVisitors.set(i,e),this._bucketedVisitors.size>this._localStoreLimit)for(const[e]of this._bucketedVisitors){this._bucketedVisitors.delete(e);break}if(this.dataStoreManager){const{segments:n={}}=r,a=function(e,t){var i={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(r=Object.getOwnPropertySymbols(e);n<r.length;n++)t.indexOf(r[n])<0&&Object.prototype.propertyIsEnumerable.call(e,r[n])&&(i[r[n]]=e[r[n]])}return i}(r,["segments"]),{segments:o={}}=this.filterReportSegments(n),{segments:s}=this.filterReportSegments((null==t?void 0:t.segments)||{});s?this._asyncStorage?this.dataStoreManager.enqueue(i,R(a,{segments:Object.assign(Object.assign({},o),s)})):this.dataStoreManager.set(i,R(a,{segments:Object.assign(Object.assign({},o),s)})):this._asyncStorage?this.dataStoreManager.enqueue(i,e):this.dataStoreManager.set(i,e)}}}getData(e){const t=this.getStoreKey(e),i=this._bucketedVisitors.get(t)||null;return this.dataStoreManager?R(i||{},this.dataStoreManager.get(t)||{}):i}getStoreKey(e){return`${this._accountId}-${this._projectId}-${e}`}selectLocations(t,i,r){var n,a,s,l,u,d,c,g,v,h,_,p,E,f,M,y,O,T,R,I;const{locationProperties:S,identityField:N="key",forceEvent:C}=r;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"DataManager.selectLocations()",this._mapper({items:i,locationProperties:S}));const{locations:A=[]}=this.getData(t)||{},D=[];let L;if(m(i))for(let r=0,n=i.length;r<n;r++){if(!(null===(s=null==i?void 0:i[r])||void 0===s?void 0:s.rules))continue;L=this._ruleManager.isRuleMatched(S,i[r].rules,`ConfigLocation #${i[r][N]}`);const n=null===(d=null===(u=null===(l=null==i?void 0:i[r])||void 0===l?void 0:l[N])||void 0===u?void 0:u.toString)||void 0===d?void 0:d.call(u);if(!0===L)null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.info)||void 0===g||g.call(c,"DataManager.selectLocations()",o.LOCATION_MATCH.replace("#",`#${n}`)),A.includes(n)&&!C||(this._eventManager.fire(e.SystemEvents.LOCATION_ACTIVATED,{visitorId:t,location:{id:null===(v=null==i?void 0:i[r])||void 0===v?void 0:v.id,key:null===(h=null==i?void 0:i[r])||void 0===h?void 0:h.key,name:null===(_=null==i?void 0:i[r])||void 0===_?void 0:_.name}},null,!0),null===(E=null===(p=this._loggerManager)||void 0===p?void 0:p.info)||void 0===E||E.call(p,"DataManager.selectLocations()",o.LOCATION_ACTIVATED.replace("#",`#${n}`))),A.includes(n)||A.push(n),D.push(i[r]);else if(!1!==L)D.push(L);else if(!1===L&&A.includes(n)){this._eventManager.fire(e.SystemEvents.LOCATION_DEACTIVATED,{visitorId:t,location:{id:null===(f=null==i?void 0:i[r])||void 0===f?void 0:f.id,key:null===(M=null==i?void 0:i[r])||void 0===M?void 0:M.key,name:null===(y=null==i?void 0:i[r])||void 0===y?void 0:y.name}},null,!0);const a=A.findIndex((e=>e===n));A.splice(a,1),null===(T=null===(O=this._loggerManager)||void 0===O?void 0:O.info)||void 0===T||T.call(O,"DataManager.selectLocations()",o.LOCATION_DEACTIVATED.replace("#",`#${n}`))}}return this.putData(t,{locations:A}),null===(I=null===(R=this._loggerManager)||void 0===R?void 0:R.debug)||void 0===I||I.call(R,"DataManager.selectLocations()",this._mapper({matchedRecords:D})),D}getBucketing(e,t,i){return this._getBucketingByField(e,t,"key",i)}getBucketingById(e,t,i){return this._getBucketingByField(e,t,"id",i)}convert(t,r,n,a,s,l){var u,d,c,g,v,h;const _="string"==typeof r?this.getEntity(r,"goals"):this.getEntityById(r,"goals");if(!(null==_?void 0:_.id))return void(null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.error)||void 0===d||d.call(u,"DataManager.convert()",o.GOAL_NOT_FOUND));if(n){if(!(null==_?void 0:_.rules))return;const t=this._ruleManager.isRuleMatched(n,_.rules,`ConfigGoal #${r}`);if(Object.values(e.RuleError).includes(t))return t;if(!t)return void(null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.error)||void 0===g||g.call(c,"DataManager.convert()",o.GOAL_RULE_NOT_MATCH))}const p=null==l?void 0:l[i.FORCE_MULTIPLE_TRANSACTIONS],{bucketing:E,goals:{[r.toString()]:f}={}}=this.getData(t)||{};if(!f||(null===(h=null===(v=this._loggerManager)||void 0===v?void 0:v.debug)||void 0===h||h.call(v,"DataManager.convert()",o.GOAL_FOUND.replace("#",r.toString()),this._mapper({visitorId:t,goalId:r})),p))return this.putData(t,{goals:{[r.toString()]:!0}}),f||function(){var e,i;const r={goalId:_.id};E&&(r.bucketingData=E);const n={eventType:Y,data:r};this._apiManager.enqueue(t,n,s),null===(i=null===(e=this._loggerManager)||void 0===e?void 0:e.trace)||void 0===i||i.call(e,"DataManager.convert()",this._mapper({event:n}))}.call(this),!a||f&&!p||function(){var e,i;const r={goalId:_.id,goalData:a};E&&(r.bucketingData=E);const n={eventType:Y,data:r};this._apiManager.enqueue(t,n,s),null===(i=null===(e=this._loggerManager)||void 0===e?void 0:e.trace)||void 0===i||i.call(e,"DataManager.convert()",this._mapper({event:n}))}.call(this),!0}filterMatchedRecordsWithRule(e,t,i,r="id"){var n,a,o,s,l;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"DataManager.filterMatchedRecordsWithRule()",this._mapper({items:e,visitorProperties:t}));const u=[];let d;if(m(e))for(let n=0,a=e.length;n<a;n++)(null===(o=null==e?void 0:e[n])||void 0===o?void 0:o.rules)&&(d=this._ruleManager.isRuleMatched(t,e[n].rules,`${b(i)} #${e[n][r]}`),!0===d?u.push(e[n]):!1!==d&&u.push(d));return null===(l=null===(s=this._loggerManager)||void 0===s?void 0:s.debug)||void 0===l||l.call(s,"DataManager.filterMatchedRecordsWithRule()",this._mapper({matchedRecords:u})),u}filterMatchedCustomSegments(e,t){var i,r,n,a,o;null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"DataManager.filterMatchedCustomSegments()",this._mapper({items:e,visitorId:t}));const{segments:{[M.CUSTOM_SEGMENTS]:s=[]}={}}=this.getData(t)||{},l=[];if(m(e))for(let t=0,i=e.length;t<i;t++)(null===(n=null==e?void 0:e[t])||void 0===n?void 0:n.id)&&s.includes(e[t].id)&&l.push(e[t]);return null===(o=null===(a=this._loggerManager)||void 0===a?void 0:a.debug)||void 0===o||o.call(a,"DataManager.filterMatchedCustomSegments()",this._mapper({matchedRecords:l})),l}filterReportSegments(e){const t=Object.values(M).map((e=>e)),i={},r={};for(const n in e)t.includes(n)?i[n]=e[n]:r[n]=e[n];return{properties:Object.keys(r).length?r:null,segments:Object.keys(i).length?i:null}}getEntitiesList(e){var t,i;let r=[];const a=n[e]||e;return-1!==this._dataEntities.indexOf(a)&&(r=T(this._data,a)||[]),null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===i||i.call(t,"DataManager.getEntitiesList()",this._mapper({entityType:a,list:r})),r}getEntitiesListObject(e,t="id"){return this.getEntitiesList(e).reduce(((e,i)=>(e[i[t]]=i,e)),{})}_getEntityByField(e,t,i="key"){var r,a,o;const s=n[t]||t;null===(a=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===a||a.call(r,"DataManager._getEntityByField()",this._mapper({identity:e,entityType:s,identityField:i}));const l=this.getEntitiesList(s);if(m(l))for(let t=0,r=l.length;t<r;t++)if(l[t]&&String(null===(o=l[t])||void 0===o?void 0:o[i])===String(e))return l[t];return null}getEntity(e,t){return this._getEntityByField(e,t,"key")}getEntities(e,t){return this.getItemsByKeys(e,t)}getEntityById(e,t){return this._getEntityByField(e,t,"id")}getEntitiesByIds(e,t){return this.getItemsByIds(e,t)}getItemsByKeys(e,t){var i;const r=this.getEntitiesList(t),n=[];if(m(r))for(let t=0,a=r.length;t<a;t++)-1!==e.indexOf(null===(i=r[t])||void 0===i?void 0:i.key)&&n.push(r[t]);return n}getItemsByIds(e,t){var i,r,n;null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"DataManager.getItemsByIds()",this._mapper({ids:e,path:t}));const a=[];if(m(e)){const i=this.getEntitiesList(t);if(m(i))for(let t=0,r=i.length;t<r;t++)-1!==e.indexOf(null===(n=i[t])||void 0===n?void 0:n.id)&&a.push(i[t])}return a}getSubItem(e,t,i,r,n,a){const o=this._getEntityByField(t,e,n);for(const e of o[i])if(e[a]===r)return e;return null}isValidConfigData(e){var t;return I(e)&&(!!(null==e?void 0:e.account_id)&&!!(null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id)||Boolean(e.error))}}class Z{constructor(e,{loggerManager:t}={}){this._listeners={},this._deferred={},this._loggerManager=t,this._mapper=(null==e?void 0:e.mapper)||(e=>e)}on(e,t){var i,r;(this._listeners[e]=this._listeners[e]||[]).push(t),null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"EventManager.on()",{event:e}),Object.hasOwnProperty.call(this._deferred,e)&&this.fire(e,this._deferred[e].args,this._deferred[e].err)}removeListeners(e){Object.hasOwnProperty.call(this._listeners,e)&&delete this._listeners[e],Object.hasOwnProperty.call(this._deferred,e)&&delete this._deferred[e]}fire(e,t=null,i=null,r=!1){var n,a,o,s;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.debug)||void 0===a||a.call(n,"EventManager.fire()",this._mapper({event:e,args:t,err:i,deferred:r}));for(const r of this._listeners[e]||[])if(Object.hasOwnProperty.call(this._listeners,e)&&"function"==typeof r)try{r.apply(null,[this._mapper(t),i])}catch(e){null===(s=null===(o=this._loggerManager)||void 0===o?void 0:o.error)||void 0===s||s.call(o,"EventManager.fire()",e)}r&&!Object.hasOwnProperty.call(this._deferred,e)&&(this._deferred[e]={args:t,err:i})}}class ee{constructor(e,{dataManager:t,loggerManager:i}){var r,n;this._dataManager=t,this._loggerManager=i,null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"ExperienceManager()",o.EXPERIENCE_CONSTRUCTOR)}getList(){return this._dataManager.getEntitiesList("experiences")}getExperience(e){return this._dataManager.getEntity(e,"experiences")}getExperienceById(e){return this._dataManager.getEntityById(e,"experiences")}getExperiences(e){return this._dataManager.getItemsByKeys(e,"experiences")}selectVariation(e,t,i){return this._dataManager.getBucketing(e,t,i)}selectVariationById(e,t,i){return this._dataManager.getBucketingById(e,t,i)}selectVariations(t,i){return this.getList().map((e=>this.selectVariation(t,null==e?void 0:e.key,i))).filter((t=>t&&!Object.values(e.RuleError).includes(t)&&!Object.values(e.BucketingError).includes(t)))}getVariation(e,t){return this._dataManager.getSubItem("experiences",e,"variations",t,"key","key")}getVariationById(e,t){return this._dataManager.getSubItem("experiences",e,"variations",t,"id","id")}}class te{constructor(e,{dataManager:t,loggerManager:i}){var r,n;this._dataManager=t,this._loggerManager=i,null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===n||n.call(r,"FeatureManager()",o.FEATURE_CONSTRUCTOR)}getList(){return this._dataManager.getEntitiesList("features")}getListAsObject(e="id"){return this._dataManager.getEntitiesListObject("features",e)}getFeature(e){return this._dataManager.getEntity(e,"features")}getFeatureById(e){return this._dataManager.getEntityById(e,"features")}getFeatures(e){return this._dataManager.getItemsByKeys(e,"features")}getFeatureVariableType(e,t){const i=this.getFeature(e);if(Object.prototype.hasOwnProperty.call(i,"variables")){const e=i.variables.find((e=>e.key===t));return(null==e?void 0:e.type)||null}return null}getFeatureVariableTypeById(e,t){const i=this.getFeatureById(e);if(Object.prototype.hasOwnProperty.call(i,"variables")){const e=i.variables.find((e=>e.key===t));return(null==e?void 0:e.type)||null}return null}isFeatureDeclared(e){return!!this._dataManager.getEntity(e,"features")}runFeature(e,t,i,r){const n=this._dataManager.getEntity(t,"features");if(n){const a=this.runFeatures(e,i,{features:[t],experiences:r});return m(a)?1===a.length?a[0]:a:{id:n.id,name:n.name,key:t,status:u.DISABLED}}return{key:t,status:u.DISABLED}}isFeatureEnabled(e,t,i,r){if(this._dataManager.getEntity(t,"features")){return m(this.runFeatures(e,i,{features:[t],experiences:r}))}return!1}runFeatureById(t,i,r,n){const a=this._dataManager.getEntityById(i,"features");if(a){const o=this.runFeatures(t,r,{features:[a.key],experiences:this._dataManager.getEntitiesByIds(n,"experiences").map((e=>e.key))});if(m(o)){if(1===o.length)return o[0];{const t=o.filter((t=>Object.values(e.RuleError).includes(t)));return t.length?t:o}}return{id:i,name:a.name,key:a.key,status:u.DISABLED}}return{id:i,status:u.DISABLED}}runFeatures(t,i,r){var n,a,s,l,d,c,g,v,h,_,p,E,f,M,y,O,T,R;const{typeCasting:S=!0}=i,N=this.getListAsObject("id"),C=[],A=(r&&m(null==r?void 0:r.experiences)?this._dataManager.getEntities(r.experiences,"experiences"):this._dataManager.getEntitiesList("experiences")).map((r=>{const n=this._dataManager.getBucketing(t,null==r?void 0:r.key,i);return Object.values(e.RuleError).includes(n),n})).filter(Boolean),D=A.filter((t=>Object.values(e.RuleError).includes(t)));if(D.length)return D;for(const t in A){const i=A[t];for(const t in(null==i?void 0:i.changes)||[]){const A=null===(a=null===(n=null==i?void 0:i.changes)||void 0===n?void 0:n[t])||void 0===a?void 0:a.data;if((null===(l=null===(s=null==i?void 0:i.changes)||void 0===s?void 0:s[t])||void 0===l?void 0:l.type)!==e.VariationChangeType.FULLSTACK_FEATURE){null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.warn)||void 0===c||c.call(d,"FeatureManager.runFeatures()",o.VARIATION_CHANGE_NOT_SUPPORTED);continue}const D=null==A?void 0:A.feature_id;if(D){if(r&&m(null==r?void 0:r.features)&&-1!==(null===(h=null==r?void 0:r.features)||void 0===h?void 0:h.indexOf(null===(_=N[String(D)])||void 0===_?void 0:_.key))||!(null==r?void 0:r.features)){const e=null==A?void 0:A.variables_data;if(e||null===(E=null===(p=this._loggerManager)||void 0===p?void 0:p.warn)||void 0===E||E.call(p,"FeatureManager.runFeatures()",o.FEATURE_VARIABLES_NOT_FOUND),S&&I(e))for(const t in e){const i=null===(M=null===(f=N[String(D)])||void 0===f?void 0:f.variables)||void 0===M?void 0:M.find((e=>e.key===t));(null==i?void 0:i.type)?e[t]=this.castType(e[t],i.type):null===(O=null===(y=this._loggerManager)||void 0===y?void 0:y.warn)||void 0===O||O.call(y,"FeatureManager.runFeatures()",o.FEATURE_VARIABLES_TYPE_NOT_FOUND)}const t=Object.assign({experienceId:i.experienceId,experienceName:i.experienceName,experienceKey:i.experienceKey},{key:null===(T=N[String(D)])||void 0===T?void 0:T.key,name:null===(R=N[String(D)])||void 0===R?void 0:R.name,id:String(D),status:u.ENABLED,variables:e});C.push(t)}}else null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.warn)||void 0===v||v.call(g,"FeatureManager.runFeatures()",o.FEATURE_NOT_FOUND)}}if(!(null==r?void 0:r.features)){const e=C.map((e=>e.id));for(const t in N)-1===e.indexOf(N[t].id)&&C.push({id:N[t].id,name:N[t].name,key:N[t].key,status:u.DISABLED})}return C}castType(e,t){return function(e,t){switch(t){case"boolean":return"true"===e||"false"!==e&&!!e;case"float":return!0===e?1:!1===e?0:parseFloat(e);case"json":if("object"==typeof e)return e;try{return JSON.parse(e)}catch(t){return String(e)}case"string":return String(e);case"integer":return!0===e?1:!1===e?0:parseInt(e);default:return e}}(e,t)}}const ie=!0;class re{constructor(e,{loggerManager:t}={}){var i,r,n,a,s;this._comparisonProcessor=P,this._negation="!",this._keys_case_sensitive=ie,this._loggerManager=t,this._comparisonProcessor=(null===(i=null==e?void 0:e.rules)||void 0===i?void 0:i.comparisonProcessor)||P,this._negation=String((null===(r=null==e?void 0:e.rules)||void 0===r?void 0:r.negation)||"!"),this._keys_case_sensitive=(null===(n=null==e?void 0:e.rules)||void 0===n?void 0:n.keys_case_sensitive)||ie,this._mapper=(null==e?void 0:e.mapper)||(e=>e),null===(s=null===(a=this._loggerManager)||void 0===a?void 0:a.trace)||void 0===s||s.call(a,"RuleManager()",o.RULE_CONSTRUCTOR,this)}set comparisonProcessor(e){this._comparisonProcessor=e}get comparisonProcessor(){return this._comparisonProcessor}getComparisonProcessorMethods(){return Object.getOwnPropertyNames(this._comparisonProcessor).filter((e=>"function"==typeof this._comparisonProcessor[e]))}isRuleMatched(t,i,r){var n,s,l,u,d,c,g,v,h,_;let p;if(null===(s=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===s||s.call(n,"RuleManager.isRuleMatched()",this._mapper({data:t,ruleSet:i})),r&&(null===(u=null===(l=this._loggerManager)||void 0===l?void 0:l.info)||void 0===u||u.call(l,"RuleManager.isRuleMatched()",o.PROCESSING_ENTITY.replace("#",r))),Object.prototype.hasOwnProperty.call(i,"OR")&&m(null==i?void 0:i.OR)){for(let n=0,s=i.OR.length;n<s;n++){if(p=this._processAND(t,i.OR[n]),!0===p)return p;Object.values(e.RuleError).includes(p)?null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===c||c.call(d,"RuleManager.isRuleMatched()",r||"",a.RULE_ERROR):null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.info)||void 0===v||v.call(g,"RuleManager.isRuleMatched()",r||"",!1===p?o.RULE_NOT_MATCH:o.RULE_MATCH.replace("#",String(n)))}if(!1!==p)return p}else null===(_=null===(h=this._loggerManager)||void 0===h?void 0:h.warn)||void 0===_||_.call(h,"RuleManager.isRuleMatched()",r||"",a.RULE_NOT_VALID);return!1}isValidRule(e){var t,i;return null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===i||i.call(t,"RuleManager.isValidRule()",this._mapper({rule:e})),Object.prototype.hasOwnProperty.call(e,"matching")&&"object"==typeof e.matching&&Object.prototype.hasOwnProperty.call(e.matching,"match_type")&&"string"==typeof e.matching.match_type&&Object.prototype.hasOwnProperty.call(e.matching,"negated")&&"boolean"==typeof e.matching.negated&&Object.prototype.hasOwnProperty.call(e,"value")}_processAND(e,t){var i,r,n,s;let l;if(Object.prototype.hasOwnProperty.call(t,"AND")&&m(null==t?void 0:t.AND)){for(let i=0,r=t.AND.length;i<r;i++)if(l=this._processORWHEN(e,t.AND[i]),!1===l)return!1;return!1!==l&&(null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.info)||void 0===r||r.call(i,"RuleManager._processAND()",o.RULE_MATCH_AND)),l}return null===(s=null===(n=this._loggerManager)||void 0===n?void 0:n.warn)||void 0===s||s.call(n,"RuleManager._processAND()",a.RULE_NOT_VALID),!1}_processORWHEN(e,t){var i,r;let n;if(Object.prototype.hasOwnProperty.call(t,"OR_WHEN")&&m(null==t?void 0:t.OR_WHEN)){for(let i=0,r=t.OR_WHEN.length;i<r;i++)if(n=this._processRuleItem(e,t.OR_WHEN[i]),!0===n)return n;if(!1!==n)return n}else null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.warn)||void 0===r||r.call(i,"RuleManager._processORWHEN()",a.RULE_NOT_VALID);return!1}_processRuleItem(t,i){var r,n,s,l,u,d,c,g,v,h,_,p,E;if(this.isValidRule(i))try{const h=i.matching.negated||!1,_=i.matching.match_type;if(-1!==this.getComparisonProcessorMethods().indexOf(_))if(t&&"object"==typeof t)if(this.isUsingCustomInterface(t)){if(null==i?void 0:i.rule_type){null===(n=null===(r=this._loggerManager)||void 0===r?void 0:r.info)||void 0===n||n.call(r,"RuleManager._processRuleItem()",o.RULE_MATCH_START.replace("#",i.rule_type));for(const r of Object.getOwnPropertyNames(t.constructor.prototype)){if("constructor"===r)continue;const n=b(`get ${i.rule_type.replace(/_/g," ")}`);if(r===n||(null===(s=null==t?void 0:t.mapper)||void 0===s?void 0:s.call(t,r))===n){const n=t[r](i);return Object.values(e.RuleError).includes(n)||"js_condition"===i.rule_type?n:this._comparisonProcessor[_](n,i.value,h)}}}}else if(I(t))for(const e of Object.keys(t)){const r=this._keys_case_sensitive?e:e.toLowerCase();if(r===(this._keys_case_sensitive?i.key:String(i.key).toLowerCase()))return this._comparisonProcessor[_](t[e],i.value,h)}else null===(u=null===(l=this._loggerManager)||void 0===l?void 0:l.trace)||void 0===u||u.call(l,"RuleManager._processRuleItem()",{warn:a.RULE_DATA_NOT_VALID,data:t});else null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.trace)||void 0===c||c.call(d,"RuleManager._processRuleItem()",{warn:a.RULE_NOT_VALID,data:t,rule:i});else null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.warn)||void 0===v||v.call(g,"RuleManager._processRuleItem()",a.RULE_MATCH_TYPE_NOT_SUPPORTED.replace("#",_))}catch(e){null===(_=null===(h=this._loggerManager)||void 0===h?void 0:h.error)||void 0===_||_.call(h,"RuleManager._processRuleItem()",{error:e.message})}else null===(E=null===(p=this._loggerManager)||void 0===p?void 0:p.warn)||void 0===E||E.call(p,"RuleManager._processRuleItem()",a.RULE_NOT_VALID);return!1}isUsingCustomInterface(e){return I(e)&&Object.prototype.hasOwnProperty.call(e,"name")&&"RuleData"===e.name}}class ne{constructor(e,{dataManager:t,ruleManager:i,loggerManager:r}){this._dataManager=t,this._ruleManager=i,this._loggerManager=r,this._data=T(e,"data")}getSegments(e){const t=this._dataManager.getData(e)||{},{segments:i}=this._dataManager.filterReportSegments(null==t?void 0:t.segments);return i}putSegments(e,t){const{segments:i}=this._dataManager.filterReportSegments(t);i&&this._dataManager.putData(e,{segments:i})}setCustomSegments(t,i,r){var n,a,s,l,u;const d=this._dataManager.getData(t)||{},{segments:{[M.CUSTOM_SEGMENTS]:c=[]}={}}=d,g=[];let v,h=!1;for(const t of i){if(r&&!h&&(h=this._ruleManager.isRuleMatched(r,null==t?void 0:t.rules,`ConfigSegment #${null==t?void 0:t.id}`),Object.values(e.RuleError).includes(h)))return h;if(!r||h){const e=null===(n=null==t?void 0:t.id)||void 0===n?void 0:n.toString();c.includes(e)?null===(s=null===(a=this._loggerManager)||void 0===a?void 0:a.warn)||void 0===s||s.call(a,"SegmentsManager.setCustomSegments()",o.CUSTOM_SEGMENTS_KEY_FOUND):g.push(e)}}return g.length?(v=Object.assign(Object.assign({},d.segments||{}),{[M.CUSTOM_SEGMENTS]:[...c,...g]}),this.putSegments(t,v)):null===(u=null===(l=this._loggerManager)||void 0===l?void 0:l.warn)||void 0===u||u.call(l,"SegmentsManager.setCustomSegments()",o.SEGMENTS_NOT_FOUND),v}selectCustomSegments(e,t,i){const r=this._dataManager.getEntities(t,"segments");return this.setCustomSegments(e,r,i)}selectCustomSegmentsByIds(e,t,i){const r=this._dataManager.getEntitiesByIds(t,"segments");return this.setCustomSegments(e,r,i)}}const ae=e.LogLevel.TRACE;class oe{constructor(e=console,t=ae,i){this._defaultMapper={[g.LOG]:g.LOG,[g.DEBUG]:g.DEBUG,[g.INFO]:g.INFO,[g.WARN]:g.WARN,[g.ERROR]:g.ERROR,[g.TRACE]:g.TRACE},this._clients=[],this.addClient(e,t,i)}_isValidLevel(t){return Object.values(e.LogLevel).includes(t)}_isValidMethod(e){return Object.values(g).includes(e)}_log(t,i,...r){this._clients.forEach((n=>{var a,o;if(i>=n.level&&e.LogLevel.SILENT!==i){const e=n.sdk[n.mapper[t]];e?e.call(n.sdk,...r):(console.log(`Info: Unable to find method "${t}()" in client sdk:`,null===(o=null===(a=n.sdk)||void 0===a?void 0:a.constructor)||void 0===o?void 0:o.name),console[t](...r))}}))}log(e,...t){this._isValidLevel(e)?this._log(g.LOG,e,...t):console.error("Invalid Log Level")}trace(...t){this._log(g.TRACE,e.LogLevel.TRACE,...t)}debug(...t){this._log(g.DEBUG,e.LogLevel.DEBUG,...t)}info(...t){this._log(g.INFO,e.LogLevel.INFO,...t)}warn(...t){this._log(g.WARN,e.LogLevel.WARN,...t)}error(...t){this._log(g.ERROR,e.LogLevel.ERROR,...t)}addClient(e=console,t=ae,i){if(!e)return void console.error("Invalid Client SDK");if(!this._isValidLevel(t))return void console.error("Invalid Log Level");const r=Object.assign({},this._defaultMapper);i&&Object.keys(i).filter(this._isValidMethod).forEach((e=>{r[e]=i[e]})),this._clients.push({sdk:e,level:t,mapper:r})}setClientLevel(e,t){if(this._isValidLevel(e))if(t){const i=this._clients.findIndex((({sdk:e})=>e===t));if(-1===i)return void console.error("Client SDK not found");this._clients[i].level=e}else for(let t=0,i=this._clients.length;t<i;t++)this._clients[t].level=e;else console.error("Invalid Log Level")}}const se={api:{endpoint:{config:"https://cdn-4.convertexperiments.com/api/v1/",track:"https://[project_id].metrics.convertexperiments.com/v1/"}},environment:"staging",bucketing:{max_traffic:1e4,hash_seed:9999},data:{},dataStore:null,dataRefreshInterval:3e5,events:{batch_size:10,release_interval:1e3},logger:{logLevel:e.LogLevel.DEBUG,customLoggers:[]},rules:{keys_case_sensitive:!0,comparisonProcessor:null},network:{tracking:!0,cacheLevel:"default"},sdkKey:"",sdkKeySecret:""},le={logger:{logLevel:e.LogLevel.WARN,customLoggers:[]}},ue={environment:"staging"};e.DataStore=class{constructor(e,t){var i,r,n,a;this._file=e,this._fs=t;try{(null===(r=null===(i=this._fs)||void 0===i?void 0:i.existsSync)||void 0===r?void 0:r.call(i,this._file))||null===(a=null===(n=this._fs)||void 0===n?void 0:n.writeFileSync)||void 0===a||a.call(n,this._file,"{}")}catch(e){console.error(e)}}get(e){var t,i;try{return JSON.parse(null===(i=null===(t=this._fs)||void 0===t?void 0:t.readFileSync)||void 0===i?void 0:i.call(t,this._file))[e]}catch(e){console.error(e)}}set(e,t){var i,r,n,a;try{const o=JSON.parse(null===(r=null===(i=this._fs)||void 0===i?void 0:i.readFileSync)||void 0===r?void 0:r.call(i,this._file));o[e]=t,null===(a=null===(n=this._fs)||void 0===n?void 0:n.writeFileSync)||void 0===a||a.call(n,this._file,JSON.stringify(o))}catch(e){console.error(e)}}delete(e){var t,i,r,n;try{const a=JSON.parse(null===(i=null===(t=this._fs)||void 0===t?void 0:t.readFileSync)||void 0===i?void 0:i.call(t,this._file));delete a[e],null===(n=null===(r=this._fs)||void 0===r?void 0:r.writeFileSync)||void 0===n||n.call(r,this._file,JSON.stringify(a))}catch(e){console.error(e)}}},e.FileLogger=class{constructor(e,t,i="appendFileSync"){this._file=e,this._fs=t,this._appendMethod=i}_write(e,...i){return t(this,void 0,void 0,(function*(){var t,r;const n=`${(new Date).toISOString()} [${e.toUpperCase()}]`,a=`${n} ${i.map(JSON.stringify).join(`\n${n} `)}\n`;try{null===(r=null===(t=this._fs)||void 0===t?void 0:t[this._appendMethod])||void 0===r||r.call(t,this._file,a)}catch(e){console.warn(e)}}))}log(...e){return t(this,void 0,void 0,(function*(){yield this._write(g.LOG,...e)}))}info(...e){return t(this,void 0,void 0,(function*(){yield this._write(g.INFO,...e)}))}debug(...e){return t(this,void 0,void 0,(function*(){yield this._write(g.DEBUG,...e)}))}warn(...e){return t(this,void 0,void 0,(function*(){yield this._write(g.WARN,...e)}))}error(...e){return t(this,void 0,void 0,(function*(){yield this._write(g.ERROR,...e)}))}},e.default=class extends H{constructor(e={}){var t,i,r;const n=Boolean(Object.prototype.hasOwnProperty.call(e,"sdkKey")&&(null===(t=e.sdkKey)||void 0===t?void 0:t.length)),o=Boolean(Object.prototype.hasOwnProperty.call(e,"data"));n||o||console.error(a.SDK_OR_DATA_OBJECT_REQUIRED);const s=((e={})=>R(le,ue,se,e))(e);(null==s?void 0:s.network)||(s.network={}),(null===(i=s.network)||void 0===i?void 0:i.source)||(s.network.source="js4.3.2");const l=new oe(console,s.logger.logLevel);for(const e in s.logger.customLoggers)Object.prototype.hasOwnProperty.call(s.logger.customLoggers[e],"logger")&&Object.prototype.hasOwnProperty.call(s.logger.customLoggers[e],"logLevel")?l.addClient(s.logger.customLoggers[e].logger,s.logger.customLoggers[e].logLevel,null===(r=s.logger.customLoggers[e])||void 0===r?void 0:r.methodsMap):l.addClient(s.logger.customLoggers[e],s.logger.logLevel);const u=new Z(s,{loggerManager:l}),d=new G(s,{eventManager:u,loggerManager:l}),c=new K(s,{loggerManager:l}),g=new re(s,{loggerManager:l}),v=new X(s,{bucketingManager:c,ruleManager:g,eventManager:u,apiManager:d,loggerManager:l});super(s,{dataManager:v,eventManager:u,experienceManager:new ee(s,{dataManager:v}),featureManager:new te(s,{dataManager:v,loggerManager:l}),segmentsManager:new ne(s,{dataManager:v,ruleManager:g,loggerManager:l}),apiManager:d,loggerManager:l})}onReady(){return super.onReady()}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.min.js.map
