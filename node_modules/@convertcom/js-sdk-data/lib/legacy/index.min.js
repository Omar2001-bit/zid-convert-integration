/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";function e(e){return Array.isArray(e)&&e.length>0}function t(e,t,i,n=!1){try{if("object"==typeof e){const i=t.split(".").reduce(((e,t)=>e[t]),e);if(i||n&&(!1===i||0===i))return i}}catch(e){}return null}function i(...e){const t=e=>e&&"object"==typeof e;return e.reduce(((e,n)=>(Object.keys(n).forEach((a=>{const r=e[a],o=n[a];Array.isArray(r)&&Array.isArray(o)?e[a]=[...new Set([...o,...r])]:t(r)&&t(o)?e[a]=i(r,o):e[a]=o})),e)),{})}function n(e){return"object"==typeof e&&null!==e&&Object.keys(e).length>0}"function"==typeof SuppressedError&&SuppressedError;const a=(e,t)=>{if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||null==e||null==t)return!1;const i=Object.keys(e),n=Object.keys(t);if(i.length!=n.length)return!1;for(const r of i){if(!n.includes(r))return!1;if("function"==typeof e[r]||"function"==typeof t[r]){if(e[r].toString()!=t[r].toString())return!1}else if(!a(e[r],t[r]))return!1}return!0};var r,o,l,s;function u(e){if("number"==typeof e)return!0;const t=parseFloat(String(e));return Number.isFinite(t)&&!isNaN(t)}function d(e){if("number"==typeof e)return e;const t=String(e).split(",");return parseFloat("0"==t[0]?String(e).replace(/,/g,"."):String(e).replace(/,/g,""))}r={exports:{}},function(){const e=e=>(new TextEncoder).encode(e);function t(t,i){let n,a,r,o,l,s,u,d;for("string"==typeof t&&(t=e(t)),n=3&t.length,a=t.length-n,r=i,l=3432918353,s=461845907,d=0;d<a;)u=255&t[d]|(255&t[++d])<<8|(255&t[++d])<<16|(255&t[++d])<<24,++d,u=(65535&u)*l+(((u>>>16)*l&65535)<<16)&4294967295,u=u<<15|u>>>17,u=(65535&u)*s+(((u>>>16)*s&65535)<<16)&4294967295,r^=u,r=r<<13|r>>>19,o=5*(65535&r)+((5*(r>>>16)&65535)<<16)&4294967295,r=27492+(65535&o)+((58964+(o>>>16)&65535)<<16);switch(u=0,n){case 3:u^=(255&t[d+2])<<16;case 2:u^=(255&t[d+1])<<8;case 1:u^=255&t[d],u=(65535&u)*l+(((u>>>16)*l&65535)<<16)&4294967295,u=u<<15|u>>>17,u=(65535&u)*s+(((u>>>16)*s&65535)<<16)&4294967295,r^=u}return r^=t.length,r^=r>>>16,r=2246822507*(65535&r)+((2246822507*(r>>>16)&65535)<<16)&4294967295,r^=r>>>13,r=3266489909*(65535&r)+((3266489909*(r>>>16)&65535)<<16)&4294967295,r^=r>>>16,r>>>0}const i=t;i.v2=function(t,i){"string"==typeof t&&(t=e(t));let n,a=t.length,r=i^a,o=0;for(;a>=4;)n=255&t[o]|(255&t[++o])<<8|(255&t[++o])<<16|(255&t[++o])<<24,n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16),n^=n>>>24,n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16),r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16)^n,a-=4,++o;switch(a){case 3:r^=(255&t[o+2])<<16;case 2:r^=(255&t[o+1])<<8;case 1:r^=255&t[o],r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16)}return r^=r>>>13,r=1540483477*(65535&r)+((1540483477*(r>>>16)&65535)<<16),r^=r>>>15,r>>>0},i.v3=t,r.exports=i}();class c{static equals(e,t,i){return Array.isArray(e)?this._returnNegationCheck(-1!==e.indexOf(t),i):n(e)?this._returnNegationCheck(-1!==Object.keys(e).indexOf(String(t)),i):(e=String(e),t=String(t),e=e.valueOf().toLowerCase(),t=t.valueOf().toLowerCase(),this._returnNegationCheck(e===t,i))}static less(e,t,i){return typeof(e=u(e)?d(e):e)==typeof(t=u(t)?d(t):t)&&this._returnNegationCheck(e<t,i)}static lessEqual(e,t,i){return typeof(e=u(e)?d(e):e)==typeof(t=u(t)?d(t):t)&&this._returnNegationCheck(e<=t,i)}static contains(e,t,i){return e=String(e),t=String(t),e=e.valueOf().toLowerCase(),0===(t=t.valueOf().toLowerCase()).replace(/^([\s]*)|([\s]*)$/g,"").length?this._returnNegationCheck(!0,i):this._returnNegationCheck(-1!==e.indexOf(t),i)}static isIn(e,t,i=!1,n="|"){const a=String(e).split(n).map((e=>String(e)));"string"==typeof t&&(t=t.split(n)),Array.isArray(t)||(t=[]),t=t.map((e=>String(e).valueOf().toLowerCase()));for(let e=0;e<a.length;e++)if(-1!==t.indexOf(a[e]))return this._returnNegationCheck(!0,i);return this._returnNegationCheck(!1,i)}static startsWith(e,t,i){return e=String(e).valueOf().toLowerCase(),t=String(t).valueOf().toLowerCase(),this._returnNegationCheck(0===e.indexOf(t),i)}static endsWith(e,t,i){return e=String(e).valueOf().toLowerCase(),t=String(t).valueOf().toLowerCase(),this._returnNegationCheck(-1!==e.indexOf(t,e.length-t.length),i)}static regexMatches(e,t,i){e=String(e).valueOf().toLowerCase(),t=String(t).valueOf();const n=new RegExp(t,"i");return this._returnNegationCheck(n.test(e),i)}static _returnNegationCheck(e,t=!1){return t?!e:e}}o=c,c.equalsNumber=o.equals,c.matches=o.equals,function(e){e.VARIAION_NOT_DECIDED="convert.com_variation_not_decided"}(l||(l={})),function(e){e.FORCE_MULTIPLE_TRANSACTIONS="forceMultipleTransactions"}(s||(s={}));const g=["events","goals","audiences","locations","segments","experiences","archived_experiences","experiences.variations","features","features.variables"],v={goal:"goals",audience:"audiences",location:"locations",segment:"segments",experience:"experiences",variation:"experiences.variations",feature:"features"},h="Config Data is not valid",_="DataStore object is not valid. It should contain get and set methods",E="Unable to bucket visitor",p={CONFIG_DATA_UPDATED:"Config Data updated",CORE_CONSTRUCTOR:"Core Manager constructor has been called",CORE_INITIALIZED:"Core Manager has been initialized",EXPERIENCE_CONSTRUCTOR:"Experience Manager constructor has been called",EXPERIENCE_NOT_FOUND:"Experience not found",EXPERIENCE_ARCHIVED:"Experience archived",EXPERIENCE_ENVIRONMENT_NOT_MATCH:"Experience environment does not match",EXPERIENCE_RULES_MATCHED:"Experience rules matched",VARIATIONS_NOT_FOUND:"Variations not found",VARIATION_CHANGE_NOT_SUPPORTED:"Variation change not supported",FEATURE_CONSTRUCTOR:"Feature Manager constructor has been called",FEATURE_NOT_FOUND:"Fullstack Feature not found",FEATURE_VARIABLES_NOT_FOUND:"Fullstack Feature Variables not found",FEATURE_VARIABLES_TYPE_NOT_FOUND:"Fullstack Feature Variables Type not found",BUCKETING_CONSTRUCTOR:"Bucketing Manager constructor has been called",DATA_CONSTRUCTOR:"Data Manager constructor has been called",RULE_CONSTRUCTOR:"Rule Manager constructor has been called",PROCESSING_ENTITY:"Processing #",LOCATION_MATCH:"Location # rule matched",LOCATION_NOT_MATCH:"Location does not match",LOCATION_NOT_RESTRICTED:"Location not restricted",AUDIENCE_MATCH:"Audience # rule matched",AUDIENCE_NOT_MATCH:"Audience does not match",NON_PERMANENT_AUDIENCE_NOT_RESTRICTED:"Non-Permanent Audience not restricted",AUDIENCE_NOT_RESTRICTED:"Audience not restricted",SEGMENTATION_MATCH:"Segmentation # rule matched",SEGMENTATION_NOT_RESTRICTED:"Segmentation not restricted",RULE_NOT_MATCH:"Rule does not match",RULE_MATCH:"Found matched rule at OR block #",RULE_MATCH_AND:"AND block rule macthed",RULE_MATCH_START:"About to evaluate rule #",LOCATION_ACTIVATED:"Location # activated",LOCATION_DEACTIVATED:"Location # deactivated",BUCKETED_VISITOR_FOUND:"Visitor is already bucketed for variation #",BUCKETED_VISITOR_FORCED:"Forcing variation #",BUCKETED_VISITOR:"Visitor is bucketed for variation #",GOAL_NOT_FOUND:"Goal not found",GOAL_RULE_NOT_MATCH:"Goal rule do not match",GOAL_FOUND:"Goal # already triggered",SEGMENTS_NOT_FOUND:"Segments not found",SEGMENTS_RULE_NOT_MATCH:"Segments rule do not match",CUSTOM_SEGMENTS_KEY_FOUND:"Custom segments key already set",SEND_BEACON_SUCCESS:"The user agent successfully queued the data for transfer",RELEASING_QUEUE:"Releasing event queue..."};var f,T,O,M,N,S,A,R,I,C,y,D,m,b,L,U;!function(e){e.OFF="OFF",e.EU_ONLY="EU ONLY",e.EEA_ONLY="EEA ONLY",e.WORLDWIDE="Worldwide"}(f||(f={})),function(e){e.AUDIENCE="audience",e.LOCATION="location",e.SEGMENT="segment",e.FEATURE="feature",e.GOAL="goal",e.EXPERIENCE="experience",e.VARIATION="variation"}(T||(T={})),function(e){e.ENABLED="enabled",e.DISABLED="disabled"}(O||(O={})),function(e){e.AMOUNT="amount",e.PRODUCTS_COUNT="productsCount",e.TRANSACTION_ID="transactionId"}(M||(M={})),function(e){e[e.TRACE=0]="TRACE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(N||(N={})),function(e){e.LOG="log",e.TRACE="trace",e.DEBUG="debug",e.INFO="info",e.WARN="warn",e.ERROR="error"}(S||(S={})),function(e){e.WEB="web",e.FULLSTACK="fullstack"}(A||(A={})),function(e){e.NO_DATA_FOUND="convert.com_no_data_found",e.NEED_MORE_DATA="convert.com_need_more_data"}(R||(R={})),function(e){e.READY="ready",e.CONFIG_UPDATED="config.updated",e.API_QUEUE_RELEASED="api.queue.released",e.BUCKETING="bucketing",e.CONVERSION="conversion",e.SEGMENTS="segments",e.LOCATION_ACTIVATED="location.activated",e.LOCATION_DEACTIVATED="location.deactivated",e.AUDIENCES="audiences",e.DATA_STORE_QUEUE_RELEASED="datastore.queue.released"}(I||(I={})),function(e){e.RICH_STRUCTURE="richStructure",e.CUSTOM_CODE="customCode",e.DEFAULT_CODE="defaultCode",e.DEFAULT_CODE_MULTIPAGE="defaultCodeMultipage",e.DEFAULT_REDIRECT="defaultRedirect",e.FULLSTACK_FEATURE="fullStackFeature"}(C||(C={})),function(e){e.IE="IE",e.CH="CH",e.FF="FF",e.OP="OP",e.SF="SF",e.EDG="EDG",e.MO="MO",e.NS="NS",e.OTH="OTH"}(y||(y={})),function(e){e.ALLPH="ALLPH",e.IPH="IPH",e.OTHPH="OTHPH",e.ALLTAB="ALLTAB",e.IPAD="IPAD",e.OTHTAB="OTHTAB",e.DESK="DESK",e.OTHDEV="OTHDEV"}(D||(D={})),function(e){e.COUNTRY="country",e.BROWSER="browser",e.DEVICES="devices",e.SOURCE="source",e.CAMPAIGN="campaign",e.VISITOR_TYPE="visitorType",e.CUSTOM_SEGMENTS="customSegments"}(m||(m={})),function(e){e.CAMPAIGN="campaign",e.SEARCH="search",e.REFERRAL="referral",e.DIRECT="direct"}(b||(b={})),function(e){e.NEW="new",e.RETURNING="returning"}(L||(L={})),function(e){e[e.Continue=100]="Continue",e[e.SwitchingProtocols=101]="SwitchingProtocols",e[e.Processing=102]="Processing",e[e.EarlyHints=103]="EarlyHints",e[e.Ok=200]="Ok",e[e.Created=201]="Created",e[e.Accepted=202]="Accepted",e[e.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",e[e.NoContent=204]="NoContent",e[e.ResetContent=205]="ResetContent",e[e.PartialContent=206]="PartialContent",e[e.MultiStatus=207]="MultiStatus",e[e.AlreadyReported=208]="AlreadyReported",e[e.ImUsed=226]="ImUsed",e[e.MultipleChoices=300]="MultipleChoices",e[e.MovedPermanently=301]="MovedPermanently",e[e.Found=302]="Found",e[e.SeeOther=303]="SeeOther",e[e.NotModified=304]="NotModified",e[e.UseProxy=305]="UseProxy",e[e.Unused=306]="Unused",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.PermanentRedirect=308]="PermanentRedirect",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.PaymentRequired=402]="PaymentRequired",e[e.Forbidden=403]="Forbidden",e[e.NotFound=404]="NotFound",e[e.MethodNotAllowed=405]="MethodNotAllowed",e[e.NotAcceptable=406]="NotAcceptable",e[e.ProxyAuthenticationRequired=407]="ProxyAuthenticationRequired",e[e.RequestTimeout=408]="RequestTimeout",e[e.Conflict=409]="Conflict",e[e.Gone=410]="Gone",e[e.LengthRequired=411]="LengthRequired",e[e.PreconditionFailed=412]="PreconditionFailed",e[e.PayloadTooLarge=413]="PayloadTooLarge",e[e.UriTooLong=414]="UriTooLong",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.RangeNotSatisfiable=416]="RangeNotSatisfiable",e[e.ExpectationFailed=417]="ExpectationFailed",e[e.ImATeapot=418]="ImATeapot",e[e.MisdirectedRequest=421]="MisdirectedRequest",e[e.UnprocessableEntity=422]="UnprocessableEntity",e[e.Locked=423]="Locked",e[e.FailedDependency=424]="FailedDependency",e[e.TooEarly=425]="TooEarly",e[e.UpgradeRequired=426]="UpgradeRequired",e[e.PreconditionRequired=428]="PreconditionRequired",e[e.TooManyRequests=429]="TooManyRequests",e[e.RequestHeaderFieldsTooLarge=431]="RequestHeaderFieldsTooLarge",e[e.UnavailableForLegalReasons=451]="UnavailableForLegalReasons",e[e.InternalServerError=500]="InternalServerError",e[e.NotImplemented=501]="NotImplemented",e[e.BadGateway=502]="BadGateway",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.HttpVersionNotSupported=505]="HttpVersionNotSupported",e[e.VariantAlsoNegotiates=506]="VariantAlsoNegotiates",e[e.InsufficientStorage=507]="InsufficientStorage",e[e.LoopDetected=508]="LoopDetected",e[e.NotExtended=510]="NotExtended",e[e.NetworkAuthenticationRequired=511]="NetworkAuthenticationRequired"}(U||(U={}));const F="permanent",k="all",B="running",P="bucketing",V="conversion";class x{constructor(e,{dataStore:t,eventManager:i,loggerManager:n}={}){var a,r;this.batchSize=1,this.releaseInterval=5e3,this._loggerManager=n,this._eventManager=i,this.batchSize=Number(null===(a=null==e?void 0:e.events)||void 0===a?void 0:a.batch_size)||1,this.releaseInterval=Number(null===(r=null==e?void 0:e.events)||void 0===r?void 0:r.release_interval)||5e3,this.dataStore=t,this._mapper=(null==e?void 0:e.mapper)||(e=>e),this._requestsQueue={}}set(e,t){var i,n,a,r;try{null===(n=null===(i=this.dataStore)||void 0===i?void 0:i.set)||void 0===n||n.call(i,e,t)}catch(e){null===(r=null===(a=this._loggerManager)||void 0===a?void 0:a.error)||void 0===r||r.call(a,"DataStoreManager.set()",{error:e.message})}}get(e){var t,i,n,a;try{return null===(i=null===(t=this.dataStore)||void 0===t?void 0:t.get)||void 0===i?void 0:i.call(t,e)}catch(e){null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===a||a.call(n,"DataStoreManager.get()",{error:e.message})}return null}enqueue(e,t){var n,a;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"DataStoreManager.enqueue()",this._mapper({key:e,data:t}));const r={};r[e]=t,this._requestsQueue=i(this._requestsQueue,r),Object.keys(this._requestsQueue).length>=this.batchSize?this.releaseQueue("size"):1===Object.keys(this._requestsQueue).length&&this.startQueue()}releaseQueue(e){var t,i,n,a;null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.info)||void 0===i||i.call(t,"DataStoreManager.releaseQueue()",{reason:e||""}),this.stopQueue();for(const e in this._requestsQueue)this.set(e,this._requestsQueue[e]);null===(a=null===(n=this._eventManager)||void 0===n?void 0:n.fire)||void 0===a||a.call(n,I.DATA_STORE_QUEUE_RELEASED,{reason:e||""})}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}set dataStore(e){var t,i;e&&(this.isValidDataStore(e)?this._dataStore=e:null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.error)||void 0===i||i.call(t,"DataStoreManager.dataStore.set()",_))}get dataStore(){return this._dataStore}isValidDataStore(e){return"object"==typeof e&&"function"==typeof e.get&&"function"==typeof e.set}}exports.DataManager=class{constructor(e,{bucketingManager:i,ruleManager:n,eventManager:a,apiManager:r,loggerManager:o},{asyncStorage:l=!0}={}){var s,u,d,c,v;this._dataEntities=g,this._localStoreLimit=1e4,this._bucketedVisitors=new Map,this._environment=null==e?void 0:e.environment,this._apiManager=r,this._bucketingManager=i,this._ruleManager=n,this._loggerManager=o,this._eventManager=a,this._config=e,this._mapper=(null==e?void 0:e.mapper)||(e=>e),this._asyncStorage=l,this._data=t(e,"data"),this._accountId=null===(s=this._data)||void 0===s?void 0:s.account_id,this._projectId=null===(d=null===(u=this._data)||void 0===u?void 0:u.project)||void 0===d?void 0:d.id,this.dataStoreManager=null==e?void 0:e.dataStore,null===(v=null===(c=this._loggerManager)||void 0===c?void 0:c.trace)||void 0===v||v.call(c,"DataManager()",p.DATA_CONSTRUCTOR,this)}set data(e){var t,i,n;this.isValidConfigData(e)?(this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id):null===(n=null===(i=this._loggerManager)||void 0===i?void 0:i.error)||void 0===n||n.call(i,"DataManager.data.set()",h)}get data(){return this._data}set dataStoreManager(e){this._dataStoreManager=null,e&&(this._dataStoreManager=new x(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager}))}get dataStoreManager(){return this._dataStoreManager}setDataStore(e){this._dataStoreManager=null,e&&(this._dataStoreManager=new x(this._config,{dataStore:e,eventManager:this._eventManager,loggerManager:this._loggerManager}))}matchRulesByField(e,t,i="key",n){var a,r,o,l,s,u,d,c,g,v,h,_,E,f,T,O,M,N,S,A,I,C,y,D,m,b,L,U,B;const{visitorProperties:P,locationProperties:V,ignoreLocationProperties:x,environment:H=this._environment}=n;null===(r=null===(a=this._loggerManager)||void 0===a?void 0:a.trace)||void 0===r||r.call(a,"DataManager.matchRulesByField()",this._mapper({visitorId:e,identity:t,identityField:i,visitorProperties:P,locationProperties:V,ignoreLocationProperties:x,environment:H}));const q=this._getEntityByField(t,"experiences",i);if(!q)return null===(l=null===(o=this._loggerManager)||void 0===o?void 0:o.debug)||void 0===l||l.call(o,"DataManager.matchRulesByField()",p.EXPERIENCE_NOT_FOUND,this._mapper({identity:t,identityField:i})),null;if(!!this.getEntitiesList("archived_experiences").find((e=>String(null==q?void 0:q.id)===String(e))))return null===(u=null===(s=this._loggerManager)||void 0===s?void 0:s.debug)||void 0===u||u.call(s,"DataManager.matchRulesByField()",p.EXPERIENCE_ARCHIVED,this._mapper({identity:t,identityField:i})),null;if(!(!(null==q?void 0:q.environment)||q.environment===H))return null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.debug)||void 0===c||c.call(d,"DataManager.matchRulesByField()",p.EXPERIENCE_ENVIRONMENT_NOT_MATCH,this._mapper({identity:t,identityField:i})),null;let G=[];const{bucketing:j}=this.getData(e)||{},{[q.id.toString()]:w}=j||{};let K=!1;w&&this.retrieveVariation(q.id,String(w))&&(K=!0);let Q=!0===x;if(!Q&&V)if(Array.isArray(null==q?void 0:q.locations)&&q.locations.length){let t=[];const n=this.getItemsByIds(q.locations,"locations");if(n.length&&(t=this.selectLocations(e,n,{locationProperties:V,identityField:i}),G=t.filter((e=>Object.values(R).includes(e))),G.length))return G[0];Q=Boolean(t.length)}else if(null==q?void 0:q.site_area){if(Q=this._ruleManager.isRuleMatched(V,q.site_area,"SiteArea"),Object.values(R).includes(Q))return Q}else Q=!0,null===(v=null===(g=this._loggerManager)||void 0===g?void 0:g.info)||void 0===v||v.call(g,"DataManager.matchRulesByField()",p.LOCATION_NOT_RESTRICTED);if(!Q)return null===(_=null===(h=this._loggerManager)||void 0===h?void 0:h.debug)||void 0===_||_.call(h,"DataManager.matchRulesByField()",p.LOCATION_NOT_MATCH,this._mapper({locationProperties:V,[(null==q?void 0:q.locations)?"experiences[].variations[].locations":"experiences[].variations[].site_area"]:(null==q?void 0:q.locations)||(null==q?void 0:q.site_area)||""})),null;let W=[],$=[],X=[],Y=[],z=[],Z=!1,J=!1;if(P)if(Array.isArray(null==q?void 0:q.audiences)&&q.audiences.length)if(W=this.getItemsByIds(q.audiences,"audiences"),z=W.filter((e=>!(K&&e.type===F))),z.length){if(X=this.filterMatchedRecordsWithRule(z,P,"audience",i),G=X.filter((e=>Object.values(R).includes(e))),G.length)return G[0];if(X.length)for(const e of X)null===(f=null===(E=this._loggerManager)||void 0===E?void 0:E.info)||void 0===f||f.call(E,"DataManager.matchRulesByField()",p.AUDIENCE_MATCH.replace("#",null==e?void 0:e[i]));Z=q.settings.matching_options.audiences===k?Boolean(X.length===z.length):Boolean(X.length)}else Z=!0,null===(O=null===(T=this._loggerManager)||void 0===T?void 0:T.info)||void 0===O||O.call(T,"DataManager.matchRulesByField()",p.NON_PERMANENT_AUDIENCE_NOT_RESTRICTED);else Z=!0,null===(N=null===(M=this._loggerManager)||void 0===M?void 0:M.info)||void 0===N||N.call(M,"DataManager.matchRulesByField()",p.AUDIENCE_NOT_RESTRICTED);if($=this.getItemsByIds(q.audiences,"segments"),$.length){if(Y=this.filterMatchedCustomSegments($,e),Y.length)for(const e of Y)null===(A=null===(S=this._loggerManager)||void 0===S?void 0:S.info)||void 0===A||A.call(S,"DataManager.matchRulesByField()",p.SEGMENTATION_MATCH.replace("#",null==e?void 0:e[i]));J=Boolean(Y.length)}else J=!0,null===(C=null===(I=this._loggerManager)||void 0===I?void 0:I.info)||void 0===C||C.call(I,"DataManager.matchRulesByField()",p.SEGMENTATION_NOT_RESTRICTED);if(Z&&J){if((null==q?void 0:q.variations)&&(null===(y=null==q?void 0:q.variations)||void 0===y?void 0:y.length))return null===(m=null===(D=this._loggerManager)||void 0===D?void 0:D.info)||void 0===m||m.call(D,"DataManager.matchRulesByField()",p.EXPERIENCE_RULES_MATCHED),q;null===(L=null===(b=this._loggerManager)||void 0===b?void 0:b.debug)||void 0===L||L.call(b,"DataManager.matchRulesByField()",p.VARIATIONS_NOT_FOUND,this._mapper({visitorProperties:P,audiences:W}))}else null===(B=null===(U=this._loggerManager)||void 0===U?void 0:U.debug)||void 0===B||B.call(U,"DataManager.matchRulesByField()",p.AUDIENCE_NOT_MATCH,this._mapper({visitorProperties:P,audiences:W}));return null}_getBucketingByField(e,t,i="key",n){var a,r;const{visitorProperties:o,locationProperties:l,updateVisitorProperties:s,forceVariationId:u,enableTracking:d=!0,ignoreLocationProperties:c,environment:g=this._environment}=n;null===(r=null===(a=this._loggerManager)||void 0===a?void 0:a.trace)||void 0===r||r.call(a,"DataManager._getBucketingByField()",this._mapper({visitorId:e,identity:t,identityField:i,visitorProperties:o,locationProperties:l,forceVariationId:u,enableTracking:d,ignoreLocationProperties:c,environment:g}));const v=this.matchRulesByField(e,t,i,{visitorProperties:o,locationProperties:l,ignoreLocationProperties:c,environment:g});return v?Object.values(R).includes(v)?v:this._retrieveBucketing(e,o,s,v,u,d):null}_retrieveBucketing(e,t,i,n,a,r=!0){var o,s,u,d,c,g,v,h,_,f,T,O,M,N,S,A,R;if(!e||!n)return null;if(!(null==n?void 0:n.id))return null;let I,C,y=null,D=null;const m=this.getStoreKey(e);a&&(y=this.retrieveVariation(n.id,String(a)))&&(I=a,null===(s=null===(o=this._loggerManager)||void 0===o?void 0:o.info)||void 0===s||s.call(o,"DataManager._retrieveBucketing()",p.BUCKETED_VISITOR_FORCED.replace("#",`#${a}`)),null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.debug)||void 0===d||d.call(u,"DataManager._retrieveBucketing()",this._mapper({storeKey:m,visitorId:e,variationId:a})));const{bucketing:b,segments:L}=this.getData(e)||{},{[n.id.toString()]:U}=b||{};if(!U||I&&String(I)!==String(U)||!(y=this.retrieveVariation(n.id,String(U)))){const a=n.variations.filter((e=>!(null==e?void 0:e.status)||e.status===B)).filter((e=>(null==e?void 0:e.traffic_allocation)>0||isNaN(null==e?void 0:e.traffic_allocation))).reduce(((e,t)=>((null==t?void 0:t.id)&&(e[t.id]=(null==t?void 0:t.traffic_allocation)||100),e)),{}),o=this._bucketingManager.getBucketForVisitor(a,e,(null===(f=null===(_=this._config)||void 0===_?void 0:_.bucketing)||void 0===f?void 0:f.excludeExperienceIdHash)?null:{experienceId:n.id.toString()});if(I=I||(null==o?void 0:o.variationId),C=null==o?void 0:o.bucketingAllocation,!I)return null===(O=null===(T=this._loggerManager)||void 0===T?void 0:T.debug)||void 0===O||O.call(T,"DataManager._retrieveBucketing()",E,this._mapper({visitorId:e,experience:n,buckets:a,bucketing:o})),l.VARIAION_NOT_DECIDED;if(null===(N=null===(M=this._loggerManager)||void 0===M?void 0:M.info)||void 0===N||N.call(M,"DataManager._retrieveBucketing()",p.BUCKETED_VISITOR.replace("#",`#${I}`)),i?this.putData(e,Object.assign({bucketing:{[n.id.toString()]:I}},t?{segments:t}:{})):this.putData(e,{bucketing:{[n.id.toString()]:I}}),r){const i={experienceId:n.id.toString(),variationId:I.toString()},a={eventType:P,data:i},r=this._ruleManager.isUsingCustomInterface(t)?(null===(S=null==t?void 0:t.get)||void 0===S?void 0:S.call(t))||{}:L;this._apiManager.enqueue(e,a,r),null===(R=null===(A=this._loggerManager)||void 0===A?void 0:A.trace)||void 0===R||R.call(A,"DataManager._retrieveBucketing()",this._mapper({visitorEvent:a}))}y=this.retrieveVariation(n.id,String(I))}else I=U,null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.info)||void 0===g||g.call(c,"DataManager._retrieveBucketing()",p.BUCKETED_VISITOR_FOUND.replace("#",`#${I}`)),null===(h=null===(v=this._loggerManager)||void 0===v?void 0:v.debug)||void 0===h||h.call(v,"DataManager._retrieveBucketing()",this._mapper({storeKey:m,visitorId:e,variationId:I}));return y&&(D=Object.assign(Object.assign({experienceId:null==n?void 0:n.id,experienceName:null==n?void 0:n.name,experienceKey:null==n?void 0:n.key},{bucketingAllocation:C}),y)),D}retrieveVariation(e,t){return this.getSubItem("experiences",e,"variations",t,"id","id")}reset(){this._bucketedVisitors=new Map}putData(e,t={}){const n=this.getStoreKey(e),r=this.getData(e)||{};if(!a(r,t)){const e=i(r,t);if(this._bucketedVisitors.set(n,e),this._bucketedVisitors.size>this._localStoreLimit)for(const[e]of this._bucketedVisitors){this._bucketedVisitors.delete(e);break}if(this.dataStoreManager){const{segments:a={}}=r,o=function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var a=0;for(n=Object.getOwnPropertySymbols(e);a<n.length;a++)t.indexOf(n[a])<0&&Object.prototype.propertyIsEnumerable.call(e,n[a])&&(i[n[a]]=e[n[a]])}return i}(r,["segments"]),{segments:l={}}=this.filterReportSegments(a),{segments:s}=this.filterReportSegments((null==t?void 0:t.segments)||{});s?this._asyncStorage?this.dataStoreManager.enqueue(n,i(o,{segments:Object.assign(Object.assign({},l),s)})):this.dataStoreManager.set(n,i(o,{segments:Object.assign(Object.assign({},l),s)})):this._asyncStorage?this.dataStoreManager.enqueue(n,e):this.dataStoreManager.set(n,e)}}}getData(e){const t=this.getStoreKey(e),n=this._bucketedVisitors.get(t)||null;return this.dataStoreManager?i(n||{},this.dataStoreManager.get(t)||{}):n}getStoreKey(e){return`${this._accountId}-${this._projectId}-${e}`}selectLocations(t,i,n){var a,r,o,l,s,u,d,c,g,v,h,_,E,f,T,O,M,N,S,A;const{locationProperties:R,identityField:C="key",forceEvent:y}=n;null===(r=null===(a=this._loggerManager)||void 0===a?void 0:a.trace)||void 0===r||r.call(a,"DataManager.selectLocations()",this._mapper({items:i,locationProperties:R}));const{locations:D=[]}=this.getData(t)||{},m=[];let b;if(e(i))for(let e=0,n=i.length;e<n;e++){if(!(null===(o=null==i?void 0:i[e])||void 0===o?void 0:o.rules))continue;b=this._ruleManager.isRuleMatched(R,i[e].rules,`ConfigLocation #${i[e][C]}`);const n=null===(u=null===(s=null===(l=null==i?void 0:i[e])||void 0===l?void 0:l[C])||void 0===s?void 0:s.toString)||void 0===u?void 0:u.call(s);if(!0===b)null===(c=null===(d=this._loggerManager)||void 0===d?void 0:d.info)||void 0===c||c.call(d,"DataManager.selectLocations()",p.LOCATION_MATCH.replace("#",`#${n}`)),D.includes(n)&&!y||(this._eventManager.fire(I.LOCATION_ACTIVATED,{visitorId:t,location:{id:null===(g=null==i?void 0:i[e])||void 0===g?void 0:g.id,key:null===(v=null==i?void 0:i[e])||void 0===v?void 0:v.key,name:null===(h=null==i?void 0:i[e])||void 0===h?void 0:h.name}},null,!0),null===(E=null===(_=this._loggerManager)||void 0===_?void 0:_.info)||void 0===E||E.call(_,"DataManager.selectLocations()",p.LOCATION_ACTIVATED.replace("#",`#${n}`))),D.includes(n)||D.push(n),m.push(i[e]);else if(!1!==b)m.push(b);else if(!1===b&&D.includes(n)){this._eventManager.fire(I.LOCATION_DEACTIVATED,{visitorId:t,location:{id:null===(f=null==i?void 0:i[e])||void 0===f?void 0:f.id,key:null===(T=null==i?void 0:i[e])||void 0===T?void 0:T.key,name:null===(O=null==i?void 0:i[e])||void 0===O?void 0:O.name}},null,!0);const a=D.findIndex((e=>e===n));D.splice(a,1),null===(N=null===(M=this._loggerManager)||void 0===M?void 0:M.info)||void 0===N||N.call(M,"DataManager.selectLocations()",p.LOCATION_DEACTIVATED.replace("#",`#${n}`))}}return this.putData(t,{locations:D}),null===(A=null===(S=this._loggerManager)||void 0===S?void 0:S.debug)||void 0===A||A.call(S,"DataManager.selectLocations()",this._mapper({matchedRecords:m})),m}getBucketing(e,t,i){return this._getBucketingByField(e,t,"key",i)}getBucketingById(e,t,i){return this._getBucketingByField(e,t,"id",i)}convert(e,t,i,n,a,r){var o,l,u,d,c,g;const v="string"==typeof t?this.getEntity(t,"goals"):this.getEntityById(t,"goals");if(!(null==v?void 0:v.id))return void(null===(l=null===(o=this._loggerManager)||void 0===o?void 0:o.error)||void 0===l||l.call(o,"DataManager.convert()",p.GOAL_NOT_FOUND));if(i){if(!(null==v?void 0:v.rules))return;const e=this._ruleManager.isRuleMatched(i,v.rules,`ConfigGoal #${t}`);if(Object.values(R).includes(e))return e;if(!e)return void(null===(d=null===(u=this._loggerManager)||void 0===u?void 0:u.error)||void 0===d||d.call(u,"DataManager.convert()",p.GOAL_RULE_NOT_MATCH))}const h=null==r?void 0:r[s.FORCE_MULTIPLE_TRANSACTIONS],{bucketing:_,goals:{[t.toString()]:E}={}}=this.getData(e)||{};if(!E||(null===(g=null===(c=this._loggerManager)||void 0===c?void 0:c.debug)||void 0===g||g.call(c,"DataManager.convert()",p.GOAL_FOUND.replace("#",t.toString()),this._mapper({visitorId:e,goalId:t})),h))return this.putData(e,{goals:{[t.toString()]:!0}}),E||function(){var t,i;const n={goalId:v.id};_&&(n.bucketingData=_);const r={eventType:V,data:n};this._apiManager.enqueue(e,r,a),null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===i||i.call(t,"DataManager.convert()",this._mapper({event:r}))}.call(this),!n||E&&!h||function(){var t,i;const r={goalId:v.id,goalData:n};_&&(r.bucketingData=_);const o={eventType:V,data:r};this._apiManager.enqueue(e,o,a),null===(i=null===(t=this._loggerManager)||void 0===t?void 0:t.trace)||void 0===i||i.call(t,"DataManager.convert()",this._mapper({event:o}))}.call(this),!0}filterMatchedRecordsWithRule(t,i,n,a="id"){var r,o,l,s,u;null===(o=null===(r=this._loggerManager)||void 0===r?void 0:r.trace)||void 0===o||o.call(r,"DataManager.filterMatchedRecordsWithRule()",this._mapper({items:t,visitorProperties:i}));const d=[];let c;if(e(t))for(let e=0,r=t.length;e<r;e++)(null===(l=null==t?void 0:t[e])||void 0===l?void 0:l.rules)&&(c=this._ruleManager.isRuleMatched(i,t[e].rules,`${g=n,g.replace(/(?:^\w|[A-Z]|\b\w)/g,(function(e,t){return 0===t?e.toLowerCase():e.toUpperCase()})).replace(/\s+/g,"")} #${t[e][a]}`),!0===c?d.push(t[e]):!1!==c&&d.push(c));var g;return null===(u=null===(s=this._loggerManager)||void 0===s?void 0:s.debug)||void 0===u||u.call(s,"DataManager.filterMatchedRecordsWithRule()",this._mapper({matchedRecords:d})),d}filterMatchedCustomSegments(t,i){var n,a,r,o,l;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"DataManager.filterMatchedCustomSegments()",this._mapper({items:t,visitorId:i}));const{segments:{[m.CUSTOM_SEGMENTS]:s=[]}={}}=this.getData(i)||{},u=[];if(e(t))for(let e=0,i=t.length;e<i;e++)(null===(r=null==t?void 0:t[e])||void 0===r?void 0:r.id)&&s.includes(t[e].id)&&u.push(t[e]);return null===(l=null===(o=this._loggerManager)||void 0===o?void 0:o.debug)||void 0===l||l.call(o,"DataManager.filterMatchedCustomSegments()",this._mapper({matchedRecords:u})),u}filterReportSegments(e){const t=Object.values(m).map((e=>e)),i={},n={};for(const a in e)t.includes(a)?i[a]=e[a]:n[a]=e[a];return{properties:Object.keys(n).length?n:null,segments:Object.keys(i).length?i:null}}getEntitiesList(e){var i,n;let a=[];const r=v[e]||e;return-1!==this._dataEntities.indexOf(r)&&(a=t(this._data,r)||[]),null===(n=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===n||n.call(i,"DataManager.getEntitiesList()",this._mapper({entityType:r,list:a})),a}getEntitiesListObject(e,t="id"){return this.getEntitiesList(e).reduce(((e,i)=>(e[i[t]]=i,e)),{})}_getEntityByField(t,i,n="key"){var a,r,o;const l=v[i]||i;null===(r=null===(a=this._loggerManager)||void 0===a?void 0:a.trace)||void 0===r||r.call(a,"DataManager._getEntityByField()",this._mapper({identity:t,entityType:l,identityField:n}));const s=this.getEntitiesList(l);if(e(s))for(let e=0,i=s.length;e<i;e++)if(s[e]&&String(null===(o=s[e])||void 0===o?void 0:o[n])===String(t))return s[e];return null}getEntity(e,t){return this._getEntityByField(e,t,"key")}getEntities(e,t){return this.getItemsByKeys(e,t)}getEntityById(e,t){return this._getEntityByField(e,t,"id")}getEntitiesByIds(e,t){return this.getItemsByIds(e,t)}getItemsByKeys(t,i){var n;const a=this.getEntitiesList(i),r=[];if(e(a))for(let e=0,i=a.length;e<i;e++)-1!==t.indexOf(null===(n=a[e])||void 0===n?void 0:n.key)&&r.push(a[e]);return r}getItemsByIds(t,i){var n,a,r;null===(a=null===(n=this._loggerManager)||void 0===n?void 0:n.trace)||void 0===a||a.call(n,"DataManager.getItemsByIds()",this._mapper({ids:t,path:i}));const o=[];if(e(t)){const n=this.getEntitiesList(i);if(e(n))for(let e=0,i=n.length;e<i;e++)-1!==t.indexOf(null===(r=n[e])||void 0===r?void 0:r.id)&&o.push(n[e])}return o}getSubItem(e,t,i,n,a,r){const o=this._getEntityByField(t,e,a);for(const e of o[i])if(e[r]===n)return e;return null}isValidConfigData(e){var t;return n(e)&&(!!(null==e?void 0:e.account_id)&&!!(null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id)||Boolean(e.error))}},exports.DataStoreManager=x;
//# sourceMappingURL=index.min.js.map
