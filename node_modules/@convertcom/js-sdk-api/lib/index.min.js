/*!
 * Convert JS SDK
 * Version 1.0.0
 * Copyright(c) 2020-2022 Convert Insights, Inc
 * License Apache-2.0
 */
"use strict";function e(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{u(i.next(e))}catch(e){o(e)}}function s(e){try{u(i.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((i=i.apply(e,t||[])).next())}))}var t,n;"function"==typeof SuppressedError&&SuppressedError,function(e){e.VARIAION_NOT_DECIDED="convert.com_variation_not_decided"}(t||(t={})),function(e){e.FORCE_MULTIPLE_TRANSACTIONS="forceMultipleTransactions"}(n||(n={}));const i="Unable to perform network request",r="Unsupported response type",o="The user agent successfully queued the data for transfer",a="Releasing event queue...";var s,u,d,l,c,h,v,p,g,f,E,_,T,m,A;function R(e,t,n,i=!1){try{if("object"==typeof e){const n=t.split(".").reduce(((e,t)=>e[t]),e);if(n||i&&(!1===n||0===n))return n}}catch(e){}return null}function C(e){return"object"==typeof e&&null!==e&&Object.keys(e).length>0}!function(e){e.OFF="OFF",e.EU_ONLY="EU ONLY",e.EEA_ONLY="EEA ONLY",e.WORLDWIDE="Worldwide"}(s||(s={})),function(e){e.AUDIENCE="audience",e.LOCATION="location",e.SEGMENT="segment",e.FEATURE="feature",e.GOAL="goal",e.EXPERIENCE="experience",e.VARIATION="variation"}(u||(u={})),function(e){e.ENABLED="enabled",e.DISABLED="disabled"}(d||(d={})),function(e){e.AMOUNT="amount",e.PRODUCTS_COUNT="productsCount",e.TRANSACTION_ID="transactionId"}(l||(l={})),function(e){e[e.TRACE=0]="TRACE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.SILENT=5]="SILENT"}(c||(c={})),function(e){e.LOG="log",e.TRACE="trace",e.DEBUG="debug",e.INFO="info",e.WARN="warn",e.ERROR="error"}(h||(h={})),function(e){e.WEB="web",e.FULLSTACK="fullstack"}(v||(v={})),function(e){e.NO_DATA_FOUND="convert.com_no_data_found",e.NEED_MORE_DATA="convert.com_need_more_data"}(p||(p={})),function(e){e.READY="ready",e.CONFIG_UPDATED="config.updated",e.API_QUEUE_RELEASED="api.queue.released",e.BUCKETING="bucketing",e.CONVERSION="conversion",e.SEGMENTS="segments",e.LOCATION_ACTIVATED="location.activated",e.LOCATION_DEACTIVATED="location.deactivated",e.AUDIENCES="audiences",e.DATA_STORE_QUEUE_RELEASED="datastore.queue.released"}(g||(g={})),function(e){e.RICH_STRUCTURE="richStructure",e.CUSTOM_CODE="customCode",e.DEFAULT_CODE="defaultCode",e.DEFAULT_CODE_MULTIPAGE="defaultCodeMultipage",e.DEFAULT_REDIRECT="defaultRedirect",e.FULLSTACK_FEATURE="fullStackFeature"}(f||(f={})),function(e){e.IE="IE",e.CH="CH",e.FF="FF",e.OP="OP",e.SF="SF",e.EDG="EDG",e.MO="MO",e.NS="NS",e.OTH="OTH"}(E||(E={})),function(e){e.ALLPH="ALLPH",e.IPH="IPH",e.OTHPH="OTHPH",e.ALLTAB="ALLTAB",e.IPAD="IPAD",e.OTHTAB="OTHTAB",e.DESK="DESK",e.OTHDEV="OTHDEV"}(_||(_={})),function(e){e.COUNTRY="country",e.BROWSER="browser",e.DEVICES="devices",e.SOURCE="source",e.CAMPAIGN="campaign",e.VISITOR_TYPE="visitorType",e.CUSTOM_SEGMENTS="customSegments"}(T||(T={})),function(e){e.CAMPAIGN="campaign",e.SEARCH="search",e.REFERRAL="referral",e.DIRECT="direct"}(m||(m={})),function(e){e.NEW="new",e.RETURNING="returning"}(A||(A={}));var N,O,S;function I(e){if("number"==typeof e)return!0;const t=parseFloat(String(e));return Number.isFinite(t)&&!isNaN(t)}function y(e){if("number"==typeof e)return e;const t=String(e).split(",");return parseFloat("0"==t[0]?String(e).replace(/,/g,"."):String(e).replace(/,/g,""))}N={exports:{}},function(){const e=e=>(new TextEncoder).encode(e);function t(t,n){let i,r,o,a,s,u,d,l;for("string"==typeof t&&(t=e(t)),i=3&t.length,r=t.length-i,o=n,s=3432918353,u=461845907,l=0;l<r;)d=255&t[l]|(255&t[++l])<<8|(255&t[++l])<<16|(255&t[++l])<<24,++l,d=(65535&d)*s+(((d>>>16)*s&65535)<<16)&4294967295,d=d<<15|d>>>17,d=(65535&d)*u+(((d>>>16)*u&65535)<<16)&4294967295,o^=d,o=o<<13|o>>>19,a=5*(65535&o)+((5*(o>>>16)&65535)<<16)&4294967295,o=27492+(65535&a)+((58964+(a>>>16)&65535)<<16);switch(d=0,i){case 3:d^=(255&t[l+2])<<16;case 2:d^=(255&t[l+1])<<8;case 1:d^=255&t[l],d=(65535&d)*s+(((d>>>16)*s&65535)<<16)&4294967295,d=d<<15|d>>>17,d=(65535&d)*u+(((d>>>16)*u&65535)<<16)&4294967295,o^=d}return o^=t.length,o^=o>>>16,o=2246822507*(65535&o)+((2246822507*(o>>>16)&65535)<<16)&4294967295,o^=o>>>13,o=3266489909*(65535&o)+((3266489909*(o>>>16)&65535)<<16)&4294967295,o^=o>>>16,o>>>0}const n=t;n.v2=function(t,n){"string"==typeof t&&(t=e(t));let i,r=t.length,o=n^r,a=0;for(;r>=4;)i=255&t[a]|(255&t[++a])<<8|(255&t[++a])<<16|(255&t[++a])<<24,i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16),i^=i>>>24,i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16),o=1540483477*(65535&o)+((1540483477*(o>>>16)&65535)<<16)^i,r-=4,++a;switch(r){case 3:o^=(255&t[a+2])<<16;case 2:o^=(255&t[a+1])<<8;case 1:o^=255&t[a],o=1540483477*(65535&o)+((1540483477*(o>>>16)&65535)<<16)}return o^=o>>>13,o=1540483477*(65535&o)+((1540483477*(o>>>16)&65535)<<16),o^=o>>>15,o>>>0},n.v3=t,N.exports=n}();class L{static equals(e,t,n){return Array.isArray(e)?this._returnNegationCheck(-1!==e.indexOf(t),n):C(e)?this._returnNegationCheck(-1!==Object.keys(e).indexOf(String(t)),n):(e=String(e),t=String(t),e=e.valueOf().toLowerCase(),t=t.valueOf().toLowerCase(),this._returnNegationCheck(e===t,n))}static less(e,t,n){return typeof(e=I(e)?y(e):e)==typeof(t=I(t)?y(t):t)&&this._returnNegationCheck(e<t,n)}static lessEqual(e,t,n){return typeof(e=I(e)?y(e):e)==typeof(t=I(t)?y(t):t)&&this._returnNegationCheck(e<=t,n)}static contains(e,t,n){return e=String(e),t=String(t),e=e.valueOf().toLowerCase(),0===(t=t.valueOf().toLowerCase()).replace(/^([\s]*)|([\s]*)$/g,"").length?this._returnNegationCheck(!0,n):this._returnNegationCheck(-1!==e.indexOf(t),n)}static isIn(e,t,n=!1,i="|"){const r=String(e).split(i).map((e=>String(e)));"string"==typeof t&&(t=t.split(i)),Array.isArray(t)||(t=[]),t=t.map((e=>String(e).valueOf().toLowerCase()));for(let e=0;e<r.length;e++)if(-1!==t.indexOf(r[e]))return this._returnNegationCheck(!0,n);return this._returnNegationCheck(!1,n)}static startsWith(e,t,n){return e=String(e).valueOf().toLowerCase(),t=String(t).valueOf().toLowerCase(),this._returnNegationCheck(0===e.indexOf(t),n)}static endsWith(e,t,n){return e=String(e).valueOf().toLowerCase(),t=String(t).valueOf().toLowerCase(),this._returnNegationCheck(-1!==e.indexOf(t,e.length-t.length),n)}static regexMatches(e,t,n){e=String(e).valueOf().toLowerCase(),t=String(t).valueOf();const i=new RegExp(t,"i");return this._returnNegationCheck(i.test(e),n)}static _returnNegationCheck(e,t=!1){return t?!e:e}}O=L,L.equalsNumber=O.equals,L.matches=O.equals,function(e){e[e.Continue=100]="Continue",e[e.SwitchingProtocols=101]="SwitchingProtocols",e[e.Processing=102]="Processing",e[e.EarlyHints=103]="EarlyHints",e[e.Ok=200]="Ok",e[e.Created=201]="Created",e[e.Accepted=202]="Accepted",e[e.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",e[e.NoContent=204]="NoContent",e[e.ResetContent=205]="ResetContent",e[e.PartialContent=206]="PartialContent",e[e.MultiStatus=207]="MultiStatus",e[e.AlreadyReported=208]="AlreadyReported",e[e.ImUsed=226]="ImUsed",e[e.MultipleChoices=300]="MultipleChoices",e[e.MovedPermanently=301]="MovedPermanently",e[e.Found=302]="Found",e[e.SeeOther=303]="SeeOther",e[e.NotModified=304]="NotModified",e[e.UseProxy=305]="UseProxy",e[e.Unused=306]="Unused",e[e.TemporaryRedirect=307]="TemporaryRedirect",e[e.PermanentRedirect=308]="PermanentRedirect",e[e.BadRequest=400]="BadRequest",e[e.Unauthorized=401]="Unauthorized",e[e.PaymentRequired=402]="PaymentRequired",e[e.Forbidden=403]="Forbidden",e[e.NotFound=404]="NotFound",e[e.MethodNotAllowed=405]="MethodNotAllowed",e[e.NotAcceptable=406]="NotAcceptable",e[e.ProxyAuthenticationRequired=407]="ProxyAuthenticationRequired",e[e.RequestTimeout=408]="RequestTimeout",e[e.Conflict=409]="Conflict",e[e.Gone=410]="Gone",e[e.LengthRequired=411]="LengthRequired",e[e.PreconditionFailed=412]="PreconditionFailed",e[e.PayloadTooLarge=413]="PayloadTooLarge",e[e.UriTooLong=414]="UriTooLong",e[e.UnsupportedMediaType=415]="UnsupportedMediaType",e[e.RangeNotSatisfiable=416]="RangeNotSatisfiable",e[e.ExpectationFailed=417]="ExpectationFailed",e[e.ImATeapot=418]="ImATeapot",e[e.MisdirectedRequest=421]="MisdirectedRequest",e[e.UnprocessableEntity=422]="UnprocessableEntity",e[e.Locked=423]="Locked",e[e.FailedDependency=424]="FailedDependency",e[e.TooEarly=425]="TooEarly",e[e.UpgradeRequired=426]="UpgradeRequired",e[e.PreconditionRequired=428]="PreconditionRequired",e[e.TooManyRequests=429]="TooManyRequests",e[e.RequestHeaderFieldsTooLarge=431]="RequestHeaderFieldsTooLarge",e[e.UnavailableForLegalReasons=451]="UnavailableForLegalReasons",e[e.InternalServerError=500]="InternalServerError",e[e.NotImplemented=501]="NotImplemented",e[e.BadGateway=502]="BadGateway",e[e.ServiceUnavailable=503]="ServiceUnavailable",e[e.GatewayTimeout=504]="GatewayTimeout",e[e.HttpVersionNotSupported=505]="HttpVersionNotSupported",e[e.VariantAlsoNegotiates=506]="VariantAlsoNegotiates",e[e.InsufficientStorage=507]="InsufficientStorage",e[e.LoopDetected=508]="LoopDetected",e[e.NotExtended=510]="NotExtended",e[e.NetworkAuthenticationRequired=511]="NetworkAuthenticationRequired"}(S||(S={}));const U=e=>!["GET","HEAD","DELETE","TRACE","OPTIONS"].includes(e.toUpperCase()),k=(e,t,n)=>{let i="";return C(e)&&!U(t)&&(i="old-nodejs"!==n.runtime?Object.keys(e).map((t=>`${encodeURIComponent(t)}=${encodeURIComponent(e[t])}`)).join("&"):n.queryString.stringify(e)),i?`?${i}`:i},b={request(t){var n;const a=(null===(n=null==t?void 0:t.method)||void 0===n?void 0:n.toUpperCase())||"GET",s=(null==t?void 0:t.path)?t.path.startsWith("/")?t.path:`/${t.path}`:"",u=t.baseURL.endsWith("/")?t.baseURL.slice(0,-1):t.baseURL,d=(null==t?void 0:t.responseType)||"json",l=(()=>{if("undefined"!=typeof window)return{runtime:"browser"};if("function"==typeof fetch)return{runtime:"server-with-fetch"};try{const e=require("url"),t=require("http");return{runtime:"old-nodejs",url:e,http:t,https:require("https"),queryString:require("querystring")}}catch(e){}return{runtime:"unknown"}})();return new Promise(((n,c)=>{if("browser"===l.runtime||"server-with-fetch"===l.runtime){const i={method:a,keepalive:!0};(null==t?void 0:t.headers)&&(i.headers=t.headers),(null==t?void 0:t.data)&&U(a)&&(i.body=JSON.stringify(t.data));const h=`${u}${s}${k(null==t?void 0:t.data,a,l)}`;"post"===a.toLowerCase()&&"undefined"!=typeof navigator&&(null===navigator||void 0===navigator?void 0:navigator.sendBeacon)?navigator.sendBeacon(h,i.body)?n({data:!0,status:S.Ok,statusText:o}):c({message:r}):fetch(h,i).then((t=>e(this,void 0,void 0,(function*(){if(t.status===S.Ok){const e={status:t.status,statusText:t.statusText,headers:t.headers,data:null};switch(d){case"json":e.data=yield t.json();break;case"arraybuffer":e.data=yield t.arrayBuffer();break;case"text":e.data=t;break;default:return void c({message:r})}n(e)}else c({message:t.statusText,status:t.status})})))).catch((e=>{c({message:null==e?void 0:e.message,status:null==e?void 0:e.status,statusText:null==e?void 0:e.statusText})}))}else if("old-nodejs"===l.runtime){const e=l.url.parse(u);e.port||(e.port="https:"===e.protocol?"443":"80");const i=e.path.endsWith("/")?e.path.slice(0,-1):e.path,o="https:"===e.protocol?l.https:l.http,h=[],v={hostname:e.hostname,path:`${i}${s}${k(null==t?void 0:t.data,a,l)}`,port:e.port,method:a},p=(null==t?void 0:t.data)&&U(a)?JSON.stringify(t.data):null;(null==t?void 0:t.headers)&&(v.headers=t.headers),p&&(v.headers||(v.headers={}),v.headers["Content-Length"]=Buffer.byteLength(p));const g=o.request(v,(e=>{e.on("data",(e=>h.push(e))),e.on("end",(()=>{if(e.statusCode===S.Ok){const t=Buffer.concat(h),i=t.toString(),o={status:e.statusCode,statusText:e.statusMessage,headers:e.headers,data:null};switch(d){case"json":o.data=i?JSON.parse(i):"";break;case"arraybuffer":o.data=null==t?void 0:t.buffer;break;case"text":o.data=e;break;default:return void c({message:r})}n(o)}else c({message:e.statusMessage,status:e.statusCode})}))}));g.on("error",(e=>{const t=e;c({message:null==t?void 0:t.message,status:null==t?void 0:t.code,statusText:null==t?void 0:t.statusText})})),p&&g.write(p),g.end()}else c({message:i})}))}},D={"Content-Type":"application/json"},q="https://cdn-4.convertexperiments.com/api/v1/",w="https://[project_id].metrics.convertexperiments.com/v1/";exports.ApiManager=class{constructor(e,{eventManager:t,loggerManager:n}={}){var i,r,o,a,s,u,d,l,c,h,v,p;this._configEndpoint=q,this._trackEndpoint=w,this._defaultHeaders=D,this.batchSize=10,this.releaseInterval=1e4,this._loggerManager=n,this._eventManager=t,this._configEndpoint=(null===(r=null===(i=null==e?void 0:e.api)||void 0===i?void 0:i.endpoint)||void 0===r?void 0:r.config)||q,this._trackEndpoint=(null===(a=null===(o=null==e?void 0:e.api)||void 0===o?void 0:o.endpoint)||void 0===a?void 0:a.track)||w,this._data=R(e,"data"),this._enrichData=!R(e,"dataStore"),this._environment=null==e?void 0:e.environment,this._mapper=(null==e?void 0:e.mapper)||(e=>e),this.batchSize=Number(null===(s=null==e?void 0:e.events)||void 0===s?void 0:s.batch_size)||10,this.releaseInterval=Number(null===(u=null==e?void 0:e.events)||void 0===u?void 0:u.release_interval)||1e4,this._accountId=null===(d=this._data)||void 0===d?void 0:d.account_id,this._projectId=null===(c=null===(l=this._data)||void 0===l?void 0:l.project)||void 0===c?void 0:c.id,this._sdkKey=(null==e?void 0:e.sdkKey)||`${this._accountId}/${this._projectId}`,(null==e?void 0:e.sdkKeySecret)&&(this._defaultHeaders.Authorization=`Bearer ${null==e?void 0:e.sdkKeySecret}`),this._trackingEvent={enrichData:this._enrichData,accountId:this._accountId,projectId:this._projectId,visitors:[]},this._trackingEnabled=null===(h=null==e?void 0:e.network)||void 0===h?void 0:h.tracking,this._trackingSource=(null===(v=null==e?void 0:e.network)||void 0===v?void 0:v.source)||"js-sdk",this._cacheLevel=null===(p=null==e?void 0:e.network)||void 0===p?void 0:p.cacheLevel,this._requestsQueue={length:0,items:[],push(e,t,n){const i=this.items.findIndex((t=>t.visitorId===e));if(-1!==i)this.items[i].events.push(t);else{const i={visitorId:e,events:[t]};n&&(i.segments=n),this.items.push(i)}this.length++},reset(){this.items=[],this.length=0}}}request(t,n){return e(this,arguments,void 0,(function*(e,t,n={},i={}){const r=Object.assign(Object.assign({},this._defaultHeaders),i),o={method:e,path:t.route,baseURL:t.base,headers:r,data:n,responseType:"json"};return b.request(o)}))}enqueue(e,t,n){var i,r;null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"ApiManager.enqueue()",this._mapper({eventRequest:t})),this._requestsQueue.push(e,t,n),this._trackingEnabled&&(1===this._requestsQueue.length?this.startQueue():this._requestsQueue.length===this.batchSize&&this.releaseQueue("size").then())}releaseQueue(e){var t,n,i,r;if(!this._requestsQueue.length)return;null===(n=null===(t=this._loggerManager)||void 0===t?void 0:t.info)||void 0===n||n.call(t,"ApiManager.releaseQueue()",a),null===(r=null===(i=this._loggerManager)||void 0===i?void 0:i.trace)||void 0===r||r.call(i,"ApiManager.releaseQueue()",{reason:e||""}),this.stopQueue();const o=this._trackingEvent;return o.visitors=this._requestsQueue.items.slice(),o.source=this._trackingSource,this.request("post",{base:this._trackEndpoint.replace("[project_id]",this._projectId.toString()),route:`/track/${this._sdkKey}`},this._mapper(o)).then((t=>{var n,i;this._requestsQueue.reset(),null===(i=null===(n=this._eventManager)||void 0===n?void 0:n.fire)||void 0===i||i.call(n,g.API_QUEUE_RELEASED,{reason:e,result:t,visitors:o.visitors})})).catch((t=>{var n,i,r,o;null===(i=null===(n=this._loggerManager)||void 0===n?void 0:n.error)||void 0===i||i.call(n,"ApiManager.releaseQueue()",{error:t.message}),this.startQueue(),null===(o=null===(r=this._eventManager)||void 0===r?void 0:r.fire)||void 0===o||o.call(r,g.API_QUEUE_RELEASED,{reason:e},t)}))}stopQueue(){clearTimeout(this._requestsQueueTimerID)}startQueue(){this._requestsQueueTimerID=setTimeout((()=>{this.releaseQueue("timeout")}),this.releaseInterval)}enableTracking(){this._trackingEnabled=!0,this.releaseQueue("trackingEnabled")}disableTracking(){this._trackingEnabled=!1}setData(e){var t;this._data=e,this._accountId=null==e?void 0:e.account_id,this._projectId=null===(t=null==e?void 0:e.project)||void 0===t?void 0:t.id,this._trackingEvent.accountId=this._accountId,this._trackingEvent.projectId=this._projectId}getConfig(){var e,t;null===(t=null===(e=this._loggerManager)||void 0===e?void 0:e.trace)||void 0===t||t.call(e,"ApiManager.getConfig()");let n="low"===this._cacheLevel||this._environment?"?":"";return this._environment&&(n+=`environment=${this._environment}`),"low"===this._cacheLevel&&(n+="_conv_low_cache=1"),new Promise(((e,t)=>{this.request("get",{base:this._configEndpoint,route:`/config/${this._sdkKey}${n}`}).then((({data:t})=>e(t))).catch(t)}))}};
//# sourceMappingURL=index.min.js.map
